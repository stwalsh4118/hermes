# [14-4] Implement remaining Manager interface methods

[Back to task list](./tasks.md)

## Description

Implement the remaining Manager interface methods: `SetDiscontinuityNext()`, `GetCurrentSegments()`, `GetMediaSequence()`, `GetSegmentCount()`, `GetLastSuccessfulWrite()`, `GetWindowSize()`, `GetMaxDuration()`, `HealthCheck()`, and `Close()`. These methods provide observability and control over the playlist manager state.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- `SetDiscontinuityNext()`: Set flag to mark next segment with discontinuity tag
- `GetCurrentSegments()`: Return list of segment URIs currently in playlist
- `GetMediaSequence()`: Return current media sequence number
- `GetSegmentCount()`: Return current number of segments in playlist
- `GetLastSuccessfulWrite()`: Return timestamp of last successful write (or nil)
- `GetWindowSize()`: Return configured window size
- `GetMaxDuration()`: Return maximum observed segment duration
- `HealthCheck(staleThreshold)`: Check if playlist is healthy based on last write time
- `Close()`: Perform final write and cleanup

### Technical Requirements
- All methods must be thread-safe (use appropriate locks: RLock for reads, Lock for writes)
- `SetDiscontinuityNext()`: Simple flag set, thread-safe
- `GetCurrentSegments()`: Extract URIs from segments slice, return copy to avoid race conditions
- `GetMediaSequence()`: Return current mediaSequence value
- `GetSegmentCount()`: Return `len(segments)`
- `GetLastSuccessfulWrite()`: Return pointer to timestamp (may be nil)
- `GetWindowSize()`: Return windowSize value
- `GetMaxDuration()`: Return maxDuration value
- `HealthCheck()`: Compare lastSuccessfulWrite to staleThreshold, return HealthStatus struct
- `Close()`: Call Write() one final time, log close operation

### HealthCheck Logic
- If lastSuccessfulWrite is nil, playlist is unhealthy (no writes yet)
- If time since last write > staleThreshold, playlist is unhealthy
- Otherwise, playlist is healthy
- Return HealthStatus with all relevant information

## Implementation Plan

1) Implement `SetDiscontinuityNext()`:
   - Acquire write lock
   - Set discontinuityNext flag to true
   - Release lock
   - Log debug message

2) Implement `GetCurrentSegments()`:
   - Acquire read lock
   - Create slice with capacity = len(segments)
   - Iterate segments, extract URI field
   - Return copy of URIs slice
   - Release lock

3) Implement `GetMediaSequence()`:
   - Acquire read lock
   - Return mediaSequence value
   - Release lock

4) Implement `GetSegmentCount()`:
   - Acquire read lock
   - Return len(segments)
   - Release lock

5) Implement `GetLastSuccessfulWrite()`:
   - Acquire read lock
   - Return lastSuccessfulWrite pointer (may be nil)
   - Release lock

6) Implement `GetWindowSize()`:
   - Acquire read lock
   - Return windowSize value
   - Release lock

7) Implement `GetMaxDuration()`:
   - Acquire read lock
   - Return maxDuration value
   - Release lock

8) Implement `HealthCheck(staleThreshold)`:
   - Acquire read lock
   - Create HealthStatus struct
   - Set LastWriteTime, WindowSize, MaxDuration, StaleThreshold
   - If lastSuccessfulWrite is nil, set Healthy=false, TimeSinceLastWrite=0
   - Otherwise, calculate TimeSinceLastWrite, set Healthy based on threshold
   - Return HealthStatus
   - Release lock

9) Implement `Close()`:
   - Call Write() to perform final write
   - Log close operation
   - Return error if Write() fails

## Test Plan

### Objective
Verify all interface methods work correctly and are thread-safe.

### Test Scenarios
- SetDiscontinuityNext sets flag correctly
- GetCurrentSegments returns correct URIs
- GetMediaSequence returns correct value
- GetSegmentCount returns correct count
- GetLastSuccessfulWrite returns nil before first write, timestamp after write
- GetWindowSize returns configured value
- GetMaxDuration returns correct max duration
- HealthCheck returns healthy when recent write occurred
- HealthCheck returns unhealthy when no write or stale write
- Close performs final write
- All methods are thread-safe under concurrent access
- GetCurrentSegments returns copy (modifications don't affect internal state)

### Success Criteria
- All methods return correct values
- Thread-safe under concurrent access
- HealthCheck logic is correct
- Close performs final write
- No race conditions detected

## Verification

### Acceptance Criteria
- [ ] SetDiscontinuityNext sets flag correctly
- [ ] GetCurrentSegments returns correct segment URIs
- [ ] GetMediaSequence returns current media sequence
- [ ] GetSegmentCount returns current segment count
- [ ] GetLastSuccessfulWrite returns correct timestamp or nil
- [ ] GetWindowSize returns configured window size
- [ ] GetMaxDuration returns maximum observed duration
- [ ] HealthCheck correctly determines health status
- [ ] Close performs final write
- [ ] All methods are thread-safe
- [ ] GetCurrentSegments returns copy (safe for caller modification)

## Files Modified

### Files to Modify
- `api/internal/streaming/playlist/manager.go` â€” Implement remaining Manager interface methods

