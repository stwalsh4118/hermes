# [14-7] Update StreamManager to use new playlistManager

[Back to task list](./tasks.md)

## Description

Update the StreamManager to use the new custom playlistManager implementation instead of the library-based one. Ensure no breaking changes to the StreamManager API and verify all existing functionality continues to work correctly.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-14 01:XX:XX | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-01-14 01:XX:XX | Status Change | InProgress | Done | Implementation complete: file deletion added, ProgramDateTime fixed, live streaming enabled | AI_Agent |

## Requirements

### Functional Requirements
- Replace library-based playlist manager with custom implementation
- Ensure all existing StreamManager functionality works unchanged
- Maintain compatibility with existing API
- No changes required to callers of StreamManager

### Technical Requirements
- Update `ensurePlaylistManager()` in [manager.go](api/internal/streaming/manager.go) to use new implementation
- Verify `playlist.NewManager()` call works with new implementation
- Ensure segment directory path is passed correctly (for file cleanup)
- Verify all playlist manager methods are called correctly
- Remove any workarounds that were needed for library bugs
- Update any code that relied on library-specific behavior

### Compatibility Requirements
- Manager interface must remain the same (already defined in task 14-1)
- All method signatures unchanged
- Behavior should match or improve upon library version
- No changes to StreamManager public API

## Implementation Plan

1) Review StreamManager usage of playlist manager in [manager.go](api/internal/streaming/manager.go)
2) Identify all places where playlist manager is created or used:
   - `ensurePlaylistManager()` function
   - `getPlaylistManager()` function
   - Calls to `AddSegment()`, `Write()`, `SetDiscontinuityNext()`, etc.
3) Verify new Manager interface matches usage patterns
4) Update `ensurePlaylistManager()` to use new implementation:
   - Verify `playlist.NewManager()` signature matches
   - Ensure segment directory is available for file cleanup
   - Verify windowSize and segmentDuration parameters
5) Test that playlist manager creation works correctly
6) Verify all method calls work with new implementation
7) Remove any library-specific workarounds or hacks
8) Run existing tests to verify compatibility
9) Check for any code that relied on library internals

## Test Plan

### Objective
Verify StreamManager works correctly with new playlist manager implementation.

### Test Scenarios
- StreamManager creates playlist manager correctly
- AddSegment calls work correctly
- Write calls work correctly
- SetDiscontinuityNext calls work correctly
- All other interface methods work correctly
- Existing streaming functionality works unchanged
- No regressions in stream generation
- No regressions in segment management

### Success Criteria
- StreamManager creates and uses playlist manager correctly
- All existing functionality works unchanged
- No breaking changes to StreamManager API
- Existing tests pass without modification
- No regressions introduced

## Verification

### Acceptance Criteria
- [x] StreamManager uses new playlist manager implementation
- [x] ensurePlaylistManager() creates new manager correctly
- [x] All playlist manager method calls work correctly
- [x] Existing streaming functionality works unchanged
- [x] No breaking changes to StreamManager API
- [x] Existing tests pass without modification
- [x] No regressions in stream generation
- [x] Library-specific workarounds removed
- [x] File deletion for pruned segments implemented
- [x] ProgramDateTime calculation fixed to use timeline
- [x] Live streaming mode enabled (no ENDLIST tag)

## Files Modified

### Files to Modify
- `api/internal/streaming/manager.go` — Update ensurePlaylistManager() and related code to use new implementation

### Files to Review
- `api/internal/streaming/playlist/manager.go` — Verify interface compatibility
- Existing tests that use StreamManager

