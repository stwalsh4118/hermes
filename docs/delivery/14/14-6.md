# [14-6] Add integration test with real HLS playback verification

[Back to task list](./tasks.md)

## Description

Add an integration test that generates a real HLS playlist and verifies it can be played by HLS.js or similar HLS player. This test validates that the custom playlist implementation produces valid, playable HLS playlists that comply with the HLS specification (RFC 8216).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Generate a real HLS playlist with multiple segments
- Create mock segment files (or use existing test segments)
- Verify playlist can be parsed by HLS.js or similar parser
- Verify segment URIs are correct and accessible
- Verify media sequence progression is correct
- Verify playlist format compliance with RFC 8216
- Test both live mode (sliding window) and VOD mode (ENDLIST)

### Technical Requirements
- Use test HTTP server to serve playlist and segments
- Use HLS.js library (JavaScript) or similar parser to validate playlist
- Or use Go-based HLS parser if available
- Create test segments (can be empty files or minimal TS files)
- Serve playlist and segments via HTTP (HLS requires HTTP)
- Verify playlist structure matches expected format
- Verify all required tags are present
- Verify segment URIs resolve correctly

### Integration Test Approach
Option 1: Use HLS.js in headless browser (Playwright/Puppeteer)
- Generate playlist and segments
- Serve via HTTP server
- Load in headless browser with HLS.js
- Verify playback starts without errors

Option 2: Use Go-based HLS parser/validator
- Parse generated playlist
- Validate structure and tags
- Verify segment URIs exist
- Verify format compliance

Option 3: Manual verification with HLS.js test page
- Generate playlist and segments
- Create simple HTML page with HLS.js
- Manually verify playback (documented process)

## Implementation Plan

1) Determine integration test approach (HLS.js in headless browser vs Go parser vs manual)
2) Create test helper to generate mock segment files (empty or minimal TS files)
3) Create test HTTP server to serve playlist and segments
4) Generate playlist with multiple segments using playlist manager
5) Write playlist to file system
6) Start HTTP server serving playlist and segments
7) Load playlist in HLS.js (or parse with Go parser)
8) Verify playlist is valid and playable:
   - All segments accessible
   - Media sequence correct
   - Format compliant
   - No parsing errors
9) Test both live mode (sliding window) and VOD mode (ENDLIST)
10) Clean up test files and server

## Test Plan

### Objective
Verify that generated playlists are valid HLS format and can be played by standard HLS players.

### Test Scenarios
- Generate playlist with multiple segments
- Verify playlist can be loaded by HLS.js
- Verify all segment URIs are accessible
- Verify media sequence progression
- Verify playlist format compliance
- Test live mode playlist (no ENDLIST)
- Test VOD mode playlist (with ENDLIST)
- Verify ProgramDateTime tags work correctly
- Verify Discontinuity tags work correctly

### Success Criteria
- Playlist loads without errors in HLS.js
- All segment URIs resolve correctly
- Media sequence progresses correctly
- Playlist format is RFC 8216 compliant
- Both live and VOD modes work correctly

## Verification

### Acceptance Criteria
- [ ] Integration test generates real HLS playlist
- [ ] Playlist can be loaded by HLS.js without errors
- [ ] All segment URIs are accessible
- [ ] Media sequence progression is correct
- [ ] Playlist format is RFC 8216 compliant
- [ ] Live mode playlist works (no ENDLIST)
- [ ] VOD mode playlist works (with ENDLIST)
- [ ] ProgramDateTime tags work correctly
- [ ] Discontinuity tags work correctly

## Files Modified

### Files to Create
- `api/test/integration/playlist_hls_test.go` â€” Integration test for HLS playback verification

### Files to Modify
- May need to add test helper functions or mock segment generators

