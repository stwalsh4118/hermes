# [14-2] Implement AddSegment() with sliding window logic and file cleanup

[Back to task list](./tasks.md)

## Description

Implement the `AddSegment()` method with manual sliding window logic that prunes old segments when the window size is exceeded. This replaces the buggy library-based implementation with a simple, predictable approach we fully control. The method should also return information about pruned segments so they can be deleted from disk.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Add new segment to the segments slice
- When `len(segments) >= windowSize` and `windowSize > 0`, prune oldest segment from front
- Increment `mediaSequence` by 1 for each segment pruned
- Track `totalSegments` (increment for each segment added)
- Update `maxDuration` if new segment duration exceeds current max
- Return list of segment URIs that were pruned (for file deletion)
- Handle discontinuity flag: if `discontinuityNext` is true, mark segment with discontinuity and clear flag
- Support VOD/EVENT mode: when `windowSize == 0`, never prune segments

### Technical Requirements
- Validate input: segment URI cannot be empty, duration must be > 0
- Thread-safe: use write lock (`mu.Lock()`) for all modifications
- Manual sliding window: `segments = segments[1:]` when pruning
- Calculate target duration: `ceil(maxDuration)` (handled in Write method)
- Return errors instead of panicking for invalid inputs
- Log segment addition with observability metrics (URI, duration, sequence numbers, window size)

### Error Handling
- Return error if segment URI is empty
- Return error if segment duration <= 0
- Log warnings (non-fatal) for file deletion failures (handled by caller)

## Implementation Plan

1) Implement input validation (empty URI, invalid duration)
2) Acquire write lock for thread-safety
3) Update maxDuration if new segment duration exceeds current max
4) Increment totalSegments counter
5) Handle discontinuity flag: if set, mark segment and clear flag
6) Implement sliding window logic:
   - If windowSize > 0 and len(segments) >= windowSize, prune from front
   - Collect pruned segment URIs for return
   - Increment mediaSequence by number of segments pruned
   - Use slice operation: `segments = segments[1:]`
7) Append new segment to segments slice
8) Log segment addition with observability metrics
9) Return list of pruned segment URIs (empty slice if none pruned)

## Test Plan

### Objective
Verify AddSegment correctly adds segments, prunes when window size exceeded, and handles edge cases.

### Test Scenarios
- Add segment to empty playlist
- Add segments within window size (no pruning)
- Add segments beyond window size (verify pruning occurs)
- Verify mediaSequence increments correctly when pruning
- Verify maxDuration updates correctly
- Verify discontinuity flag handling
- Verify VOD/EVENT mode (windowSize=0, no pruning)
- Verify input validation (empty URI, invalid duration)
- Verify concurrent AddSegment calls are thread-safe
- Verify returned pruned segment URIs are correct

### Success Criteria
- Segments added in correct order
- Window size respected exactly (len(segments) <= windowSize when windowSize > 0)
- Media sequence increments by 1 for each pruned segment
- Max duration tracks highest segment duration
- Discontinuity flag properly applied and cleared
- VOD mode never prunes segments
- Input validation returns appropriate errors
- Thread-safe under concurrent access

## Verification

### Acceptance Criteria
- [ ] AddSegment adds segments correctly
- [ ] Sliding window prunes old segments when windowSize exceeded
- [ ] Media sequence increments correctly when segments pruned
- [ ] Max duration updates correctly
- [ ] Discontinuity flag handled correctly
- [ ] VOD mode (windowSize=0) never prunes segments
- [ ] Input validation works (empty URI, invalid duration)
- [ ] Thread-safe under concurrent AddSegment calls
- [ ] Pruned segment URIs returned correctly
- [ ] Observability logging includes all relevant metrics

## Files Modified

### Files to Modify
- `api/internal/streaming/playlist/manager.go` â€” Implement AddSegment() method

