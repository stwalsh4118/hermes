# [14-8] Test with real streams and verify no panics or errors

[Back to task list](./tasks.md)

## Description

Perform end-to-end testing with real channel streams to verify the custom playlist implementation works correctly in production-like conditions. Verify no panics, index out of range errors, or other issues occur during extended streaming sessions.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Test with real channel streams (not just unit tests)
- Verify stable playback for ≥5 minutes
- Verify no panics or index out of range errors
- Verify proper segment generation and cleanup
- Verify sliding window works correctly over time
- Verify media sequence increments correctly
- Verify playlist updates correctly as segments are added
- Verify file cleanup works (old segments deleted)

### Technical Requirements
- Use real media files and channels
- Run streaming for extended period (≥5 minutes)
- Monitor for panics, errors, or warnings
- Verify playlist file is updated correctly
- Verify segment files are created and cleaned up
- Monitor memory usage for leaks
- Verify thread-safety under concurrent operations
- Check logs for any errors or warnings

### Test Environment
- Real database with channels and media
- Real media files for streaming
- Multiple quality levels (1080p, 720p, 480p)
- Multiple concurrent clients (if applicable)
- Extended runtime (≥5 minutes per test)

## Implementation Plan

1) Set up test environment with real channels and media
2) Start streaming for a test channel
3) Monitor streaming for ≥5 minutes:
   - Watch for panics or crashes
   - Monitor playlist file updates
   - Verify segment generation
   - Verify segment cleanup (old segments deleted)
   - Verify media sequence increments
   - Check logs for errors/warnings
4) Verify playlist file is valid and playable:
   - Check playlist format
   - Verify segment URIs exist
   - Verify media sequence progression
   - Verify sliding window size maintained
5) Test multiple quality levels simultaneously
6) Test with multiple channels (if applicable)
7) Test edge cases:
   - Channel with single media item
   - Channel with many media items
   - Channel that loops
   - Channel that doesn't loop
8) Verify no memory leaks (monitor memory usage)
9) Verify file cleanup works (no orphaned segment files)
10) Document test results and any issues found

## Test Plan

### Objective
Verify the custom playlist implementation works correctly in production-like conditions with real streams.

### Test Scenarios
- Single channel, single quality, ≥5 minutes
- Single channel, multiple qualities, ≥5 minutes
- Multiple channels simultaneously
- Channel with single media item (looping)
- Channel with many media items
- Channel that doesn't loop (reaches end)
- Verify no panics or crashes
- Verify no index out of range errors
- Verify segment cleanup works
- Verify media sequence increments correctly
- Verify playlist updates correctly
- Verify memory usage is stable (no leaks)

### Success Criteria
- No panics or crashes during ≥5 minute test
- No index out of range errors
- Playlist updates correctly
- Segment cleanup works correctly
- Media sequence increments correctly
- Sliding window maintained correctly
- Memory usage stable (no leaks)
- All logs clean (no errors/warnings)

## Verification

### Acceptance Criteria
- [ ] Real stream test runs for ≥5 minutes without panics
- [ ] No index out of range errors occur
- [ ] Playlist updates correctly as segments are added
- [ ] Segment cleanup works (old segments deleted)
- [ ] Media sequence increments correctly
- [ ] Sliding window maintained correctly
- [ ] Memory usage stable (no leaks)
- [ ] All quality levels work correctly
- [ ] Multiple channels work correctly
- [ ] Edge cases handled correctly (single item, many items, looping, non-looping)

## Files Modified

### Files to Create
- `api/test/integration/playlist_e2e_test.go` — End-to-end test for real streaming

### Files to Modify
- May need to add test helpers or utilities for extended streaming tests

