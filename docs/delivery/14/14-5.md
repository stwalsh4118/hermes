# [14-5] Add unit tests for all playlist manager methods

[Back to task list](./tasks.md)

## Description

Add comprehensive unit tests for all playlist manager methods to achieve >80% code coverage. Tests should cover all methods, edge cases, error conditions, and concurrent operations to ensure the custom implementation is reliable and bug-free.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Test all Manager interface methods
- Test sliding window behavior (pruning, media sequence increments)
- Test VOD/EVENT mode (windowSize=0, no pruning)
- Test error handling (invalid inputs, file errors)
- Test concurrent operations (thread-safety)
- Test edge cases (empty playlist, single segment, boundary conditions)
- Achieve >80% code coverage

### Technical Requirements
- Use Go testing package with testify assertions
- Create test helper functions for common setup
- Use table-driven tests where appropriate
- Test both success and failure paths
- Verify thread-safety with concurrent goroutines
- Use temp directories for file operations
- Verify file contents where relevant

### Test Coverage Areas
- NewManager: valid/invalid parameters, windowSize=0 vs >0
- AddSegment: valid segments, invalid inputs, sliding window, discontinuity, ProgramDateTime
- Write: format generation, atomic writes, all tag types, VOD vs live mode
- SetDiscontinuityNext: flag setting
- GetCurrentSegments: correct URIs, pruning behavior
- GetMediaSequence: correct sequence, increments on prune
- GetSegmentCount: correct count
- GetLastSuccessfulWrite: nil before write, timestamp after write
- GetWindowSize: correct value
- GetMaxDuration: correct max duration
- HealthCheck: healthy/unhealthy states, threshold logic
- Close: final write, error handling
- Concurrent operations: multiple goroutines calling methods simultaneously

## Implementation Plan

1) Review existing test file [manager_test.go](api/internal/streaming/playlist/manager_test.go) to understand current test structure
2) Create test helper functions:
   - `segmentName(index)` for generating test segment names
   - `timePtr(t)` for creating time pointers
   - `createTestManager()` for creating test instances
3) Add tests for NewManager:
   - Valid parameters
   - Empty output path (error)
   - Zero/negative target duration (error)
   - WindowSize=0 (VOD mode)
   - WindowSize>0 (live mode)
4) Add tests for AddSegment:
   - Valid segment addition
   - Empty URI (error)
   - Zero/negative duration (error)
   - Sliding window pruning (windowSize exceeded)
   - Media sequence increments on prune
   - Max duration updates
   - Discontinuity flag handling
   - ProgramDateTime handling
   - VOD mode (no pruning)
5) Add tests for Write:
   - Empty playlist
   - Single segment
   - Multiple segments
   - ProgramDateTime tags
   - Discontinuity tags
   - VOD mode (ENDLIST tag)
   - Live mode (no ENDLIST tag)
   - Atomic write verification
   - Directory creation
   - Error handling (permission errors, etc.)
6) Add tests for remaining methods:
   - SetDiscontinuityNext
   - GetCurrentSegments (with/without pruning)
   - GetMediaSequence
   - GetSegmentCount
   - GetLastSuccessfulWrite
   - GetWindowSize
   - GetMaxDuration
   - HealthCheck (healthy/unhealthy)
   - Close
7) Add concurrent operation tests:
   - Concurrent AddSegment calls
   - Concurrent Write calls
   - Mixed concurrent operations
8) Run coverage analysis: `go test -cover ./...`
9) Verify >80% coverage achieved
10) Address any gaps in coverage

## Test Plan

### Objective
Achieve comprehensive test coverage (>80%) for all playlist manager functionality.

### Test Structure
- Use table-driven tests for similar test cases
- Use subtests for organizing related tests
- Use helper functions to reduce duplication
- Test both success and failure paths
- Test edge cases and boundary conditions

### Success Criteria
- All methods have test coverage
- >80% code coverage achieved
- All edge cases tested
- Concurrent operations verified thread-safe
- Error conditions tested
- Test output is clear and maintainable

## Verification

### Acceptance Criteria
- [ ] All Manager interface methods have tests
- [ ] Sliding window behavior tested (pruning, sequence increments)
- [ ] VOD/EVENT mode tested (no pruning)
- [ ] Error handling tested (invalid inputs, file errors)
- [ ] Concurrent operations tested (thread-safety)
- [ ] Edge cases tested (empty playlist, single segment, boundaries)
- [ ] Code coverage >80%
- [ ] All tests pass consistently
- [ ] Test code is maintainable and well-organized

## Files Modified

### Files to Modify
- `api/internal/streaming/playlist/manager_test.go` â€” Add comprehensive unit tests

