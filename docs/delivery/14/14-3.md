# [14-3] Implement Write() method with direct m3u8 text generation and atomic writes

[Back to task list](./tasks.md)

## Description

Implement the `Write()` method that generates m3u8 playlist format directly as text using `strings.Builder`, replacing the buggy library encoding. The method must perform atomic file writes using a temp file + rename pattern to prevent partial reads during updates.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Generate m3u8 playlist format as text (RFC 8216 compliant)
- Write playlist header: `#EXTM3U` and `#EXT-X-VERSION:3`
- Write `#EXT-X-MEDIA-SEQUENCE` with current mediaSequence value
- Write `#EXT-X-TARGETDURATION` with `ceil(maxDuration)` value
- Write each segment with `#EXTINF` tag (duration with 3 decimal places)
- Write `#EXT-X-PROGRAM-DATE-TIME` tag if segment has ProgramDateTime (RFC3339 format)
- Write `#EXT-X-DISCONTINUITY` tag before segment if discontinuity flag is set
- Write segment URI on line after `#EXTINF`
- Write `#EXT-X-ENDLIST` tag only in VOD/EVENT mode (windowSize=0)
- Perform atomic write: create temp file, write content, sync, close, rename to final path
- Update `lastSuccessfulWrite` timestamp on successful write

### Technical Requirements
- Use `strings.Builder` for efficient string concatenation
- Format durations with exactly 3 decimal places: `fmt.Sprintf("%.3f", duration)`
- Format timestamps in RFC3339 format: `time.Format(time.RFC3339)`
- Calculate target duration: `uint(math.Ceil(maxDuration))`
- Create temp file in same directory as output path: `os.CreateTemp(dir, ".playlist-*.tmp")`
- Ensure directory exists: `os.MkdirAll(dir, 0755)`
- Sync temp file to disk before rename: `tempFile.Sync()`
- Use atomic rename: `os.Rename(tempPath, outputPath)`
- Clean up temp file on error (defer)
- Thread-safe: acquire read lock for reading state, release before file I/O
- Log write operation with observability metrics (path, bytes, sequence, window size, latency)

### Format Specification
```
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:<mediaSequence>
#EXT-X-TARGETDURATION:<ceil(maxDuration)>
#EXT-X-PROGRAM-DATE-TIME:<RFC3339 timestamp> (if present)
#EXT-X-DISCONTINUITY (if discontinuity flag set)
#EXTINF:<duration>,
<segment-uri>
... (repeat for each segment)
#EXT-X-ENDLIST (only if windowSize == 0)
```

## Implementation Plan

1) Acquire read lock to read current state (segments, mediaSequence, maxDuration)
2) Create strings.Builder for efficient text generation
3) Write header: `#EXTM3U\n#EXT-X-VERSION:3\n`
4) Write media sequence: `#EXT-X-MEDIA-SEQUENCE:<mediaSequence>\n`
5) Write target duration: `#EXT-X-TARGETDURATION:<ceil(maxDuration)>\n`
6) Iterate through segments slice:
   - If segment has discontinuity flag, write `#EXT-X-DISCONTINUITY\n`
   - If segment has ProgramDateTime, write `#EXT-X-PROGRAM-DATE-TIME:<RFC3339>\n`
   - Write `#EXTINF:<duration>,\n` (duration with 3 decimal places)
   - Write `<segment-uri>\n`
7) If windowSize == 0 (VOD/EVENT mode), write `#EXT-X-ENDLIST\n`
8) Release read lock before file I/O operations
9) Ensure output directory exists
10) Create temp file in same directory
11) Write content to temp file
12) Sync temp file to disk
13) Close temp file
14) Atomically rename temp file to final path
15) Update lastSuccessfulWrite timestamp (acquire write lock)
16) Log write operation with metrics
17) Handle errors appropriately (cleanup temp file on error)

## Test Plan

### Objective
Verify Write() generates correct m3u8 format and performs atomic writes correctly.

### Test Scenarios
- Write empty playlist (no segments)
- Write playlist with single segment
- Write playlist with multiple segments
- Write playlist with ProgramDateTime tags
- Write playlist with Discontinuity tags
- Write playlist in VOD mode (with ENDLIST tag)
- Write playlist in live mode (without ENDLIST tag)
- Verify atomic write (temp file + rename pattern)
- Verify no temp files remain after successful write
- Verify temp files cleaned up on error
- Verify directory creation if doesn't exist
- Verify thread-safety (concurrent Write calls)
- Verify correct formatting (3 decimal places, RFC3339 timestamps)
- Verify media sequence and target duration are correct

### Success Criteria
- Generated playlist is valid m3u8 format
- All required tags present and correctly formatted
- Durations formatted with 3 decimal places
- Timestamps formatted in RFC3339
- Atomic write prevents partial reads
- No temp files remain after successful write
- Thread-safe under concurrent Write calls
- LastSuccessfulWrite timestamp updated correctly

## Verification

### Acceptance Criteria
- [ ] Playlist format is valid m3u8 (RFC 8216 compliant)
- [ ] All required tags present (#EXTM3U, #EXT-X-VERSION, #EXT-X-MEDIA-SEQUENCE, #EXT-X-TARGETDURATION)
- [ ] Segment tags formatted correctly (#EXTINF with 3 decimal places)
- [ ] ProgramDateTime tags formatted in RFC3339
- [ ] Discontinuity tags inserted correctly
- [ ] ENDLIST tag present only in VOD mode
- [ ] Atomic write prevents partial reads (temp file + rename)
- [ ] No temp files remain after successful write
- [ ] Directory created if doesn't exist
- [ ] Thread-safe under concurrent Write calls
- [ ] LastSuccessfulWrite timestamp updated correctly
- [ ] Observability logging includes all relevant metrics

## Files Modified

### Files to Modify
- `api/internal/streaming/playlist/manager.go` â€” Implement Write() method

