# [14-1] Design playlistManager data structure and interface implementation

[Back to task list](./tasks.md)

## Description

Design the improved Manager interface and playlistManager struct to replace the buggy `hls-m3u8` library implementation. This task focuses on defining the data structures and interface methods that will provide full control over playlist generation, eliminating the index out of range errors and state inconsistencies we've been experiencing.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Change | Proposed | Done | Design completed - interface and struct updated | AI_Agent |

## Requirements

### Functional Requirements
- Define `playlistManager` struct with simple Go data structures (slice of segments)
- Design improved `Manager` interface with additional observability methods
- Support both VOD/EVENT mode (windowSize=0) and live sliding window mode (windowSize>0)
- Track media sequence manually, incrementing when segments are pruned
- Track total segments ever added for sequence number calculation

### Technical Requirements
- Replace `*m3u8.MediaPlaylist` dependency with simple `[]SegmentMeta` slice
- Add `GetMediaSequence()` method to interface for observability
- Add `GetSegmentCount()` method to interface for observability
- Maintain thread-safety with `sync.RWMutex`
- Store segment directory path for file cleanup operations
- Track last successful write timestamp for health checks

### Interface Design
The improved Manager interface should include:
- Existing methods: `AddSegment`, `SetDiscontinuityNext`, `Write`, `Close`, `GetCurrentSegments`, `GetLastSuccessfulWrite`, `GetWindowSize`, `GetMaxDuration`, `HealthCheck`
- New methods: `GetMediaSequence() uint64`, `GetSegmentCount() uint`

### Data Structure Design
```go
type playlistManager struct {
    mu                  sync.RWMutex
    segments            []SegmentMeta  // Simple slice, we control pruning
    outputPath          string
    segmentDir          string
    windowSize          uint
    maxDuration         float64
    mediaSequence       uint64  // Track manually, increments on prune
    totalSegments       uint64  // Track total segments ever added
    discontinuityNext   bool
    lastSuccessfulWrite *time.Time
}
```

## Implementation Plan

1) Review current Manager interface in [manager.go](api/internal/streaming/playlist/manager.go) to understand all required methods
2) Design the new `playlistManager` struct with fields as specified in PRD section "Core Data Structure"
3) Update Manager interface to add `GetMediaSequence()` and `GetSegmentCount()` methods
4) Document the design decisions and rationale for each field
5) Ensure the design supports both VOD/EVENT mode (windowSize=0) and live mode (windowSize>0)
6) Define how mediaSequence will be calculated: starts at 0, increments by 1 for each segment pruned from the front

## Test Plan

### Objective
Validate that the data structure design is sound and the interface is complete.

### Success Criteria
- Interface includes all required methods from existing implementation
- New observability methods are properly defined
- Data structure supports both VOD and live modes
- Design is thread-safe (uses appropriate mutex)

## Verification

### Acceptance Criteria
- [x] Manager interface includes all existing methods plus new observability methods
- [x] playlistManager struct defined with all required fields
- [x] Design supports windowSize=0 (VOD/EVENT) and windowSize>0 (live) modes
- [x] Media sequence tracking strategy documented
- [x] Thread-safety considerations documented

## Files Modified

### Files to Modify
- `api/internal/streaming/playlist/manager.go` â€” Update Manager interface and define playlistManager struct

