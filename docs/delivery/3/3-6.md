# [3-6] E2E CoS Testing

[Back to task list](./tasks.md)

## Description

Comprehensive end-to-end testing that validates all Conditions of Satisfaction (CoS) defined in PBI 3. This task ensures the complete channel management system works correctly through full user workflows, verifying that all acceptance criteria are met before marking PBI 3 as complete.

E2E tests validate the entire system from API requests through business logic to database and back, covering all features implemented across tasks 3-1 through 3-4.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### PBI 3 Conditions of Satisfaction

From `docs/delivery/3/prd.md`:
- [ ] Channel CRUD API endpoints functional
- [ ] Channel creation with name, icon, start time, loop setting
- [ ] Playlist management (add, remove, reorder items)
- [ ] Playlist validation (media exists, proper ordering)
- [ ] Channel deletion with cleanup
- [ ] List all channels with current status
- [ ] Database relationships properly maintained
- [ ] Input validation on all endpoints

### Additional Verification Requirements
- Name uniqueness enforced
- Empty playlist validation works
- Transaction-based concurrency for playlist operations
- Proper HTTP status codes
- Error messages are meaningful
- Data integrity maintained

### Technical Requirements
- Real database with migrations applied
- HTTP testing with actual server
- Full workflow scenarios
- Error scenario coverage
- Performance considerations (< 100ms for most operations)
- Cleanup after tests

## Implementation Plan

### Step 1: Setup E2E Test Infrastructure
Create `test/e2e/channel_cos_test.go`:
- Start test server with real database
- Apply migrations
- Seed minimal test data
- HTTP client setup
- Cleanup functions

### Step 2: Channel CRUD Workflow
Test complete channel lifecycle:
1. Create channel with all properties
2. Retrieve channel and verify properties
3. List channels and verify presence
4. Update channel properties
5. Retrieve updated channel
6. Delete channel
7. Verify deletion

### Step 3: Playlist Management Workflow
Test complete playlist operations:
1. Create channel
2. Create 5 test media items
3. Add media items to playlist at various positions
4. Retrieve playlist and verify order
5. Reorder playlist items
6. Verify new order
7. Remove item from middle
8. Verify remaining items reordered
9. Calculate duration and verify

### Step 4: Validation Scenarios
Test all validation rules:
1. Duplicate channel name rejection
2. Invalid start time rejection
3. Non-existent media rejection in playlist
4. Empty playlist detection
5. Invalid UUID handling
6. Negative position rejection

### Step 5: Data Integrity Verification
Test database relationships:
1. Create channel with playlist
2. Delete channel
3. Verify playlist items cascade deleted
4. Verify foreign key constraints maintained
5. Verify position integrity after operations

### Step 6: Concurrent Operations
Test transaction handling:
1. Simultaneous playlist reorder operations
2. Add to playlist while reordering
3. Verify data consistency
4. Verify no race conditions

### Step 7: Error Handling Verification
Test all error scenarios:
1. 400 Bad Request (malformed input)
2. 404 Not Found (missing resources)
3. 409 Conflict (duplicate name)
4. 500 Internal Server Error (handled gracefully)
5. Error messages provide useful information

## Test Plan

### Objective
Verify all PBI 3 acceptance criteria are met through comprehensive end-to-end scenarios that test the entire system.

### Test Scope
- All channel management features
- All playlist management features
- All validation rules
- All error scenarios
- Data integrity
- Transaction handling
- Performance characteristics

### Key Test Scenarios

**CoS Verification:**

1. **Channel CRUD Endpoints Functional**
   - Given: Fresh database
   - When: Execute full CRUD lifecycle (create, read, update, delete)
   - Then: All operations succeed, data persisted correctly

2. **Channel Creation with All Properties**
   - Given: Valid channel data (name, icon, start_time, loop)
   - When: POST /api/channels
   - Then: Channel created with all properties set correctly

3. **Playlist Add/Remove/Reorder**
   - Given: Channel with 5 media items in playlist
   - When: Add item, remove item, reorder all items
   - Then: All operations succeed, positions maintained correctly

4. **Playlist Validation**
   - Given: Attempt to add non-existent media to playlist
   - When: POST /api/channels/:id/playlist with invalid media_id
   - Then: Returns 404, playlist unchanged

5. **Channel Deletion with Cleanup**
   - Given: Channel with 10 playlist items
   - When: DELETE /api/channels/:id
   - Then: Channel and all playlist items removed (cascade)

6. **List Channels with Status**
   - Given: 3 channels created
   - When: GET /api/channels
   - Then: Returns all 3 channels with basic information

7. **Database Relationships Maintained**
   - Given: Channels, media, and playlist items
   - When: Perform various operations
   - Then: Foreign keys enforced, referential integrity maintained

8. **Input Validation**
   - Given: Invalid inputs (malformed JSON, bad UUIDs, negative positions)
   - When: Call any endpoint
   - Then: Returns 400 with helpful error message

**Extended Scenarios:**

9. **Name Uniqueness Enforced**
   - Given: Existing channel "Sports Channel"
   - When: Create another channel "Sports Channel"
   - Then: Returns 409 Conflict

10. **Empty Playlist Detection**
    - Given: Channel with no playlist items
    - When: Check if playlist is empty
    - Then: Returns true

11. **Transaction Atomicity**
    - Given: Playlist reorder operation
    - When: Operation fails midway
    - Then: All changes rolled back, original state restored

12. **Full User Workflow**
    - Given: Fresh system
    - When: Create channel → add 10 shows → reorder → play (placeholder) → modify → delete
    - Then: All operations succeed in sequence

### Success Criteria
- All CoS acceptance criteria verified
- All workflows complete successfully
- All validation rules enforced
- All error scenarios handled correctly
- Data integrity maintained throughout
- No performance regressions
- Tests pass consistently

## Verification

### Acceptance Criteria
- [ ] All PBI 3 CoS items tested and verified
- [ ] Channel CRUD workflow complete and tested
- [ ] Playlist management workflow complete and tested
- [ ] All validation rules verified (uniqueness, empty playlist, start time)
- [ ] Cascade deletion verified
- [ ] Database integrity verified
- [ ] Transaction handling verified
- [ ] Error responses tested for all failure modes
- [ ] Performance acceptable (operations < 100ms)
- [ ] Tests documented and maintainable
- [ ] Can run independently with `go test ./test/e2e/...`

### Definition of Done
- All acceptance criteria met
- All E2E tests pass
- PBI 3 ready for review and approval
- Documentation complete
- No known bugs or issues
- Code quality checks passed

## Files Modified

### New Files Created
- `api/test/e2e/channel_cos_test.go` - E2E CoS verification tests
- `api/test/e2e/helpers.go` - E2E test helpers (if needed)

### Files Modified
- None (new test files only)

### API Specifications Updated
- `docs/api-specs/channels/channels-api.md` - Ensure all endpoints documented

## Notes

- This is the final verification before PBI 3 can be marked Done
- All previous tasks (3-1 through 3-5) must be complete
- Tests should be thorough but not exhaustive (avoid duplication with integration tests)
- Focus on user-facing workflows and critical paths
- Performance testing lightweight (basic smoke test, not benchmark)
- E2E tests may be slower than unit/integration tests (acceptable)
- Should test against a clean database state
- Consider using test fixtures for complex setups
- Document any known limitations or edge cases
- Include setup/teardown time in test execution
- Tests should be deterministic and repeatable
- Use meaningful test names that describe the scenario
- Group related tests using subtests

### Performance Expectations
- Channel create/update/delete: < 50ms
- Playlist add/remove: < 50ms
- Playlist reorder (10 items): < 100ms
- List channels: < 50ms
- Get channel with playlist: < 100ms

### Known Limitations to Document
- Current program endpoint is placeholder (PBI 4)
- No pagination on list endpoints (acceptable for now)
- No filtering/search capabilities yet
- Single user context (multi-user in future PBIs)

