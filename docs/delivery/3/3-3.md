# [3-3] Implement Channel API Endpoints

[Back to task list](./tasks.md)

## Description

Create REST API endpoints for channel CRUD operations. These endpoints provide the HTTP interface for channel management, handle request validation, integrate with the channel service layer, and return appropriate HTTP status codes and error responses following established patterns from the media API.

This task focuses on channel-level operations only; playlist-specific endpoints are handled in Task 3-4.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### API Endpoints to Implement

1. **GET /api/channels** - List all channels
2. **POST /api/channels** - Create new channel
3. **GET /api/channels/:id** - Get channel details
4. **PUT /api/channels/:id** - Update channel
5. **DELETE /api/channels/:id** - Delete channel
6. **GET /api/channels/:id/current** - Get current program (placeholder for PBI 4)

### Functional Requirements
- Parse and validate request bodies
- Validate UUID format for channel IDs
- Call channel service for business logic
- Return appropriate HTTP status codes
- Consistent error response format
- Request/response DTOs for type safety
- Context timeouts for database operations

### HTTP Status Codes
- **200 OK**: Successful GET, PUT operations
- **201 Created**: Successful POST
- **400 Bad Request**: Invalid input, malformed UUID
- **404 Not Found**: Channel not found
- **409 Conflict**: Duplicate channel name
- **500 Internal Server Error**: Unexpected errors

### Technical Requirements
- Follow media API handler patterns
- Use Gin framework
- Handler struct with service dependencies
- Request/response DTOs
- Structured logging with zerolog
- Context with 5-second timeout for operations
- Error response following `ErrorResponse` struct pattern

## Implementation Plan

### Step 1: Define Request/Response DTOs
Create structures in `internal/api/channel.go`:
- `CreateChannelRequest` - Name, Icon, StartTime, Loop
- `UpdateChannelRequest` - All fields optional (partial update)
- `ChannelResponse` - Channel with optional playlist summary
- `ChannelListResponse` - Array of channels
- `ErrorResponse` - Standard error format (reuse existing)

### Step 2: Create Channel Handler
- `ChannelHandler` struct with channel service dependency
- Constructor `NewChannelHandler(service *channel.ChannelService)`

### Step 3: Implement POST /api/channels
- Parse `CreateChannelRequest` from body
- Validate required fields (name, start_time)
- Call `service.CreateChannel()`
- Handle validation errors (409 for duplicate name)
- Return 201 Created with channel data

### Step 4: Implement GET /api/channels
- Call `service.List()`
- Return 200 OK with channel array
- Handle query errors with 500

### Step 5: Implement GET /api/channels/:id
- Parse channel ID from URL parameter
- Validate UUID format (400 if invalid)
- Call `service.GetByID()`
- Return 404 if not found
- Return 200 OK with channel data

### Step 6: Implement PUT /api/channels/:id
- Parse channel ID and `UpdateChannelRequest`
- Validate UUID format
- Call `service.UpdateChannel()`
- Handle not found (404), duplicate name (409)
- Return 200 OK with updated channel

### Step 7: Implement DELETE /api/channels/:id
- Parse channel ID
- Validate UUID format
- Call `service.DeleteChannel()`
- Return 404 if not found
- Return 200 OK with success message

### Step 8: Implement GET /api/channels/:id/current (Placeholder)
- Parse channel ID
- Validate UUID format
- Return 501 Not Implemented or placeholder response
- Document that this will be implemented in PBI 4

### Step 9: Register Routes
- Create `SetupChannelRoutes()` function
- Register all routes with Gin router
- Update `internal/server/server.go` to call setup function

## Test Plan

### Objective
Verify channel API endpoints handle requests correctly with proper validation and error handling.

### Test Scope
- All channel CRUD endpoints
- Request validation
- HTTP status codes
- Error responses
- Integration with channel service

### Key Test Scenarios

1. **Create Channel - Success**
   - When: POST /api/channels with valid data
   - Then: Returns 201 Created with channel data

2. **Create Channel - Duplicate Name**
   - When: POST /api/channels with existing name
   - Then: Returns 409 Conflict with error message

3. **Create Channel - Invalid Body**
   - When: POST /api/channels with malformed JSON
   - Then: Returns 400 Bad Request

4. **List Channels**
   - When: GET /api/channels
   - Then: Returns 200 OK with array of channels

5. **Get Channel - Success**
   - When: GET /api/channels/:id with valid UUID
   - Then: Returns 200 OK with channel data

6. **Get Channel - Not Found**
   - When: GET /api/channels/:id with non-existent UUID
   - Then: Returns 404 Not Found

7. **Get Channel - Invalid UUID**
   - When: GET /api/channels/:id with invalid UUID format
   - Then: Returns 400 Bad Request

8. **Update Channel - Success**
   - When: PUT /api/channels/:id with valid data
   - Then: Returns 200 OK with updated channel

9. **Update Channel - Duplicate Name**
   - When: PUT /api/channels/:id changing name to existing name
   - Then: Returns 409 Conflict

10. **Delete Channel**
    - When: DELETE /api/channels/:id
    - Then: Returns 200 OK with success message

11. **Get Current Program - Not Implemented**
    - When: GET /api/channels/:id/current
    - Then: Returns appropriate response (placeholder)

### Success Criteria
- All endpoints respond with correct HTTP status codes
- Request validation catches invalid input
- Error responses follow consistent format
- Service layer called correctly
- Logging provides useful information

## Verification

### Acceptance Criteria
- [ ] All 6 endpoints implemented
- [ ] Request/response DTOs defined
- [ ] UUID validation on all ID parameters
- [ ] Channel service integration working
- [ ] Error handling returns appropriate status codes
- [ ] Duplicate name returns 409 Conflict
- [ ] Not found returns 404
- [ ] Invalid input returns 400
- [ ] Routes registered in server setup
- [ ] Logging integrated throughout
- [ ] Integration tests cover all endpoints

### Definition of Done
- All acceptance criteria met
- Integration tests pass
- Code follows existing API patterns (media API)
- No linter errors
- Consistent with media API handler structure
- Error responses match established format

## Files Modified

### New Files Created
- `api/internal/api/channel.go` - Channel API handlers
- `api/test/integration/channel_api_test.go` - Integration tests (or add to existing)

### Files Modified
- `api/internal/server/server.go` - Register channel routes

### API Specifications Updated
- `docs/api-specs/channels/channels-api.md` - Document all implemented endpoints

## Notes

- Follow exact pattern from `internal/api/media.go` for consistency
- Use `c.ShouldBindJSON()` for request parsing
- Use `uuid.Parse()` for UUID validation
- Context timeout: `context.WithTimeout(c.Request.Context(), 5*time.Second)`
- Error response format: `ErrorResponse{Error: "error_code", Message: "description"}`
- Logging pattern: Include operation, channel_id, and relevant fields
- Current program endpoint is placeholder - full implementation in PBI 4
- Channel listing may include basic status info but detailed "now playing" comes in PBI 4

