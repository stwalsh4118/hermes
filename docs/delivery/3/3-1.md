# [3-1] Implement Channel Service

[Back to task list](./tasks.md)

## Description

Create a service layer for channel management that encapsulates business logic and validation rules. This service will handle channel CRUD operations, enforce business rules (unique names, start time validation, empty playlist checks), and integrate with the channel repository.

The service acts as an intermediary between the API layer and the data layer, ensuring all channel operations follow business rules before database operations occur.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-28 00:00:00 | Status Change | Proposed | Agreed | Task approved by User | User |
| 2025-10-28 23:10:00 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2025-10-28 23:10:00 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI_Agent |
| 2025-10-28 23:11:00 | Status Change | Review | Done | Task approved | User |

## Requirements

### Functional Requirements
- Create new channels with validation
- Retrieve single channel by ID
- List all channels
- Update channel properties (name, icon, start_time, loop)
- Delete channels
- Validate channel name uniqueness
- Validate start time (not more than 1 year in future)
- Check for empty playlists before certain operations

### Business Rules
- **Unique Names**: Channel names must be unique across all channels
- **Start Time**: Cannot be more than 1 year in the future
- **Empty Playlists**: Validation helper to check if channel has empty playlist (for use by other services/APIs)
- **Cascade Deletion**: Channel deletion cascades to playlist items (handled by database)

### Technical Requirements
- Service struct with repository dependencies
- Context support for all operations
- Structured error types for validation failures
- Integration with existing channel repository
- Integration with playlist repository for validation checks
- Logging with zerolog

### Error Scenarios to Handle
- Channel not found
- Duplicate channel name
- Invalid start time (too far in future)
- Repository errors

## Implementation Plan

### Step 1: Define Service Structure
Create `internal/channel/service.go` with:
- `ChannelService` struct with repository dependencies
- Constructor function `NewChannelService(repos *db.Repositories)`
- Custom error types for validation failures

### Step 2: Implement Create Channel
- Accept channel creation parameters
- Validate name uniqueness (query repository)
- Validate start time (not > 1 year in future)
- Generate UUID for new channel
- Set timestamps (created_at, updated_at)
- Call repository Create method
- Return created channel or error

### Step 3: Implement Get and List Operations
- `GetByID(ctx, uuid)` - Retrieve single channel
- `List(ctx)` - Retrieve all channels
- Handle not found errors appropriately
- Log errors with context

### Step 4: Implement Update Channel
- Load existing channel by ID
- Validate name uniqueness if name is changing
- Validate start time if changing
- Apply updates to channel object
- Update updated_at timestamp
- Call repository Update method

### Step 5: Implement Delete Channel
- Verify channel exists
- Call repository Delete method (cascade handled by DB)
- Log deletion

### Step 6: Implement Validation Helpers
- `HasEmptyPlaylist(ctx, channelID)` - Check if channel has no playlist items
- Use playlist repository to count items
- Return bool result

## Test Plan

### Objective
Verify channel service correctly implements business logic and validation rules.

### Test Scope
- Channel CRUD operations
- Validation rules (uniqueness, start time)
- Error handling
- Integration with repositories

### Key Test Scenarios

1. **Create Channel Success**
   - Given: Valid channel data
   - When: CreateChannel() is called
   - Then: Channel created in database with generated UUID

2. **Create Channel - Duplicate Name**
   - Given: Channel name already exists
   - When: CreateChannel() is called
   - Then: Returns validation error for duplicate name

3. **Create Channel - Future Start Time**
   - Given: Start time more than 1 year in future
   - When: CreateChannel() is called
   - Then: Returns validation error for invalid start time

4. **Update Channel - Name Uniqueness**
   - Given: Updating channel name to existing name
   - When: UpdateChannel() is called
   - Then: Returns validation error

5. **Get Channel**
   - Given: Existing channel ID
   - When: GetByID() is called
   - Then: Returns channel data

6. **Get Channel - Not Found**
   - Given: Non-existent channel ID
   - When: GetByID() is called
   - Then: Returns not found error

7. **Delete Channel**
   - Given: Existing channel
   - When: DeleteChannel() is called
   - Then: Channel removed from database

8. **Check Empty Playlist**
   - Given: Channel with no playlist items
   - When: HasEmptyPlaylist() is called
   - Then: Returns true

### Success Criteria
- All CRUD operations work correctly
- Validation rules enforced
- Error handling provides meaningful messages
- Repository integration functions properly
- TypeScript compilation passes without errors

## Verification

### Acceptance Criteria
- [ ] ChannelService struct created with repository dependencies
- [ ] CreateChannel validates name uniqueness and start time
- [ ] GetByID returns channel or not found error
- [ ] List returns all channels
- [ ] UpdateChannel applies changes with validation
- [ ] DeleteChannel removes channel from database
- [ ] HasEmptyPlaylist helper function implemented
- [ ] Custom error types for validation failures
- [ ] Logging integrated throughout
- [ ] Unit tests cover main scenarios

### Definition of Done
- All acceptance criteria met
- Unit tests pass
- Code follows Go best practices
- No linter errors
- Integrates cleanly with existing repository layer

## Files Modified

### New Files Created
- `api/internal/channel/service.go` - Channel service implementation
- `api/internal/channel/errors.go` - Custom error types
- `api/internal/channel/service_test.go` - Unit tests

### Files Modified
- `api/internal/db/channel.go` - Fixed Update method to handle boolean zero values

### API Specifications Updated
- `docs/api-specs/channels/channels-api.md` - Added ChannelService interface and validation rules

## Notes

- This service focuses on channel-level operations only
- Playlist operations handled by separate playlist service (Task 3-2)
- Name uniqueness check requires querying all existing channels
- Start time validation: `time.Now().AddDate(1, 0, 0)` as max allowed
- Empty playlist check will be used by API endpoints to prevent operations on empty channels
- Cascade deletion of playlist items handled automatically by database foreign key constraints

