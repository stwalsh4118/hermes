# [3-4] Implement Playlist API Endpoints

[Back to task list](./tasks.md)

## Description

Create REST API endpoints for playlist management within channels. These endpoints provide the HTTP interface for adding media to playlists, removing items, reordering content, and retrieving playlist details. The implementation follows established patterns from the media API and integrates with the playlist service layer.

This task complements Task 3-3 by providing playlist-specific operations while channel-level operations are handled by the channel endpoints.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-28 10:30:00 | Status Change | Proposed | Agreed | Task approved | User |
| 2025-10-28 10:30:00 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2025-10-28 11:00:00 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI_Agent |

## Requirements

### API Endpoints to Implement

1. **GET /api/channels/:id/playlist** - Get channel's playlist
2. **POST /api/channels/:id/playlist** - Add media to playlist
3. **DELETE /api/channels/:id/playlist/:item_id** - Remove item from playlist
4. **PUT /api/channels/:id/playlist/reorder** - Reorder playlist items

### Functional Requirements
- Parse and validate request bodies
- Validate UUID format for channel and item IDs
- Call playlist service for business logic
- Return appropriate HTTP status codes
- Consistent error response format
- Request/response DTOs for type safety
- Context timeouts for database operations

### HTTP Status Codes
- **200 OK**: Successful GET, PUT, DELETE operations
- **201 Created**: Successful POST (add to playlist)
- **400 Bad Request**: Invalid input, malformed UUID, invalid position
- **404 Not Found**: Channel/item/media not found
- **409 Conflict**: Position conflict (if applicable)
- **500 Internal Server Error**: Unexpected errors

### Technical Requirements
- Extend channel handler or create playlist handler
- Use Gin framework
- Request/response DTOs
- Structured logging with zerolog
- Context with 5-second timeout for operations
- Transaction handling for reorder operations
- Follow media API error response patterns

## Implementation Plan

### Step 1: Define Request/Response DTOs
Add structures to `internal/api/channel.go` (or separate file):
- `AddToPlaylistRequest` - MediaID, Position
- `ReorderPlaylistRequest` - Array of {ItemID, NewPosition}
- `PlaylistItemResponse` - PlaylistItem with embedded Media details
- `PlaylistResponse` - Array of PlaylistItemResponse with metadata (duration)

### Step 2: Extend Handler
- Add playlist service to `ChannelHandler` dependencies
- Or create separate `PlaylistHandler` if cleaner separation desired
- Constructor includes both channel and playlist services

### Step 3: Implement GET /api/channels/:id/playlist
- Parse channel ID from URL parameter
- Validate UUID format (400 if invalid)
- Call `playlistService.GetPlaylist(channelID)`
- Return 404 if channel not found
- Return 200 OK with array of playlist items (with media details)
- Include total duration in response

### Step 4: Implement POST /api/channels/:id/playlist
- Parse channel ID and `AddToPlaylistRequest`
- Validate channel ID and media ID UUIDs
- Validate position is non-negative
- Call `playlistService.AddToPlaylist(channelID, mediaID, position)`
- Handle media not found (404)
- Handle channel not found (404)
- Return 201 Created with created playlist item

### Step 5: Implement DELETE /api/channels/:id/playlist/:item_id
- Parse channel ID and item ID
- Validate both UUIDs
- Call `playlistService.RemoveFromPlaylist(itemID)`
- Return 404 if item not found
- Return 200 OK with success message
- Log reordering of subsequent items

### Step 6: Implement PUT /api/channels/:id/playlist/reorder
- Parse channel ID and `ReorderPlaylistRequest`
- Validate all UUIDs and positions
- Call `playlistService.ReorderPlaylist(channelID, reorderData)`
- Handle validation errors (400)
- Handle transaction failures (500)
- Return 200 OK with success message

### Step 7: Update Route Registration
- Add playlist routes to `SetupChannelRoutes()` or create `SetupPlaylistRoutes()`
- Ensure proper grouping under `/api/channels/:id/playlist`

## Test Plan

### Objective
Verify playlist API endpoints handle requests correctly with proper validation, error handling, and transaction management.

### Test Scope
- All playlist endpoints
- Request validation
- HTTP status codes
- Error responses
- Integration with playlist service
- Position management

### Key Test Scenarios

1. **Get Playlist - Success**
   - When: GET /api/channels/:id/playlist
   - Then: Returns 200 OK with ordered playlist items and media details

2. **Get Playlist - Channel Not Found**
   - When: GET /api/channels/:id/playlist with non-existent channel
   - Then: Returns 404 Not Found

3. **Add to Playlist - Success**
   - When: POST /api/channels/:id/playlist with valid media_id and position
   - Then: Returns 201 Created with playlist item

4. **Add to Playlist - Media Not Found**
   - When: POST /api/channels/:id/playlist with non-existent media_id
   - Then: Returns 404 Not Found

5. **Add to Playlist - Invalid Position**
   - When: POST /api/channels/:id/playlist with negative position
   - Then: Returns 400 Bad Request

6. **Remove from Playlist - Success**
   - When: DELETE /api/channels/:id/playlist/:item_id
   - Then: Returns 200 OK, subsequent items reordered

7. **Remove from Playlist - Item Not Found**
   - When: DELETE /api/channels/:id/playlist/:item_id with non-existent item
   - Then: Returns 404 Not Found

8. **Reorder Playlist - Success**
   - When: PUT /api/channels/:id/playlist/reorder with valid positions
   - Then: Returns 200 OK, all items updated atomically

9. **Reorder Playlist - Invalid Data**
   - When: PUT /api/channels/:id/playlist/reorder with invalid positions
   - Then: Returns 400 Bad Request

10. **Reorder Playlist - Transaction Integrity**
    - When: PUT /api/channels/:id/playlist/reorder fails midway
    - Then: No partial updates, returns 500

### Success Criteria
- All endpoints respond with correct HTTP status codes
- Request validation catches invalid input
- Error responses follow consistent format
- Playlist service integration works correctly
- Reorder operations are atomic
- Position management handled properly

## Verification

### Acceptance Criteria
- [x] All 4 playlist endpoints implemented
- [x] Request/response DTOs defined
- [x] UUID validation on all ID parameters
- [x] Playlist service integration working
- [x] Error handling returns appropriate status codes
- [x] Media not found returns 404
- [x] Invalid position returns 400
- [x] Reorder operation is transactional
- [x] Routes registered properly
- [x] Logging integrated throughout
- [x] Integration tests cover all endpoints
- [x] Position reordering verified

### Definition of Done
- [x] All acceptance criteria met
- [x] Integration tests pass (13 test cases)
- [x] Code follows existing API patterns
- [x] No linter errors (fmt, vet, lint all pass)
- [x] Transaction handling verified
- [x] Consistent with channel API structure

## Files Modified

### New Files Created
- None (extended existing channel.go)

### Files Modified
- `api/internal/api/channel.go` - Added playlist DTOs, handler methods, and routes (4 endpoints)
- `api/internal/server/server.go` - Added PlaylistService initialization and route registration
- `api/test/integration/channel_api_test.go` - Added TestPlaylistAPI with 13 test cases

### API Specifications Updated
- `docs/api-specs/channels/channels-api.md` - Documented all 4 playlist endpoints with examples

## Notes

- Consider whether to extend `ChannelHandler` or create separate `PlaylistHandler`
- Playlist operations always scoped to specific channel
- GET playlist should include JOIN to fetch media details (avoid N+1)
- Reorder request should include validation that all items belong to specified channel
- Position validation: must be >= 0
- Position conflicts handled by service layer (shifting items)
- Total duration calculation should be included in GET playlist response
- Consider including playlist item count in channel detail responses
- Logging should include channel_id, item_id, and position information
- Transaction failure during reorder should rollback all changes

