# [3-2] Implement Playlist Service

[Back to task list](./tasks.md)

## Description

Create a service layer for playlist management that handles adding, removing, and reordering media items within channel playlists. This service enforces business rules around playlist positions, validates media existence, calculates playlist duration, and uses database transactions for atomic multi-step operations.

The playlist service works closely with the channel service to ensure playlist integrity and proper ordering of media items.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Add media to channel playlist at specific position
- Remove media from playlist with position reordering
- Reorder playlist items (change positions)
- Retrieve playlist for a channel
- Calculate total playlist duration
- Validate media exists before adding
- Handle position conflicts and gaps

### Business Rules
- **Media Validation**: Media must exist in media table before adding to playlist
- **Position Integrity**: No duplicate positions allowed within a playlist
- **Auto-Reordering**: When item removed, subsequent items shift down
- **Transaction Safety**: Multi-step operations (reorder, remove) use database transactions
- **Position Range**: Positions are 0-indexed and must be non-negative

### Technical Requirements
- Service struct with repository dependencies (playlist, media, channel)
- Context support for all operations
- GORM transactions for atomic operations
- Structured error types for validation failures
- Integration with playlist and media repositories
- Logging with zerolog

### Error Scenarios to Handle
- Media not found
- Channel not found
- Playlist item not found
- Invalid position (negative)
- Repository/transaction errors

## Implementation Plan

### Step 1: Define Service Structure
Create `internal/channel/playlist.go` with:
- `PlaylistService` struct with repository dependencies
- Constructor function `NewPlaylistService(repos *db.Repositories)`
- Custom error types for playlist validation failures

### Step 2: Implement Add Media to Playlist
- Validate channel exists
- Validate media exists (query media repository)
- Validate position is non-negative
- If position conflicts, shift existing items up
- Create new playlist item with channel_id, media_id, position
- Call repository Create method
- Return created playlist item or error

### Step 3: Implement Remove from Playlist
- Validate playlist item exists
- Get item's current position
- Delete the item (transaction start)
- Reorder remaining items (decrement positions > deleted position)
- Commit transaction
- Return success or error

### Step 4: Implement Reorder Playlist
- Accept list of item IDs with new positions
- Validate all items belong to same channel
- Start transaction
- Update each item's position
- Handle position conflicts by processing in order
- Commit transaction
- Return success or error

### Step 5: Implement Get Playlist
- Accept channel ID
- Query playlist items with media JOIN (for full details)
- Order by position ASC
- Return list of playlist items with media details

### Step 6: Implement Calculate Duration
- Get all playlist items for channel
- Query media details for each item
- Sum all media durations
- Return total duration in seconds

## Test Plan

### Objective
Verify playlist service correctly manages playlist items with proper validation and transaction handling.

### Test Scope
- Add/remove/reorder operations
- Position management and conflict resolution
- Media validation
- Transaction integrity
- Duration calculation

### Key Test Scenarios

1. **Add Media - Success**
   - Given: Valid channel and media IDs, position 0
   - When: AddToPlaylist() is called
   - Then: Playlist item created at position 0

2. **Add Media - Position Conflict**
   - Given: Adding media at position occupied by another item
   - When: AddToPlaylist() is called
   - Then: Existing items shift up, new item inserted

3. **Add Media - Media Not Found**
   - Given: Non-existent media ID
   - When: AddToPlaylist() is called
   - Then: Returns validation error

4. **Remove Item - Reorder**
   - Given: Playlist with 5 items, remove item at position 2
   - When: RemoveFromPlaylist() is called
   - Then: Items at positions 3-4 shift down to 2-3

5. **Reorder Playlist**
   - Given: Playlist with items at positions 0,1,2
   - When: Reorder to positions 2,0,1
   - Then: All items updated to new positions atomically

6. **Get Playlist with Media**
   - Given: Channel with 3 playlist items
   - When: GetPlaylist() is called
   - Then: Returns items ordered by position with media details

7. **Calculate Duration**
   - Given: Playlist with 3 media items (1800s, 3600s, 2700s)
   - When: CalculateDuration() is called
   - Then: Returns 8100 seconds

8. **Transaction Rollback**
   - Given: Reorder operation with invalid data
   - When: Transaction fails midway
   - Then: No changes committed, original positions maintained

### Success Criteria
- All playlist operations work correctly
- Position management handles conflicts automatically
- Transactions ensure atomic multi-step operations
- Media validation prevents invalid references
- Duration calculation is accurate

## Verification

### Acceptance Criteria
- [ ] PlaylistService struct created with repository dependencies
- [ ] AddToPlaylist validates media and handles position conflicts
- [ ] RemoveFromPlaylist deletes and reorders remaining items
- [ ] Reorder operation uses transaction for atomicity
- [ ] GetPlaylist returns items with media details, ordered by position
- [ ] CalculateDuration sums all media durations
- [ ] Custom error types for playlist validation failures
- [ ] Transaction handling for multi-step operations
- [ ] Logging integrated throughout
- [ ] Unit tests cover main scenarios including transaction behavior

### Definition of Done
- All acceptance criteria met
- Unit tests pass
- Transaction handling verified (rollback on failure)
- Code follows Go best practices
- No linter errors
- Integrates cleanly with existing repository layer

## Files Modified

### New Files Created
- `api/internal/channel/playlist.go` - Playlist service implementation
- `api/internal/channel/playlist_test.go` - Unit tests

### Files Modified
- `api/internal/channel/errors.go` - Add playlist-specific error types

### API Specifications Updated
- None (API specs updated in API endpoint tasks)

## Notes

- Position management strategy: when adding at occupied position, shift existing items up
- When removing, always reorder subsequent items to maintain 0-indexed continuous sequence
- Reorder operation should validate all items belong to same channel
- Transaction handling critical for reorder and remove operations
- GetPlaylist should use JOIN to include media details (avoid N+1 queries)
- Duration calculation should handle nil/missing duration values gracefully
- Consider using `db.Repositories.PlaylistItem.Reorder()` if it provides transaction support

