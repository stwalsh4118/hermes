# [9-5] Build Media Detail Modal

[Back to task list](./tasks.md)

## Description

Create a modal component for displaying complete media item details including all metadata, file information, and transcoding requirements. This modal provides a comprehensive view of a single media item and serves as the entry point for editing metadata (via 9-6) or deleting the item.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-30 00:00:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-10-30 01:00:00 | Status Update | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2025-10-30 02:00:00 | Status Update | Review | Done | Task approved and completed | User |

## Requirements

### Functional Requirements

- Modal triggered by clicking episode in tree or grid/table views
- Display all media metadata:
  - Title
  - Show name
  - Season number
  - Episode number
  - Duration (formatted as HH:MM:SS)
  - Resolution (e.g., "1920x1080")
  - Video codec (e.g., "h264")
  - Audio codec (e.g., "aac")
  - File size (formatted as MB/GB)
  - Date added (formatted nicely)
- Display file information:
  - Full file path
  - File size (bytes and formatted)
- Display transcoding requirements section:
  - "Compatible" or "Requires Transcoding" badge
  - If transcoding required, list reasons
  - Explain what needs to be transcoded (video codec, audio codec)
- Action buttons:
  - "Edit" button (opens editor modal from 9-6)
  - "Delete" button (shows confirmation dialog)
  - "Close" button
- Confirmation dialog for delete with warning
- Handle delete operation (call API, refresh parent list)
- Handle edit completion (refresh data)
- Responsive modal (different layouts for mobile/desktop)

### Technical Requirements

- Built as React component in TypeScript
- Accept props: media item, open state, callbacks
- Use shadcn/ui Dialog component
- Call DELETE /api/media/:id for deletion
- Emit events: onEdit, onDelete, onClose
- Format data nicely (duration, file size, dates)
- Follow design system: heavy border, retro styling
- Responsive sizing
- Accessible (ARIA labels, keyboard navigation)
- Loading state during delete operation

### Data Display

```typescript
interface MediaDetailModalProps {
  media: Media | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onEdit: () => void;
  onDeleted: () => void;
}

// Format helpers needed
formatDuration(seconds: number): string // "1:32:45"
formatFileSize(bytes: number): string // "1.2 GB"
formatDate(date: Date): string // "Oct 28, 2025 3:45 PM"
determineTranscoding(media: Media): { compatible: boolean, reasons: string[] }
```

## Implementation Plan

### Step 1: Create Modal Component Structure
- Create `web/components/media/media-detail-modal.tsx`
- Set up Dialog component with proper styling
- Define props interface
- Create layout sections: header, metadata, file info, transcoding, actions

### Step 2: Build Metadata Display Section
- Create grid layout for metadata fields
- Display all metadata with labels:
  - Title (large, emphasized)
  - Show Name
  - Season / Episode
  - Duration (formatted)
  - Resolution
  - Video Codec
  - Audio Codec
  - Date Added (formatted)
- Apply retro styling (monospace font, borders)

### Step 3: Build File Information Section
- Display file path (truncated if too long, with tooltip)
- Display file size (formatted)
- Copy-to-clipboard button for file path
- Section border/separator

### Step 4: Build Transcoding Requirements Section
- Determine if transcoding needed based on codecs
- Show "Compatible" badge (green) or "Requires Transcoding" (orange/red)
- If transcoding required:
  - List specific reasons
  - "Video codec: hevc → h264 required"
  - "Audio codec: dts → aac required"
- Info icon with explanation of compatibility
- Follow design system for badges

### Step 5: Implement Utility Functions
- formatDuration(seconds): Convert to HH:MM:SS or MM:SS
- formatFileSize(bytes): Convert to KB/MB/GB with 1-2 decimals
- formatDate(date): Human-readable format
- determineTranscoding(media): Check codecs against compatibility rules
  - Compatible: h264 + aac
  - Requires transcode: anything else

### Step 6: Build Action Buttons
- "Edit" button (opens editor modal)
  - Retro button styling
  - Accent color
- "Delete" button (shows confirmation)
  - Retro button styling
  - Destructive color
- "Close" button
  - Secondary styling
- Button group layout (flex, gap)

### Step 7: Implement Delete Functionality
- Create confirmation dialog:
  - "Are you sure you want to delete this media?"
  - Show title being deleted
  - "Cancel" and "Delete" buttons
- On confirm:
  - Call apiClient.deleteMedia(id)
  - Show loading state
  - On success: emit onDeleted, close modal, show toast
  - On error: show error message, keep modal open

### Step 8: Implement Edit Integration
- "Edit" button calls onEdit callback
- Parent can open editor modal (from 9-6)
- After edit complete, refresh media data
- Keep detail modal open or close based on UX decision

### Step 9: Polish and Accessibility
- Responsive layout (stack sections on mobile)
- Keyboard shortcuts (Escape to close, E for edit, Delete key confirmation)
- ARIA labels for all sections
- Focus management (trap focus in modal)
- Loading skeletons if media loading
- Error state if media not found

## Test Plan

### Objective
Verify the media detail modal correctly displays all media information and provides functional edit/delete actions.

### Test Scope
- Modal rendering and layout
- Metadata display
- File information display
- Transcoding requirements
- Edit functionality
- Delete functionality
- Responsive behavior
- Accessibility

### Key Test Scenarios

#### Modal Rendering
- Modal opens when triggered
- All sections render correctly
- Data displays in proper format
- Modal styling follows design system

#### Metadata Display
- All metadata fields shown with correct labels
- Duration formatted correctly (HH:MM:SS)
- File size formatted correctly (MB/GB)
- Date formatted in human-readable format
- Null/missing fields handled gracefully

#### Transcoding Requirements
- Compatible media shows "Compatible" badge
- Incompatible media shows "Requires Transcoding"
- Specific reasons listed for transcoding
- Badge colors appropriate (green/orange)
- H264+AAC marked compatible
- Other codecs marked incompatible

#### File Information
- Full file path displayed
- Path truncated if too long
- Copy-to-clipboard works
- File size accurate

#### Edit Functionality
- "Edit" button calls onEdit callback
- Modal remains open after edit initiated
- Data refreshes after edit complete
- Edit flow integrates with 9-6

#### Delete Functionality
- "Delete" button shows confirmation dialog
- Confirmation shows item title
- "Cancel" closes dialog without deleting
- "Delete" calls API and shows loading
- Success: modal closes, parent refreshes, toast shown
- Error: error message shown, modal stays open

#### Responsive Behavior
- Desktop: two-column or grid layout
- Tablet: optimized layout
- Mobile: stacked single column
- All data readable on small screens
- Touch-friendly buttons

#### Accessibility
- Focus trapped in modal
- Escape key closes modal
- Tab navigation works
- ARIA labels present
- Screen reader announces sections
- Keyboard shortcuts work

### Success Criteria
- Modal displays all media information accurately
- Transcoding requirements clear and correct
- Edit integration works (with 9-6)
- Delete functionality works reliably
- Responsive on all devices
- Follows design system standards
- Accessible to keyboard and screen reader users

## Verification

- [ ] MediaDetailModal component created
- [ ] Modal opens/closes correctly
- [ ] All metadata fields displayed
- [ ] Duration formatted correctly
- [ ] File size formatted correctly
- [ ] Date formatted correctly
- [ ] File path displayed with copy button
- [ ] Transcoding requirements determined correctly
- [ ] "Compatible" badge for h264+aac
- [ ] "Requires Transcoding" for other codecs
- [ ] Reasons listed for transcoding
- [ ] "Edit" button triggers onEdit callback
- [ ] "Delete" button shows confirmation
- [ ] Delete confirmation functional
- [ ] Delete API call works
- [ ] Success: modal closes, parent refetches
- [ ] Error: error message shown
- [ ] Loading state during delete
- [ ] Toast notifications for actions
- [ ] Responsive layout on all devices
- [ ] Follows design system (border-4, heavy shadow, retro buttons)
- [ ] Accessible (ARIA, keyboard nav, focus trap)
- [ ] Integration with 9-4 (library page) works
- [ ] Ready for integration with 9-6 (editor modal)

## Files Modified

### New Files
- `web/components/media/media-detail-modal.tsx` - Media detail modal component
- `web/lib/utils/media-format.ts` - Utility functions for formatting (optional, could be in component)

### Dependencies
- Existing: @/lib/api/client (deleteMedia method)
- Existing: @/lib/types/api (Media type)
- Existing: @/components/ui/dialog (Dialog component)
- Existing: @/components/ui/button (Button component)
- Existing: @/components/ui/badge (Badge component)
- Existing: lucide-react (icons)
- Integration with task 9-6 (editor modal)

