# [9-1] Create Media Hierarchy Tree Component

[Back to task list](./tasks.md)

## Description

Build a reusable React tree view component that displays media items organized in a hierarchical structure (Show > Season > Episodes). This component will be used in both the media library page and the rebuilt media browser, providing a natural way to navigate and select media organized in folder/show/season hierarchies.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-28 12:00:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-10-28 13:30:00 | Status Update | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2025-10-28 14:30:00 | Status Update | Review | Done | Keyboard navigation fixed, task approved | User |

## Requirements

### Functional Requirements

- Display media in hierarchical tree structure: Show > Season > Episodes
- Support collapsible/expandable nodes (show level, season level)
- Show metadata at each level:
  - Show level: Show name, episode count
  - Season level: Season number, episode count
  - Episode level: Title, duration, resolution, codec info
- Checkbox selection at any level:
  - Episode checkbox: Select individual episode
  - Season checkbox: Select all episodes in that season
  - Show checkbox: Select all episodes in the show
- Visual hierarchy with indentation
- Loading states for async data operations
- Empty state when no media available
- Keyboard navigation support (arrow keys, space to select)
- Highlight search matches while maintaining tree structure

### Technical Requirements

- Built as reusable React component in TypeScript
- Accept flat array of Media objects as input
- Transform flat list into tree structure using custom hook
- Support controlled selection state (parent controls selected items)
- Optimized for large datasets (1000+ episodes)
- Use virtual scrolling for performance
- Follow design system: retro borders, monospace fonts, VCR text for headers
- Responsive design (mobile-friendly)
- Accessible (ARIA labels, keyboard navigation)

### Data Structures

```typescript
// Tree node structure
interface MediaTreeNode {
  id: string;
  type: 'show' | 'season' | 'episode';
  label: string;
  children?: MediaTreeNode[];
  media?: Media; // Only for episode nodes
  episodeCount?: number; // For show/season nodes
  expanded?: boolean;
  selected?: boolean;
  indeterminate?: boolean; // Partially selected
}

// Hook return type
interface UseMediaTreeResult {
  tree: MediaTreeNode[];
  toggleNode: (nodeId: string) => void;
  selectNode: (nodeId: string, selected: boolean) => void;
  getSelectedMedia: () => Media[];
  expandAll: () => void;
  collapseAll: () => void;
}
```

## Implementation Plan

### Step 1: Create Type Definitions
- Create `web/lib/types/media-tree.ts`
- Define MediaTreeNode interface
- Define tree-related utility types
- Export type guards for node types

### Step 2: Build Tree Organization Hook
- Create `web/hooks/use-media-tree.ts`
- Implement logic to transform flat Media[] into tree structure
- Group by show_name, then by season
- Handle media without show/season metadata (put in "Uncategorized")
- Sort shows alphabetically, seasons numerically, episodes numerically
- Implement selection logic (cascade up/down tree)
- Implement expand/collapse logic
- Memoize tree construction for performance

### Step 3: Build Tree Node Component
- Create `web/components/media/media-tree-node.tsx`
- Render individual tree node with proper indentation
- Show expand/collapse chevron for show/season nodes
- Show checkbox for all node types
- Display metadata based on node type
- Handle click events (expand/collapse, select)
- Apply proper styling (borders, spacing, hover states)

### Step 4: Build Tree Container Component
- Create `web/components/media/media-tree.tsx`
- Accept props: media items, selection state, callbacks
- Use use-media-tree hook to build tree structure
- Render tree nodes recursively
- Implement virtual scrolling with react-virtual or similar
- Add keyboard navigation handlers
- Apply container styling (border, shadow, scrollable area)

### Step 5: Add Search/Filter Support
- Extend hook to accept search query
- Filter tree nodes based on search
- Highlight matching nodes
- Keep parents expanded when children match
- Maintain tree structure even with filtering

### Step 6: Polish and Accessibility
- Add ARIA labels and roles
- Test keyboard navigation
- Add loading skeletons
- Add empty state
- Test with large datasets
- Responsive design adjustments

## Test Plan

### Objective
Verify the media tree component correctly organizes, displays, and allows selection of media in hierarchical format.

### Test Scope
- Tree organization logic
- Selection behavior (individual, season, show)
- Expand/collapse functionality
- Search/filter integration
- Performance with large datasets
- Accessibility features

### Key Test Scenarios

#### Tree Organization
- Media correctly grouped by show and season
- Shows sorted alphabetically
- Seasons sorted numerically within shows
- Episodes sorted numerically within seasons
- Media without show/season placed in "Uncategorized"
- Empty tree handled gracefully

#### Selection Behavior
- Individual episode selection works
- Season selection selects all episodes in season
- Show selection selects all episodes in show
- Deselecting season deselects all episodes
- Partial selection shows indeterminate state
- getSelectedMedia() returns correct list

#### Expand/Collapse
- Clicking show expands/collapses all seasons
- Clicking season expands/collapses episodes
- expandAll() and collapseAll() work correctly
- State persists during re-renders

#### Search/Filter
- Search highlights matching episodes
- Parents stay expanded when children match
- Tree structure maintained during search
- Clear search restores full tree

#### Performance
- Tree with 1000+ episodes renders without lag
- Virtual scrolling works correctly
- Selection operations are fast
- No memory leaks on unmount

#### Accessibility
- Keyboard navigation works (arrows, space, enter)
- Screen reader announces node types and states
- Focus visible on keyboard navigation
- ARIA expanded/selected states correct

### Success Criteria
- All test scenarios pass
- Component reusable in library page and media browser
- Performance acceptable with 1000+ items
- Follows design system standards
- Accessible to keyboard and screen reader users

## Verification

- [x] MediaTreeNode types defined in web/lib/types/media-tree.ts
- [x] use-media-tree hook implements tree organization logic
- [x] Tree component renders hierarchical structure correctly
- [x] Selection at any level (show/season/episode) works correctly
- [x] Expand/collapse functionality works
- [x] Search/filter integration maintains tree structure
- [x] Virtual scrolling implemented for performance
- [x] Keyboard navigation functional
- [x] ARIA labels and roles present
- [x] Component follows design system (borders, fonts, spacing)
- [x] Responsive on mobile devices
- [x] Performance acceptable with 1000+ items
- [x] Unit tests pass for tree organization logic
- [x] Component ready for integration in 9-2 and 9-4

## Files Modified

### New Files
- `web/lib/types/media-tree.ts` - Type definitions for tree structure
- `web/hooks/use-media-tree.ts` - Hook for tree organization and state management
- `web/components/media/media-tree-node.tsx` - Individual tree node component
- `web/components/media/media-tree.tsx` - Main tree container component

### Dependencies
- @tanstack/react-virtual (for virtual scrolling) - INSTALLED
- lucide-react (for chevron/checkbox icons) - EXISTING
- Existing: @/lib/types/api (Media type)
- Existing: @/components/ui/* (checkbox component)
- Existing: @/components/common/* (EmptyState, Skeleton)

