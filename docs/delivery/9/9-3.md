# [9-3] Build Library Scanner Component

[Back to task list](./tasks.md)

## Description

Create a React component for triggering and monitoring media library scans. This component provides the user interface for initiating directory scans to import new media files, displaying real-time progress, and showing results when complete. It integrates with the existing backend scanning APIs and provides clear feedback throughout the scanning process.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-30 00:00:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-10-30 01:00:00 | Status Update | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2025-10-30 01:30:00 | Status Update | Review | Done | Task approved and completed | User |

## Requirements

### Functional Requirements

- "Scan Library" button to initiate scan
- Path input field (or use default from config/settings)
- Progress modal appears during scan:
  - Real-time progress bar
  - Stats: Total files, Processed files, Success count, Failed count
  - Current file being processed
  - Cancel button
  - Elapsed time
- Poll scan status every 1-2 seconds during active scan
- Results summary when complete:
  - X files added
  - Y files skipped (already exist)
  - Z errors
  - List of error messages if any
- Auto-refresh media library on successful completion
- Handle scan already running (show error, can't start another)
- Handle cancellation gracefully

### Technical Requirements

- Built as React component in TypeScript
- Use existing API endpoints:
  - POST /api/media/scan (start scan)
  - GET /api/media/scan/:scanId/status (get progress)
- Custom hook for scan state management and polling
- Progress bar component (shadcn/ui Progress)
- Modal/dialog for progress display
- Toast notifications for completion/errors
- Follow design system: retro buttons, heavy borders, VCR text
- Responsive design
- Accessible (ARIA labels for progress)

### API Integration

```typescript
// Start scan
await apiClient.scanMedia(path: string)
// Returns: { scan_id: string, message: string }

// Get progress
await apiClient.getScanStatus(scanId: string)
// Returns: ScanProgress {
//   scan_id, status, total_files, processed_files,
//   success_count, failed_count, current_file,
//   start_time, end_time, errors
// }
```

## Implementation Plan

### Step 1: Create Scan State Hook
- Create `web/hooks/use-media-scan.ts`
- Manage scan state: idle, scanning, completed, failed, cancelled
- Implement startScan function (calls API)
- Implement polling logic (every 1-2 seconds)
- Implement cancelScan function
- Stop polling when scan completes/fails/cancelled
- Return scan progress data and control functions

### Step 2: Build Scanner UI Component
- Create `web/components/media/library-scanner.tsx`
- Render "Scan Library" button with icon
- Optional: Path input field (or use default)
- Button triggers scan via hook
- Handle "already running" error state
- Apply retro button styling

### Step 3: Build Progress Modal
- Create progress modal that appears when scan starts
- Display progress bar (percentage based on processed/total)
- Show current stats:
  - Total files: X
  - Processed: Y / X
  - Success: Z
  - Failed: N
  - Current file: /path/to/file.mp4
- Show elapsed time
- Add "Cancel Scan" button
- Update in real-time via polling

### Step 4: Build Results Display
- When scan completes, show results summary
- Success message: "Scan complete! X files added, Y skipped, Z errors"
- If errors, show expandable list of error messages
- "Close" button to dismiss
- Auto-trigger media library refresh

### Step 5: Integrate with Media Library Page
- Add scanner component to library page header
- Connect to media refetch function
- Handle scan completion â†’ refresh library
- Show toast notifications for quick feedback

### Step 6: Error Handling and Edge Cases
- Handle scan already running (409 Conflict)
- Handle invalid path (400 Bad Request)
- Handle scan failures (500 errors)
- Handle cancellation (update status, stop polling)
- Handle network errors during polling
- Graceful degradation if polling fails

### Step 7: Polish and Accessibility
- Loading skeletons in progress modal
- Smooth animations for progress updates
- Keyboard shortcuts (Escape to cancel)
- ARIA labels for progress bar
- Screen reader announcements for status changes
- Responsive modal sizing

## Test Plan

### Objective
Verify the library scanner component correctly initiates scans, monitors progress in real-time, and provides clear feedback on completion or errors.

### Test Scope
- Scan initiation
- Progress monitoring and polling
- Cancellation
- Completion handling
- Error scenarios
- UI/UX feedback

### Key Test Scenarios

#### Scan Initiation
- "Scan Library" button triggers scan API call
- Path input validated (if present)
- Progress modal appears on successful start
- Error shown if scan already running (409)
- Error shown if invalid path (400)

#### Progress Monitoring
- Progress bar updates as files processed
- Stats update in real-time
- Current file display updates
- Polling occurs every 1-2 seconds
- Elapsed time increases correctly

#### Cancellation
- "Cancel" button calls cancel API
- Polling stops after cancellation
- Status updates to "cancelled"
- User can start new scan after cancellation

#### Completion Handling
- Modal shows results summary when complete
- Success count, failed count displayed
- Error list shown if failures occurred
- Media library auto-refreshes
- Toast notification appears
- Polling stops after completion

#### Error Scenarios
- Network error during scan start handled
- Network error during polling handled gracefully
- Scan failure (status: failed) shown to user
- User can retry after errors
- Error messages clear and actionable

#### Performance
- Polling doesn't cause UI lag
- Long-running scans (1000+ files) work correctly
- Progress updates smooth, not jerky
- Component cleans up polling on unmount

### Success Criteria
- User can successfully initiate library scans
- Real-time progress clearly visible
- Completion results accurate and informative
- Errors handled gracefully with clear messages
- Library refreshes automatically after scan
- Follows design system standards
- Responsive and accessible

## Verification

- [x] use-media-scan hook manages scan state and polling
- [x] LibraryScanner component renders button and path input
- [x] "Scan Library" button starts scan via API
- [x] Progress modal appears during scan
- [x] Progress bar updates in real-time
- [x] Stats (total, processed, success, failed) display correctly
- [x] Current file display updates
- [x] "Cancel" button cancels scan (client-side only, no backend endpoint yet)
- [x] Results summary shown on completion
- [x] Error list displayed if failures occurred
- [x] Media library refreshes after successful scan
- [x] Toast notifications for completion/errors
- [x] Scan already running error handled (409)
- [x] Invalid path error handled (400)
- [x] Network errors handled gracefully
- [x] Component follows design system (border-4, retro buttons, font-mono)
- [x] Responsive on mobile devices
- [x] Accessible (Dialog/Button components have built-in ARIA, keyboard navigation)
- [x] Polling stops on unmount (handled by useScanStatus hook)
- [x] Integration with library page works

## Files Modified

### New Files
- `web/hooks/use-media-scan.ts` - Hook for scan state management and polling
- `web/components/media/library-scanner.tsx` - Scanner button and progress UI

### Modified Files
- `web/components/media/index.ts` - Export LibraryScanner component
- `web/app/library/page.tsx` - Integrated LibraryScanner component, removed old scan button

### Dependencies
- Existing: @/hooks/use-media (useScanMedia, useScanStatus)
- Existing: @/lib/api/client (scanMedia, getScanStatus methods)
- Existing: @/components/ui/dialog (for progress modal)
- Existing: @/components/ui/progress (for progress bar)
- Existing: @/components/ui/button (for action buttons)
- Existing: @/components/ui/input (for path input)
- Existing: @/components/ui/label (for path input label)
- Existing: @/components/ui/scroll-area (for error list)
- Existing: @/components/ui/collapsible (for expandable error list)
- Existing: lucide-react (FolderSearch, Loader2, ChevronDown, ChevronRight, X icons)
- Existing: sonner (toast notifications)

