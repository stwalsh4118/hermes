# [9-6] Build Media Editor Modal

[Back to task list](./tasks.md)

## Description

Create a modal component for editing media metadata. This allows users to correct or update metadata when automatic detection from filenames produces incorrect results. The editor provides form fields for title, show name, season, and episode number with validation and error handling.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements

- Modal triggered by "Edit" button in detail modal (9-5)
- Editable fields:
  - Title (text input, required)
  - Show Name (text input, optional)
  - Season (number input, optional, must be positive integer)
  - Episode (number input, optional, must be positive integer)
- Display current values as defaults in form
- Field validation:
  - Title required and not empty
  - Season must be positive integer if provided
  - Episode must be positive integer if provided
  - Show validation errors inline
- "Save" button (calls API, shows loading state)
- "Cancel" button (discards changes, closes modal)
- Handle save success (close modal, notify parent, show toast)
- Handle save error (show error message, keep modal open)
- Disable form during save operation
- Prevent accidental data loss (warn if unsaved changes on close attempt)

### Technical Requirements

- Built as React component in TypeScript
- Accept props: media item, open state, callbacks
- Use shadcn/ui Dialog and Form components
- Use react-hook-form for form state management
- Validation with zod schema
- Call PUT /api/media/:id for updates
- Emit events: onSaved, onCancel
- Follow design system: retro inputs, borders, styling
- Responsive modal sizing
- Accessible (labels, error announcements, keyboard nav)

### Data Flow

```typescript
interface MediaEditorModalProps {
  media: Media | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSaved: (updatedMedia: Media) => void;
}

// Form schema
const mediaEditSchema = z.object({
  title: z.string().min(1, "Title is required"),
  show_name: z.string().optional(),
  season: z.number().int().positive().optional().or(z.literal('')),
  episode: z.number().int().positive().optional().or(z.literal('')),
});

// API call
await apiClient.updateMedia(media.id, formData);
```

## Implementation Plan

### Step 1: Create Modal Component Structure
- Create `web/components/media/media-editor-modal.tsx`
- Set up Dialog component with form styling
- Define props interface
- Create form layout with proper spacing

### Step 2: Set Up Form with react-hook-form
- Install/use react-hook-form
- Define zod validation schema
- Set up form with useForm hook
- Set default values from media prop
- Connect form to inputs

### Step 3: Build Form Fields
- Title input:
  - Text input, required
  - Shows current title as default
  - Validation: non-empty
  - Error message display
- Show Name input:
  - Text input, optional
  - Shows current show name as default
  - No validation
- Season input:
  - Number input, optional
  - Shows current season as default
  - Validation: positive integer
  - Error message display
- Episode input:
  - Number input, optional
  - Shows current episode as default
  - Validation: positive integer
  - Error message display
- Apply retro input styling (border-2, monospace font)

### Step 4: Implement Form Validation
- Define zod schema with rules
- Connect schema to react-hook-form
- Show inline error messages below fields
- Highlight invalid fields (red border)
- Disable submit if form invalid
- Real-time validation as user types

### Step 5: Implement Save Functionality
- On form submit:
  - Disable form and show loading state
  - Call apiClient.updateMedia(id, data)
  - On success:
    - Close modal
    - Call onSaved callback with updated media
    - Show success toast
  - On error:
    - Show error message in modal
    - Re-enable form
    - Keep modal open for retry

### Step 6: Implement Cancel Functionality
- "Cancel" button closes modal
- If form has unsaved changes:
  - Show confirmation dialog
  - "Discard changes?" with Cancel/Discard buttons
  - On discard: reset form, close modal
  - On cancel: stay in editor
- If no changes, close immediately

### Step 7: Build Action Buttons
- "Save" button:
  - Primary retro button styling
  - Disabled if form invalid
  - Shows loading spinner during save
  - Type="submit"
- "Cancel" button:
  - Secondary retro button styling
  - Always enabled
  - Triggers cancel logic
- Button group with proper spacing

### Step 8: Polish and Accessibility
- Responsive layout (stack on mobile)
- Keyboard shortcuts:
  - Enter to save (if valid)
  - Escape to cancel
  - Tab navigation
- Focus management:
  - Focus title field on open
  - Trap focus in modal
- ARIA labels for all fields
- Error announcements for screen readers
- Loading state visual feedback

## Test Plan

### Objective
Verify the media editor modal allows users to successfully update media metadata with proper validation and error handling.

### Test Scope
- Modal rendering and form display
- Form validation
- Save functionality
- Cancel functionality
- Error handling
- Responsive behavior
- Accessibility

### Key Test Scenarios

#### Modal Rendering
- Modal opens when triggered
- Form fields populated with current values
- All fields rendered correctly
- Modal styled per design system

#### Form Validation
- Title required: empty shows error
- Title non-empty: error clears
- Season validation: only positive integers accepted
- Season invalid: error shown ("Must be a positive integer")
- Episode validation: only positive integers accepted
- Episode invalid: error shown
- Optional fields: can be left empty
- Submit disabled when form invalid

#### Save Functionality
- Valid form submission calls API
- Loading state shown during save
- Form disabled during save
- Success: modal closes, onSaved called, toast shown
- Updated data passed to parent
- Parent refreshes data after save

#### Error Handling
- Network error: error message shown in modal
- API error (400/500): error message shown
- User can retry after error
- Form re-enabled after error
- Modal stays open on error

#### Cancel Functionality
- Cancel with no changes: closes immediately
- Cancel with changes: shows confirmation
- Confirmation "Discard changes?" shown
- Discard: closes modal, resets form
- Stay: keeps modal open with changes

#### Responsive Behavior
- Desktop: form fields in grid
- Mobile: stacked fields
- All fields accessible on small screens
- Touch-friendly inputs
- Keyboard works on all devices

#### Accessibility
- All fields have labels
- Error messages associated with fields
- Title field focused on open
- Tab navigation works
- Enter submits form
- Escape cancels
- Screen reader announces errors
- Loading state announced

### Success Criteria
- Users can successfully update media metadata
- Validation prevents invalid data
- Errors handled gracefully with clear messages
- Unsaved changes protected
- Follows design system standards
- Responsive on all devices
- Accessible to keyboard and screen reader users

## Verification

- [ ] MediaEditorModal component created
- [ ] react-hook-form integrated
- [ ] Zod validation schema defined
- [ ] Form fields render with current values
- [ ] Title field required and validated
- [ ] Show name field works (optional)
- [ ] Season field validates positive integer
- [ ] Episode field validates positive integer
- [ ] Inline error messages display
- [ ] Invalid fields highlighted
- [ ] Submit button disabled when invalid
- [ ] Save calls updateMedia API
- [ ] Loading state during save
- [ ] Success: modal closes, onSaved called, toast shown
- [ ] Error: message shown, form re-enabled
- [ ] Cancel with no changes closes immediately
- [ ] Cancel with changes shows confirmation
- [ ] Confirmation dialog works correctly
- [ ] Responsive layout on all devices
- [ ] Follows design system (border-2, retro buttons, monospace)
- [ ] Accessible (labels, ARIA, keyboard nav, focus)
- [ ] Keyboard shortcuts work (Enter, Escape)
- [ ] Integration with 9-5 (detail modal) works
- [ ] Parent data refreshes after save

## Files Modified

### New Files
- `web/components/media/media-editor-modal.tsx` - Media editor modal component

### Dependencies
- Existing: @/lib/api/client (updateMedia method)
- Existing: @/lib/types/api (Media, UpdateMediaRequest types)
- Existing: @/components/ui/dialog (Dialog component)
- Existing: @/components/ui/form (Form components from shadcn)
- Existing: @/components/ui/input (Input component)
- Existing: @/components/ui/button (Button component)
- react-hook-form (form management)
- zod (validation)
- lucide-react (icons)
- Integration with task 9-5 (detail modal triggers this editor)

