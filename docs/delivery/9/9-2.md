# [9-2] Rebuild Media Browser with Tree View and Bulk Selection

[Back to task list](./tasks.md)

## Description

Completely rebuild the existing media browser component (`web/components/channel/media-browser.tsx`) to support tree view navigation and bulk selection operations. The current implementation only supports single selection, making it inefficient for adding multiple episodes or entire seasons/shows to playlists. The new browser will leverage the tree component from task 9-1 to enable bulk operations essential for managing large media libraries.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements

- Replace flat list view with hierarchical tree view (from 9-1)
- Support multi-select with checkboxes at show/season/episode level
- "Add Selected (X)" button showing count of selected items
- Bulk add hundreds of episodes at once efficiently
- Search bar filters tree in real-time
- Show which items are already in the current playlist:
  - Disabled/grayed out
  - "Already Added" badge
  - Cannot be selected again
- Display selection count prominently
- "Clear Selection" button
- Modal can be closed with selections pending (doesn't auto-add)
- Only "Add Selected" button triggers the actual add operation
- Loading states during data fetch and bulk add operation
- Error handling for failed bulk operations

### Technical Requirements

- Major rewrite of `web/components/channel/media-browser.tsx`
- Use MediaTree component from task 9-1
- Accept new props:
  - `onSelectMedia` â†’ `onBulkAdd` (accepts Media[])
  - `playlistMediaIds` (to disable already-added items)
- Integrate with existing apiClient.bulkAddToPlaylist method
- Handle API errors gracefully (show which items failed)
- Optimize for bulk operations (batch API calls)
- Follow design system: modal with heavy border, retro buttons
- Responsive design (mobile-friendly modal)
- Progress indication during bulk add

### API Integration

```typescript
// Existing API method to use
apiClient.bulkAddToPlaylist(channelId, items: AddToPlaylistRequest[])
// Returns: { items: PlaylistItem[], added: number, failed: number, total: number }
```

## Implementation Plan

### Step 1: Update Props Interface
- Modify MediaBrowserProps interface
- Change `onSelectMedia: (media: Media) => void` to `onBulkAdd: (media: Media[]) => void`
- Add `channelId: string` prop (needed for bulk API call)
- Keep `playlistMediaIds: string[]`
- Keep `open` and `onOpenChange`

### Step 2: Replace List View with Tree View
- Remove existing flat list implementation
- Import MediaTree component from 9-1
- Pass media data to MediaTree
- Handle tree selection state
- Implement filtering logic (search filters tree)

### Step 3: Implement Selection Management
- Track selected media items in state
- Update selection when tree nodes are checked
- Display count of selected items
- Implement "Clear Selection" functionality
- Disable items already in playlist (check against playlistMediaIds)

### Step 4: Build Selection UI
- Add selection count display (e.g., "15 items selected")
- Add "Clear Selection" button
- Update "Add to Playlist" button to "Add Selected (X)"
- Disable button when no items selected
- Show visual feedback on selected items

### Step 5: Implement Bulk Add Operation
- Call apiClient.bulkAddToPlaylist with selected items
- Show loading state during operation
- Handle response (added, failed counts)
- Display success message with results
- Show errors if any items failed
- Clear selection and close modal on success
- Refresh parent playlist

### Step 6: Update Playlist Editor Integration
- Modify playlist-editor.tsx to use new onBulkAdd prop
- Update handleSelectMedia to handleBulkAdd
- Handle bulk add response appropriately
- Show toast notifications for success/errors

### Step 7: Polish and Error Handling
- Add loading skeletons during initial data fetch
- Show error state if media fetch fails
- Handle edge cases (no media, all already added)
- Responsive modal sizing
- Keyboard shortcuts (Escape to close, Enter to add)
- Accessibility improvements

## Test Plan

### Objective
Verify the rebuilt media browser supports efficient bulk selection and addition of media items to playlists, handling large selections gracefully.

### Test Scope
- Tree view integration
- Multi-select functionality
- Bulk add operations
- Already-added item handling
- Search/filter behavior
- Error handling
- Performance with large selections

### Key Test Scenarios

#### Tree View Integration
- Media displayed in tree structure (Show > Season > Episodes)
- Tree properly integrates with MediaTree component
- Selection state managed correctly
- Expand/collapse works in modal context

#### Multi-Select Functionality
- Individual episode selection works
- Season selection selects all episodes
- Show selection selects all episodes
- Selection count updates correctly
- "Clear Selection" clears all selections
- Selected items visually indicated

#### Already-Added Items
- Items in playlistMediaIds are disabled
- Disabled items show "Already Added" badge
- Disabled items cannot be selected
- Selection logic skips disabled items

#### Bulk Add Operations
- "Add Selected" button calls bulkAddToPlaylist API
- Loading state shown during operation
- Success message shows added/failed counts
- Failed items reported with error messages
- Modal closes on successful add
- Playlist refreshes with new items

#### Search/Filter
- Search filters tree in real-time
- Filtered results maintain tree structure
- Selection works on filtered results
- Clear search shows full tree

#### Performance
- Selecting 100+ episodes is fast
- Bulk add handles 200+ items efficiently
- No UI freezing during operations
- Progress indication for long operations

#### Error Handling
- Network errors handled gracefully
- Partial failures reported clearly
- User can retry failed items
- Modal doesn't close on error

### Success Criteria
- Can select and add entire shows/seasons efficiently
- Bulk adding 200+ episodes works without issues
- Already-added items correctly disabled
- User receives clear feedback on success/failure
- Performance acceptable with large libraries
- Follows design system standards
- Integration with playlist editor works seamlessly

## Verification

- [ ] MediaBrowser props updated for bulk operations
- [ ] Tree view replaces flat list view
- [ ] Multi-select with checkboxes works at all levels
- [ ] Selection count displayed prominently
- [ ] "Add Selected" button shows count
- [ ] Already-added items disabled and marked
- [ ] Bulk add API integration works
- [ ] Success/error messages clear and informative
- [ ] Search filtering works with tree view
- [ ] Loading states during data fetch and bulk add
- [ ] Error handling for failed operations
- [ ] Playlist editor updated to use new interface
- [ ] Modal follows design system (border-4, heavy shadow)
- [ ] Responsive on mobile devices
- [ ] Performance acceptable with 200+ item selections
- [ ] Integration tests pass
- [ ] User can efficiently add entire seasons/shows to playlists

## Files Modified

### Modified Files
- `web/components/channel/media-browser.tsx` - Complete rewrite for tree view and bulk selection
- `web/components/channel/playlist-editor.tsx` - Update to use new bulk add interface

### Dependencies
- Task 9-1 (MediaTree component) must be complete
- Existing: @/hooks/use-media (for fetching media data)
- Existing: @/lib/api/client (bulkAddToPlaylist method)
- Existing: @/components/ui/* (Dialog, Button, Input, ScrollArea)
- Existing: lucide-react icons

