# [9-4] Create Media Library Page with Tree View

[Back to task list](./tasks.md)

## Description

Build the main media library page that serves as the primary interface for browsing, searching, and managing the media collection. The page features tree view navigation (Show > Season > Episodes) as the default view, integrated search and filtering, and the library scanner component. This is the central hub for all media management activities.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-28 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements

- Page route at `/library` (Next.js app router)
- Uses RetroHeaderLayout for consistent navigation
- Page header with title "Media Library" (VCR text)
- Library scanner component integration (from 9-3)
- Search bar for real-time filtering
- Filter controls:
  - Show name dropdown (populated from available shows)
  - "Needs Transcoding" checkbox filter
  - Clear filters button
- Tree view as primary display (from 9-1)
- Click on episode opens detail modal (from 9-5)
- Empty state when no media exists
- Loading skeletons during data fetch
- Error state if fetch fails
- Stats summary: Total shows, Total episodes, Total duration
- Responsive layout (mobile, tablet, desktop)

### Technical Requirements

- Next.js page component at `web/app/library/page.tsx`
- Use existing useMedia hook for data fetching
- Integrate MediaTree component from 9-1
- Integrate LibraryScanner component from 9-3
- Integrate MediaDetailModal from 9-5 (triggered on episode click)
- Client-side filtering for search/filters
- Auto-refresh after successful scan
- Follow design system: retro styling, heavy borders, VCR text
- Responsive grid layout
- Accessible (semantic HTML, ARIA labels)

### Data Flow

```typescript
// Fetch media
const { data, isLoading, isError, refetch } = useMedia({ limit: 1000 });

// Filter logic
const filteredMedia = applyFilters(data?.items, { search, showFilter, needsTranscoding });

// Pass to tree
<MediaTree media={filteredMedia} onSelectEpisode={openDetailModal} />

// Refresh after scan
onScanComplete={() => refetch()}
```

## Implementation Plan

### Step 1: Create Page Structure
- Create `web/app/library/page.tsx`
- Set up RetroHeaderLayout wrapper
- Create page header with title
- Set up main content container
- Define responsive layout grid

### Step 2: Implement Data Fetching
- Use existing useMedia hook
- Fetch all media (or paginated if needed)
- Handle loading state (show skeletons)
- Handle error state (show error message)
- Implement refetch function for scan completion

### Step 3: Build Search and Filter UI
- Add search input in header area
- Add show name filter dropdown
  - Populate from unique show names in data
  - Include "All Shows" option
- Add "Needs Transcoding" checkbox
- Add "Clear Filters" button
- Implement filter logic
- Debounce search input (300ms)

### Step 4: Integrate Tree View
- Import MediaTree component from 9-1
- Pass filtered media data
- Handle episode selection (open detail modal)
- Style tree container with card/border

### Step 5: Integrate Scanner Component
- Import LibraryScanner from 9-3
- Place in header area or above tree
- Connect onScanComplete to refetch function
- Show toast on successful scan

### Step 6: Add Stats Summary
- Calculate stats from media data:
  - Unique show count
  - Total episode count
  - Total duration (sum all episodes)
- Display in stat cards above tree
- Format duration nicely (e.g., "124h 32m")
- Update stats when filters applied

### Step 7: Integrate Detail Modal
- Import MediaDetailModal from 9-5 (placeholder until 9-5 complete)
- Open modal when episode clicked in tree
- Pass episode data to modal
- Handle modal close
- Refetch data if episode edited/deleted

### Step 8: Empty and Loading States
- Create empty state component:
  - "Your library is empty"
  - "Scan a directory to get started" message
  - Prominent scan button
- Create loading skeleton matching tree structure
- Show appropriate state based on data

### Step 9: Polish and Responsiveness
- Mobile layout adjustments:
  - Stack filters vertically
  - Simplified stat cards
  - Touch-friendly tree
- Tablet layout optimizations
- Desktop: full feature display
- Keyboard shortcuts (Ctrl+K for search)
- Smooth transitions between states

## Test Plan

### Objective
Verify the media library page provides an efficient interface for browsing, searching, and managing media collections with tree view navigation.

### Test Scope
- Page rendering and layout
- Data fetching and display
- Search and filtering
- Tree view integration
- Scanner integration
- Modal integration
- Responsive behavior
- User workflows

### Key Test Scenarios

#### Page Rendering
- Page loads at /library route
- RetroHeaderLayout applied correctly
- Page header displays "Media Library" in VCR text
- Scanner component renders
- Search and filter controls render

#### Data Fetching
- Media data fetched on page load
- Loading skeletons shown during fetch
- Tree populated with media when loaded
- Error state shown on fetch failure
- Retry option available on error

#### Search and Filtering
- Search input filters media in real-time
- Search debounced appropriately (300ms)
- Show filter dropdown populated correctly
- Show filter narrows results
- "Needs Transcoding" checkbox works
- Clear filters resets to all media
- Filtered tree maintains hierarchy

#### Tree View Integration
- Media displayed in tree structure
- Expand/collapse works
- Episode click opens detail modal
- Selection state managed
- Tree follows design system

#### Scanner Integration
- Scanner button triggers scan
- Progress modal appears
- Scan completion triggers refetch
- Media list updates with new files
- Toast notification on completion

#### Stats Summary
- Show count accurate
- Episode count accurate
- Total duration calculated correctly
- Stats update with filters applied
- Stats formatted nicely

#### Modal Integration
- Episode click opens detail modal
- Modal displays correct episode data
- Modal close works
- Edit/delete in modal triggers refetch
- Multiple modal opens/closes work

#### Empty State
- Empty state shown when no media
- Scan button prominent in empty state
- Clear messaging

#### Responsive Behavior
- Mobile: stacked layout, simplified controls
- Tablet: optimized for touch
- Desktop: full features visible
- Tree readable on all screen sizes
- Touch targets appropriate on mobile

### Success Criteria
- Page provides efficient interface for browsing media
- Tree view makes navigating large libraries easy
- Search and filters work smoothly
- Scanner integration seamless
- Stats provide useful overview
- Responsive on all device sizes
- Follows design system standards
- All user workflows functional

## Verification

- [ ] Page created at web/app/library/page.tsx
- [ ] RetroHeaderLayout wrapper applied
- [ ] Page header with "Media Library" title
- [ ] useMedia hook fetching data
- [ ] Loading skeletons during fetch
- [ ] Error state with retry option
- [ ] Search input with debouncing
- [ ] Show name filter dropdown
- [ ] "Needs Transcoding" checkbox filter
- [ ] Clear filters button
- [ ] MediaTree component integrated
- [ ] Filtered data passed to tree
- [ ] LibraryScanner component integrated
- [ ] Scan completion triggers refetch
- [ ] Stats summary displays correctly
- [ ] Episode click opens detail modal (9-5)
- [ ] Modal close/edit/delete handled
- [ ] Empty state when no media
- [ ] Responsive layout on mobile/tablet/desktop
- [ ] Follows design system (borders, shadows, fonts)
- [ ] Accessible (semantic HTML, ARIA)
- [ ] Keyboard shortcuts work
- [ ] Page ready for integration with tasks 9-5, 9-6

## Files Modified

### New Files
- `web/app/library/page.tsx` - Main media library page

### Dependencies
- Task 9-1 (MediaTree component) must be complete
- Task 9-3 (LibraryScanner component) must be complete
- Task 9-5 (MediaDetailModal) - integration point
- Existing: @/hooks/use-media (data fetching)
- Existing: @/components/layout/retro-header-layout
- Existing: @/components/ui/* (Input, Button, Card, etc.)
- Existing: @/lib/api/client
- Existing: lucide-react icons

