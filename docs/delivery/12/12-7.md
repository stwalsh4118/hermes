# [12-7] Update cleanup for batch-aware operation

[Back to task list](./tasks.md)

## Description

Modify segment cleanup logic to be batch-aware. Instead of deleting segments immediately, keep N-1 batch (previous batch) available during N batch generation, and delete N-2 batch (two batches ago) only after N batch completes successfully. This prevents gaps if batch generation fails and ensures smooth transitions.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Modify cleanup logic to be batch-aware
- Keep N-1 batch during N batch generation
- Delete N-2 batch after N batch completes
- Only cleanup if current batch number >= 2 (need at least 2 batches)
- Calculate segment range for batch to delete
- Handle segment filename pattern (wraps at 1000)
- Clean up segments atomically (per batch)

### Technical Requirements
- Modify `api/internal/streaming/cleanup.go`
- Add cleanupOldBatches method
- Integrate with batch completion monitoring
- Use batch number from StreamSession
- Calculate segment range from batch number
- Handle segment filename wrapping (%03d pattern)

### Cleanup Strategy
- Current batch: N (generating)
- Keep batch: N-1 (previous, still needed)
- Delete batch: N-2 (two batches ago, safe to delete)
- Only cleanup when N >= 2

## Implementation Plan

### Step 1: Add cleanupOldBatches method
- Create method that takes StreamSession
- Get current batch from session
- Check if batch number >= 2 (early return if not)
- Calculate batch to delete (current - 2)
- Calculate segment range for that batch
- Delete segments in that range

### Step 2: Calculate segment range
- Start segment = (batchToDelete * BatchSize)
- End segment = startSegment + BatchSize - 1
- Handle segment filename pattern (wraps at 1000 with %03d)

### Step 3: Delete segments
- Iterate through segment range
- Build segment file path
- Delete segment file (ignore not found errors)
- Log deletion errors (warn level)

### Step 4: Integrate with batch completion
- Call cleanupOldBatches in monitorBatchCompletion
- Only cleanup after batch completes successfully
- Don't cleanup on failure (keep previous batch)

### Step 5: Update existing cleanup
- Review existing cleanupSegments method
- Ensure it doesn't conflict with batch cleanup
- May need to disable or modify for batch mode

## Test Plan

### Objective
Verify batch-aware cleanup correctly keeps needed batches and deletes old batches safely.

### Test Scope
- Batch number validation (only cleanup if >= 2)
- Segment range calculation
- Segment file deletion
- Integration with batch completion
- Error handling (file not found, permission errors)
- Segment filename wrapping

### Success Criteria
- N-1 batch kept during N batch generation
- N-2 batch deleted after N batch completes
- No cleanup when batch number < 2
- Segment range calculated correctly
- Files deleted successfully
- Errors handled gracefully

## Verification

### Acceptance Criteria
- [ ] cleanupOldBatches method implemented
- [ ] Only cleans up when batch number >= 2
- [ ] Calculates correct segment range for N-2 batch
- [ ] Deletes segments in calculated range
- [ ] Handles segment filename wrapping
- [ ] Integrated with batch completion monitoring
- [ ] Only cleans up after successful batch completion
- [ ] Errors handled gracefully
- [ ] Unit tests pass
- [ ] Code compiles without errors

### Definition of Done
- All acceptance criteria met
- Unit tests for cleanup logic
- Integration tests for batch cleanup
- Error cases covered
- Code follows Go best practices
- Ready for legacy removal

## Files Modified

### Modified Files
- `api/internal/streaming/cleanup.go` - Add batch-aware cleanup
- `api/internal/streaming/manager.go` - Integrate cleanup with batch completion

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document batch-aware cleanup

## Notes

- Cleanup happens after batch completes, not during generation
- Keeping N-1 batch provides safety buffer if generation fails
- Segment filename pattern wraps at 1000 (%03d), but logical segment numbers continue
- Only delete segments, not playlists (playlists are regenerated)
- Cleanup is best-effort (errors logged but don't fail batch)

