# [12-6] Implement batch continuation logic

[Back to task list](./tasks.md)

## Description

Implement the complete batch generation logic that calculates next batch parameters (batch number, segment range, video position), handles video looping and transitions, builds FFmpeg commands, launches processes, and monitors batch completion. Integrate with timeline service for video position calculations and handle seamless continuation between batches.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Change | InProgress | Done | Implementation complete, all tests passing, code quality checks passed | AI_Agent |

## Requirements

### Functional Requirements
- Calculate next batch number (current + 1)
- Calculate next segment range (start = current end + 1, end = start + batch size - 1)
- Calculate video position for next batch (handle looping)
- Query timeline service for media transitions if batch crosses video boundaries
- Build FFmpeg command with correct seek position and batch parameters
- Launch FFmpeg process for batch generation
- Update session with new batch state
- Monitor batch completion (wait for FFmpeg to exit)
- Handle batch completion (success and failure)
- Log batch generation events

### Technical Requirements
- Complete generateNextBatch method in StreamManager
- Add monitorBatchCompletion method
- Integrate with timeline service for position calculations
- Use BuildTimelineInput for video position
- Use BuildHLSCommand with batch parameters
- Use launchFFmpeg to start process
- Update StreamSession batch state atomically
- Handle errors gracefully (log, update session)

### Batch Continuation Logic
- Get current batch from session
- Calculate next batch number = current.BatchNumber + 1
- Calculate next start segment = current.EndSegment + 1
- Calculate next end segment = nextStartSegment + BatchSize - 1
- Calculate video offset = current.VideoStartOffset + (BatchSize * SegmentDuration)
- Handle video looping: offset % videoDuration
- Query timeline service if batch crosses video boundary
- Build FFmpeg command with seek position
- Launch and monitor process

## Implementation Plan

### Step 1: Complete generateNextBatch method
- Get current batch from session (with lock)
- Calculate next batch parameters (number, segment range)
- Calculate video position (current offset + batch duration)
- Get video duration to check for looping
- Handle video looping (modulo operation)
- Query timeline service if needed (for video transitions)
- Build StreamParams with batch mode enabled
- Build FFmpeg command
- Launch FFmpeg process
- Create new BatchState
- Update session with new batch (with lock)
- Launch monitorBatchCompletion goroutine
- Log batch start

### Step 2: Add monitorBatchCompletion method
- Wait for FFmpeg process to exit (cmd.Wait())
- Update batch state (GenerationEnded, IsComplete)
- Log completion or error
- Handle errors (log, don't crash)
- Consider retry logic (future task)

### Step 3: Integrate with timeline service
- Use BuildTimelineInput for video position calculation
- Handle media file transitions
- Update video path if batch crosses boundary

### Step 4: Handle video looping
- Calculate if next offset exceeds video duration
- Use modulo to wrap around: nextOffset % videoDuration
- Keep same video file for looping playlists

### Step 5: Error handling
- Handle FFmpeg command build errors
- Handle FFmpeg launch errors
- Handle process wait errors
- Log all errors with context
- Update session error state if needed

## Test Plan

### Objective
Verify batch continuation logic correctly calculates parameters, launches FFmpeg, and monitors completion.

### Test Scope
- Batch parameter calculation
- Video position calculation
- Video looping handling
- Timeline service integration
- FFmpeg command building
- Process launching
- Batch completion monitoring
- Error handling

### Success Criteria
- Next batch parameters calculated correctly
- Video position calculated correctly
- Video looping handled correctly
- FFmpeg commands built correctly
- Processes launched successfully
- Batch completion detected
- Errors handled gracefully

## Verification

### Acceptance Criteria
- [x] generateNextBatch method fully implemented
- [x] monitorBatchCompletion method implemented
- [x] Batch parameters calculated correctly
- [x] Video position calculated correctly
- [x] Video looping handled (modulo operation)
- [x] Timeline service integrated for transitions
- [x] FFmpeg commands built with correct parameters
- [x] Processes launched and monitored
- [x] Batch state updated correctly
- [x] Completion logged correctly
- [x] Errors handled gracefully
- [x] Code compiles without errors
- [x] Code quality checks pass (gofmt, go vet, golangci-lint)

### Definition of Done
- All acceptance criteria met
- Integration tests for batch generation
- Integration tests for video looping
- Error cases covered
- Code follows Go best practices
- Ready for cleanup implementation

## Files Modified

### Modified Files
- `api/internal/streaming/manager.go` - Complete batch generation logic
- `api/internal/models/stream_session.go` - Add UpdateBatchCompletion method

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document batch generation and continuation

## Notes

- Batch numbering is continuous (0, 1, 2, ...)
- Segment numbering is continuous across batches
- Video position wraps around for looping playlists
- Timeline service handles multi-video transitions
- Batch completion monitoring runs in goroutine
- FFmpeg exits cleanly after generating batch (no kill needed)

