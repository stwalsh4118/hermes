# [12-10] Create integration tests for batch system

[Back to task list](./tasks.md)

## Description

Create comprehensive integration tests for the batch generation system. Test batch generation completion, position tracking updates, automatic batch triggering, seamless batch continuation, and multi-client synchronization. Verify the entire batch workflow from position reporting through batch generation to cleanup.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-11-10 19:20:00 | Status Change | Proposed | Done | Integration tests implemented and passing | AI_Agent |

## Requirements

### Functional Requirements
- Test batch generation completes successfully
- Test position tracking updates client positions
- Test automatic batch triggering when threshold reached
- Test seamless continuation between batches
- Test multi-client synchronization (multiple clients, same stream)
- Test batch cleanup (N-2 batch deletion)
- Test error handling (batch generation failures)

### Technical Requirements
- Create integration test file in `api/test/integration/`
- Use test database and test media files
- Mock or use real FFmpeg (prefer real for integration tests)
- Test StreamManager batch coordinator
- Test position tracking API endpoint
- Test batch state transitions
- Follow existing integration test patterns

### Test Scenarios
1. **Batch Generation**: Start stream, verify first batch generates and completes
2. **Position Tracking**: Send position updates, verify session updates
3. **Automatic Triggering**: Update position to threshold, verify next batch triggers
4. **Batch Continuation**: Verify next batch starts where previous ended
5. **Multi-Client**: Multiple clients report positions, verify furthest tracked
6. **Cleanup**: Verify old batches deleted after completion
7. **Error Handling**: Simulate batch failure, verify recovery

## Implementation Plan

### Step 1: Create test file
- Create `api/test/integration/batch_generation_test.go`
- Set up test fixtures (database, test media, StreamManager)
- Follow existing integration test patterns

### Step 2: Test batch generation
- Start stream for test channel
- Wait for first batch to generate
- Verify batch state in session
- Verify segments created on disk
- Verify FFmpeg process exits cleanly

### Step 3: Test position tracking
- Register client for stream
- Send position update via API
- Verify client position in session
- Verify furthest segment updated
- Test multiple position updates

### Step 4: Test automatic triggering
- Generate first batch
- Update position to trigger threshold
- Wait for batch coordinator to trigger
- Verify second batch starts
- Verify batch parameters correct

### Step 5: Test batch continuation
- Complete first batch
- Trigger second batch
- Verify segment numbering continuous
- Verify video position calculated correctly
- Verify no gaps in segments

### Step 6: Test multi-client synchronization
- Register multiple clients
- Each reports different positions
- Verify furthest position tracked correctly
- Verify batch triggers based on furthest
- Test client disconnection

### Step 7: Test cleanup
- Generate multiple batches
- Verify N-2 batch deleted after N completes
- Verify N-1 batch kept during N generation
- Verify segments deleted correctly

### Step 8: Test error handling
- Simulate FFmpeg failure
- Verify error logged
- Verify batch state updated
- Verify previous batch still available
- Test retry logic (if implemented)

## Test Plan

### Objective
Verify the complete batch generation system works correctly end-to-end with all components integrated.

### Test Scope
- Batch generation workflow
- Position tracking integration
- Automatic triggering
- Batch continuation
- Multi-client scenarios
- Cleanup operations
- Error scenarios

### Success Criteria
- All integration tests pass
- Batch generation completes successfully
- Position tracking works correctly
- Automatic triggering works
- Batch continuation seamless
- Multi-client synchronization works
- Cleanup works correctly
- Errors handled gracefully

## Verification

### Acceptance Criteria
- [x] Integration test file created
- [x] Batch generation test passes
- [x] Position tracking test passes
- [x] Automatic triggering test passes
- [x] Batch continuation test passes
- [x] Multi-client synchronization test passes
- [x] Cleanup test passes
- [x] Error handling test passes
- [x] All tests use real components (not excessive mocking)
- [x] Tests run in reasonable time (< 30 seconds each)
- [x] Tests are isolated and can run independently

### Definition of Done
- All acceptance criteria met
- Integration tests cover all major workflows
- Tests use real StreamManager and FFmpeg
- Tests are maintainable and well-documented
- Code follows Go testing best practices
- Ready for PBI completion

## Files Modified

### New Files Created
- `api/test/integration/batch_generation_test.go` - Integration tests for batch system
- `api/internal/streaming/manager_test_helper.go` - Test helper for triggering first batch in integration tests

### Modified Files
- `api/test/integration/channel_api_test.go` - Added timeline service parameter to SetupChannelRoutes calls

### API Specifications Updated
- None (test-only changes, no new public APIs)

## Notes

- Integration tests should use real FFmpeg (not mocked) for realistic testing
- Use short test videos to keep test execution time reasonable
- Test database should be isolated (test-specific database file)
- Batch size can be reduced in tests (e.g., 5 segments) for faster execution
- Position updates can be simulated via API calls (don't need real HLS player)
- Tests should clean up after themselves (delete test streams, segments)

