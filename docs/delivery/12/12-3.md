# [12-3] Implement position tracking API endpoint

[Back to task list](./tasks.md)

## Description

Create a new REST API endpoint `POST /api/stream/:channel_id/position` that accepts client position updates (session ID, segment number, quality) and updates the stream session's client position tracking. Return acknowledgment with current batch information. This enables the frontend to report playback position so the backend knows when to generate the next batch.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Change | InProgress | Done | Implementation complete, all tests passing | AI_Agent |

## Requirements

### Functional Requirements
- Create POST endpoint at `/api/stream/:channel_id/position`
- Accept JSON request body with session_id, segment_number, quality, timestamp
- Validate request parameters (required fields, valid segment number >= 0)
- Update client position in stream session
- Return JSON response with acknowledged status, current batch number, segments remaining
- Handle errors (invalid channel ID, stream not found, invalid request)

### Technical Requirements
- Add handler method to `api/internal/api/stream.go`
- Create UpdatePositionRequest struct for request binding
- Use Gin binding for request validation
- Integrate with StreamManager to get and update session
- Follow existing API endpoint patterns
- Return appropriate HTTP status codes

### Request Body Structure
```json
{
  "session_id": "uuid-v4-string",
  "segment_number": 42,
  "quality": "1080p",
  "timestamp": "2025-10-31T12:34:56Z"
}
```

### Response Structure
```json
{
  "acknowledged": true,
  "current_batch": 2,
  "segments_remaining": 8
}
```

## Implementation Plan

### Step 1: Define request/response structs
- Create UpdatePositionRequest struct with JSON tags
- Add validation tags (binding:"required", min=0)
- Create response struct or use gin.H

### Step 2: Add handler method
- Create UpdatePosition method on StreamHandler
- Extract channel_id from URL parameter
- Parse and validate request body
- Get stream session from StreamManager
- Update client position via session method
- Calculate current batch and segments remaining
- Return JSON response

### Step 3: Register route
- Add POST route to router in server setup
- Ensure route is registered before other stream routes (if needed)

### Step 4: Error handling
- Handle invalid channel UUID format (400)
- Handle stream not found (404)
- Handle invalid request body (400)
- Handle validation errors (400)

## Test Plan

### Objective
Verify position tracking endpoint correctly accepts updates and updates stream session state.

### Test Scope
- Request validation (required fields, segment number >= 0)
- Channel ID parsing and validation
- Stream session lookup
- Position update in session
- Response format and values
- Error cases (invalid channel, stream not found, invalid request)

### Success Criteria
- Endpoint accepts valid position updates
- Client position updated in session
- Response includes correct batch information
- Invalid requests return appropriate errors
- Stream not found returns 404
- Validation errors return 400 with clear messages

## Verification

### Acceptance Criteria
- [x] POST endpoint created at `/api/stream/:channel_id/position`
- [x] Request body validation implemented
- [x] UpdatePositionRequest struct defined
- [x] Handler updates client position in session
- [x] Response includes acknowledged, current_batch, segments_remaining
- [x] Invalid channel ID returns 400
- [x] Stream not found returns 404
- [x] Invalid request body returns 400
- [x] Integration tests pass
- [x] Code compiles without errors

### Definition of Done
- All acceptance criteria met
- Integration tests for endpoint
- Error cases covered
- Code follows Go best practices
- Ready for FFmpeg batch mode implementation

## Files Modified

### Modified Files
- `api/internal/api/stream.go` - Add UpdatePosition handler method

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document position tracking endpoint

## Notes

- Session ID should be generated by frontend (UUID v4)
- Segment number is 0-indexed
- Quality must match valid quality levels (1080p, 720p, 480p)
- Timestamp is optional but recommended for debugging
- Endpoint should be called every 5 seconds by frontend
- No authentication required (internal API, same as other stream endpoints)

