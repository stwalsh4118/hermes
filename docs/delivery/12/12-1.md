# [12-1] Add batch configuration options

[Back to task list](./tasks.md)

## Description

Add batch generation configuration options to the StreamingConfig struct, including BatchSize (number of segments per batch) and TriggerThreshold (when to trigger next batch generation). Implement validation to ensure these values are positive and TriggerThreshold is less than BatchSize. Add defaults and update config.yaml.example with documentation.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Add `BatchSize` field to StreamingConfig (default: 20 segments)
- Add `TriggerThreshold` field to StreamingConfig (default: 5 segments)
- Validate BatchSize > 0
- Validate TriggerThreshold > 0 and TriggerThreshold < BatchSize
- Update config.yaml.example with new options
- Provide clear error messages for invalid configurations

### Technical Requirements
- Extend `api/internal/config/config.go` StreamingConfig struct
- Add defaults in `setDefaults()` function
- Add validation in `Validate()` method
- Follow existing configuration patterns (Viper, env vars)
- Use constants for default values

## Implementation Plan

### Step 1: Extend StreamingConfig struct
- Add `BatchSize int` field
- Add `TriggerThreshold int` field
- Add constants for defaults: `defaultStreamingBatchSize = 20`, `defaultStreamingTriggerThreshold = 5`

### Step 2: Add defaults
- Update `setDefaults()` to set `streaming.batchsize` and `streaming.triggerthreshold`
- Ensure defaults match constants

### Step 3: Add validation
- Validate BatchSize > 0 in `Validate()` method
- Validate TriggerThreshold > 0 and TriggerThreshold < BatchSize
- Return descriptive error messages

### Step 4: Update config.yaml.example
- Add batch generation section with comments
- Document BatchSize and TriggerThreshold options
- Include example values

## Test Plan

### Objective
Verify batch configuration options are properly loaded, validated, and have correct defaults.

### Test Scope
- Configuration loading from YAML
- Configuration loading from environment variables
- Default value assignment
- Validation of invalid values
- Edge cases (zero, negative, threshold >= batch size)

### Success Criteria
- BatchSize defaults to 20 when not specified
- TriggerThreshold defaults to 5 when not specified
- Invalid BatchSize values are rejected
- Invalid TriggerThreshold values are rejected
- Configuration loads correctly from YAML and env vars

## Verification

### Acceptance Criteria
- [ ] BatchSize field added to StreamingConfig
- [ ] TriggerThreshold field added to StreamingConfig
- [ ] Default values set correctly (20 and 5)
- [ ] Validation ensures BatchSize > 0
- [ ] Validation ensures TriggerThreshold > 0
- [ ] Validation ensures TriggerThreshold < BatchSize
- [ ] config.yaml.example updated with documentation
- [ ] Error messages are clear and descriptive
- [ ] Code compiles without errors
- [ ] Unit tests pass

### Definition of Done
- All acceptance criteria met
- Unit tests for configuration loading and validation
- Documentation updated
- Code follows Go best practices
- Ready for batch state tracking implementation

## Files Modified

### Modified Files
- `api/internal/config/config.go` - Add BatchSize and TriggerThreshold fields
- `api/config.yaml.example` - Add batch generation configuration section

### API Specifications Updated
- `docs/api-specs/infrastructure/infrastructure-api.md` - Document batch configuration options

## Notes

- BatchSize of 20 segments = ~40 seconds of content at 2-second segments
- TriggerThreshold of 5 segments = ~10 seconds buffer before next batch
- These defaults balance resource efficiency with smooth playback
- Configuration changes require service restart to take effect

