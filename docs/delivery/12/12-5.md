# [12-5] Create batch coordinator

[Back to task list](./tasks.md)

## Description

Implement a batch coordinator in StreamManager that periodically monitors client positions across all active streams and triggers next batch generation when clients approach the end of the current batch. The coordinator runs as a background goroutine, checks positions every N seconds, and launches batch generation for streams that need it.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Add batchTriggerInterval field to StreamManager
- Start batch coordinator goroutine in Start() method
- Stop batch coordinator in Stop() method
- Periodically check all active streams (every 2 seconds)
- Skip streams with no active clients
- Call ShouldGenerateNextBatch for each stream
- Trigger next batch generation when threshold reached
- Handle concurrent batch generation safely

### Technical Requirements
- Add to `api/internal/streaming/manager.go`
- Use ticker for periodic checks (2 second interval)
- Use goroutine for async batch generation
- Integrate with existing StreamManager lifecycle
- Follow existing goroutine patterns (cleanup goroutine)
- Ensure thread-safe access to sessions

### Batch Coordinator Logic
- Iterate through all active sessions
- Skip if client count == 0
- Check if ShouldGenerateNextBatch returns true
- Launch generateNextBatch in goroutine if needed
- Handle errors gracefully (log, don't crash)

## Implementation Plan

### Step 1: Add batchTriggerInterval field
- Add batchTriggerInterval time.Duration to StreamManager struct
- Initialize in NewStreamManager (default: 2 seconds)
- Make configurable via config if needed

### Step 2: Add runBatchCoordinator method
- Create runBatchCoordinator method
- Create ticker with batchTriggerInterval
- Loop: select on ticker.C and stopChan
- Call checkAndTriggerBatches on each tick
- Clean up ticker on exit

### Step 3: Add checkAndTriggerBatches method
- Get all sessions from SessionManager
- Iterate through sessions
- Skip if GetClientCount() == 0
- Check ShouldGenerateNextBatch with threshold from config
- Launch generateNextBatch in goroutine if needed

### Step 4: Add generateNextBatch method stub
- Create method signature (will be fully implemented in task 12-6)
- For now, log that batch generation is needed
- Return error placeholder

### Step 5: Integrate with Start/Stop
- Call runBatchCoordinator in Start() method
- Ensure coordinator stops in Stop() method
- Wait for coordinator to finish (if needed)

## Test Plan

### Objective
Verify batch coordinator correctly monitors positions and triggers batch generation when needed.

### Test Scope
- Coordinator starts and stops correctly
- Periodic checking works (ticker-based)
- Skips streams with no clients
- Triggers generation when threshold reached
- Handles concurrent triggers safely
- Stops gracefully on shutdown

### Success Criteria
- Coordinator starts with StreamManager
- Checks positions every 2 seconds
- Skips inactive streams
- Triggers generation for streams needing batches
- Stops cleanly on shutdown
- No race conditions or deadlocks

## Verification

### Acceptance Criteria
- [ ] batchTriggerInterval field added to StreamManager
- [ ] runBatchCoordinator method implemented
- [ ] checkAndTriggerBatches method implemented
- [ ] Coordinator starts in Start() method
- [ ] Coordinator stops in Stop() method
- [ ] Periodic checking works (every 2 seconds)
- [ ] Skips streams with no clients
- [ ] Triggers generation when threshold reached
- [ ] Thread-safe concurrent access
- [ ] Unit tests pass
- [ ] Code compiles without errors

### Definition of Done
- All acceptance criteria met
- Unit tests for coordinator lifecycle
- Integration tests for triggering logic
- Code follows Go best practices
- Ready for batch continuation logic implementation

## Files Modified

### Modified Files
- `api/internal/streaming/manager.go` - Add batch coordinator

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document batch coordinator behavior

## Notes

- Coordinator interval of 2 seconds balances responsiveness with CPU usage
- Only checks streams with active clients (efficiency)
- Batch generation runs in goroutine to avoid blocking coordinator
- Coordinator should handle errors gracefully (log and continue)
- Will be extended in task 12-6 with full batch generation logic

