# [12-9] Update frontend for position reporting

[Back to task list](./tasks.md)

## Description

Add position reporting to the HLS video player component in the frontend. Implement a mechanism that periodically sends the current playback position (session ID, segment number, quality) to the backend API endpoint `/api/stream/:channel_id/position`. This enables the backend to track viewer positions and trigger batch generation as needed.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Generate or retrieve session ID (UUID v4) for each playback session
- Track current segment number from HLS player
- Detect current quality level (1080p, 720p, 480p)
- Send position updates every 5 seconds to backend API
- Handle API errors gracefully (log, don't interrupt playback)
- Stop reporting when playback stops or component unmounts

### Technical Requirements
- Modify HLS player component in `web/components/video/` or similar
- Use React useEffect hook for periodic reporting
- Use fetch or API client for HTTP requests
- Generate session ID (use crypto.randomUUID() or uuid library)
- Calculate segment number from player currentTime and segment duration
- Extract quality from current playlist URL or player state

### Position Reporting Logic
- Calculate segment number = Math.floor(currentTime / segmentDuration)
- Get quality from player (HLS.js provides this)
- Send POST request with session_id, segment_number, quality, timestamp
- Report every 5 seconds while playing
- Stop reporting on pause/stop/unmount

## Implementation Plan

### Step 1: Identify HLS player component
- Find the video player component that uses HLS.js
- Review existing player implementation
- Identify where to add position reporting

### Step 2: Add session ID management
- Generate session ID on component mount
- Store in component state or ref
- Use crypto.randomUUID() (browser API) or uuid library

### Step 3: Add position tracking
- Access HLS player instance
- Get currentTime from video element
- Calculate segment number (currentTime / segmentDuration, typically 2-6 seconds)
- Get current quality from HLS player (hls.levels, hls.currentLevel)

### Step 4: Implement periodic reporting
- Use useEffect with setInterval
- Report every 5 seconds (5000ms)
- Send POST to `/api/stream/${channelId}/position`
- Include session_id, segment_number, quality, timestamp
- Handle errors (log, don't throw)

### Step 5: Cleanup
- Clear interval on component unmount
- Stop reporting on pause/stop
- Handle player errors gracefully

## Test Plan

### Objective
Verify position reporting correctly sends updates to backend and handles errors gracefully.

### Test Scope
- Session ID generation
- Segment number calculation
- Quality detection
- Periodic reporting (every 5 seconds)
- API request format
- Error handling
- Cleanup on unmount

### Success Criteria
- Session ID generated on mount
- Segment number calculated correctly
- Quality detected correctly
- Position updates sent every 5 seconds
- API requests formatted correctly
- Errors handled gracefully
- Reporting stops on unmount

## Verification

### Acceptance Criteria
- [ ] Session ID generated for each playback session
- [ ] Current segment number calculated from player time
- [ ] Current quality detected from player
- [ ] Position updates sent every 5 seconds
- [ ] POST request to correct endpoint
- [ ] Request body includes all required fields
- [ ] Errors handled gracefully (logged, not thrown)
- [ ] Reporting stops on component unmount
- [ ] Reporting stops on playback pause/stop
- [ ] Integration tests pass (if applicable)

### Definition of Done
- All acceptance criteria met
- Position reporting works in browser
- Errors don't interrupt playback
- Code follows TypeScript/React best practices
- Ready for integration testing

## Files Modified

### Modified Files
- `web/components/video/[player-component].tsx` - Add position reporting (exact file TBD)

### API Specifications Updated
- `docs/api-specs/frontend/frontend-api.md` - Document position reporting implementation (if applicable)

## Notes

- Session ID should persist for entire playback session
- Segment duration is typically 2-6 seconds (check HLS config)
- Quality may change during adaptive bitrate streaming
- Reporting frequency of 5 seconds balances responsiveness with network usage
- Backend endpoint already implemented in task 12-3
- Position reporting is best-effort (errors shouldn't break playback)

