# [12-2] Extend StreamSession model for batch tracking

[Back to task list](./tasks.md)

## Description

Extend the StreamSession model to track batch state (batch number, segment range, video position, generation timestamps) and client positions (per session ID). Add methods to update client positions, calculate furthest position, and determine when next batch should be generated. This provides the foundation for position-aware batch generation.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Add BatchState struct to track batch information
- Add ClientPosition struct to track individual client positions
- Add CurrentBatch field to StreamSession
- Add ClientPositions map to StreamSession (key: session_id)
- Add FurthestSegment field to StreamSession
- Implement UpdateClientPosition method
- Implement GetFurthestPosition method
- Implement ShouldGenerateNextBatch method
- Implement SetCurrentBatch method
- Implement GetCurrentBatch method

### Technical Requirements
- Extend `api/internal/models/stream_session.go`
- Maintain thread safety with existing mutex
- Follow existing StreamSession patterns
- Add proper locking for concurrent access

### BatchState Fields
- BatchNumber (int) - Current batch number (0, 1, 2, ...)
- StartSegment (int) - First segment number in batch
- EndSegment (int) - Last segment number in batch
- VideoSourcePath (string) - Media file being encoded
- VideoStartOffset (int64) - Starting position in source video (seconds)
- GenerationStarted (time.Time) - When batch generation began
- GenerationEnded (time.Time) - When batch generation completed
- IsComplete (bool) - Whether batch finished generating

### ClientPosition Fields
- SessionID (string) - Client session identifier
- SegmentNumber (int) - Current segment being played
- Quality (string) - Quality level (1080p, 720p, 480p)
- LastUpdated (time.Time) - When position was last updated

## Implementation Plan

### Step 1: Define BatchState struct
- Create BatchState struct in stream_session.go
- Include all required fields with appropriate types
- Add JSON tags for serialization if needed

### Step 2: Define ClientPosition struct
- Create ClientPosition struct in stream_session.go
- Include session ID, segment number, quality, and timestamp

### Step 3: Extend StreamSession struct
- Add CurrentBatch *BatchState field
- Add ClientPositions map[string]*ClientPosition field
- Add FurthestSegment int field
- Ensure proper initialization in NewStreamSession

### Step 4: Implement UpdateClientPosition method
- Lock mutex for write access
- Update or create ClientPosition entry
- Update FurthestSegment if new position is further
- Update LastUpdated timestamp

### Step 5: Implement GetFurthestPosition method
- Lock mutex for read access
- Return FurthestSegment value

### Step 6: Implement ShouldGenerateNextBatch method
- Lock mutex for read access
- Check if CurrentBatch exists and is complete
- Calculate segments remaining (EndSegment - FurthestSegment)
- Return true if segments remaining <= threshold

### Step 7: Implement SetCurrentBatch method
- Lock mutex for write access
- Set CurrentBatch field

### Step 8: Implement GetCurrentBatch method
- Lock mutex for read access
- Return CurrentBatch field

## Test Plan

### Objective
Verify batch state tracking and client position management work correctly with proper thread safety.

### Test Scope
- BatchState creation and updates
- Client position updates
- Furthest segment tracking
- Batch generation threshold calculation
- Thread safety under concurrent access
- Edge cases (no clients, no batch, empty positions)

### Success Criteria
- BatchState can be created and updated
- Client positions are tracked per session ID
- FurthestSegment updates correctly
- ShouldGenerateNextBatch returns correct values
- Thread-safe concurrent access verified
- Methods handle nil/empty states gracefully

## Verification

### Acceptance Criteria
- [ ] BatchState struct defined with all required fields
- [ ] ClientPosition struct defined with all required fields
- [ ] StreamSession extended with batch tracking fields
- [ ] UpdateClientPosition method implemented
- [ ] GetFurthestPosition method implemented
- [ ] ShouldGenerateNextBatch method implemented
- [ ] SetCurrentBatch method implemented
- [ ] GetCurrentBatch method implemented
- [ ] Thread safety maintained with mutex
- [ ] Unit tests pass with race detector
- [ ] Code compiles without errors

### Definition of Done
- All acceptance criteria met
- Unit tests for all new methods
- Thread safety verified with race detector
- Code follows Go best practices
- Ready for position tracking API implementation

## Files Modified

### Modified Files
- `api/internal/models/stream_session.go` - Add batch tracking fields and methods

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document batch state tracking in StreamSession

## Notes

- BatchState tracks logical batch information, not file system state
- ClientPositions map allows multiple clients per stream session
- FurthestSegment ensures we generate ahead of all clients
- Thread safety critical for concurrent client position updates
- BatchNumber starts at 0 for first batch

