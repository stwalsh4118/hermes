# [12-4] Modify FFmpeg command builder for batch mode

[Back to task list](./tasks.md)

## Description

Modify the FFmpeg command builder to support batch generation mode. Remove `-stream_loop -1` flag, add segment count limiting using `-t` duration flag, and add `-ss` seek flag support for batch continuation. Update StreamParams to include BatchMode, BatchSize, and SeekSeconds fields. Ensure batch mode never uses real-time pacing.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-XX XX:XX:XX | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Change | InProgress | Done | Implementation complete, all tests passing | AI_Agent |

## Requirements

### Functional Requirements
- Add BatchMode bool field to StreamParams
- Add BatchSize int field to StreamParams
- Add SeekSeconds int64 field to StreamParams (already exists, ensure it's used correctly)
- Remove `-stream_loop -1` flag when BatchMode is true
- Add `-t` duration flag when BatchMode is true (BatchSize * SegmentDuration seconds)
- Add `-ss` seek flag before input file when SeekSeconds > 0
- Ensure BatchMode never uses `-re` flag (real-time pacing)
- Maintain backward compatibility (non-batch mode still works)

### Technical Requirements
- Modify `api/internal/streaming/ffmpeg.go`
- Update buildInputArgs function to handle seeking
- Update buildHLSArgs function to handle batch duration
- Update BuildHLSCommand to respect BatchMode
- Ensure seek is placed BEFORE input file for faster seeking
- Calculate total duration correctly (BatchSize * SegmentDuration)

## Implementation Plan

### Step 1: Extend StreamParams struct
- Add BatchMode bool field
- Add BatchSize int field
- Verify SeekSeconds int64 field exists (already present)

### Step 2: Modify buildInputArgs function
- Add `-ss` flag BEFORE `-i` when SeekSeconds > 0
- Only add `-re` flag if RealtimePacing is true AND BatchMode is false
- Remove `-stream_loop -1` when BatchMode is true

### Step 3: Modify buildHLSArgs function
- When BatchMode is true and BatchSize > 0:
  - Calculate totalSeconds = BatchSize * SegmentDuration
  - Add `-t` flag with totalSeconds value
- Keep existing HLS flags (hls_time, hls_list_size, delete_segments)

### Step 4: Update validation
- Ensure BatchSize > 0 when BatchMode is true
- Ensure SeekSeconds >= 0
- Update error messages if needed

### Step 5: Test backward compatibility
- Verify non-batch mode still works (existing behavior)
- Verify batch mode generates correct commands

## Test Plan

### Objective
Verify FFmpeg command builder correctly generates batch mode commands and maintains backward compatibility.

### Test Scope
- Batch mode command generation
- Seek flag placement (before input)
- Duration flag calculation
- Removal of stream_loop flag
- Real-time pacing exclusion in batch mode
- Backward compatibility (non-batch mode)
- Edge cases (zero batch size, zero seek)

### Success Criteria
- Batch mode generates `-t` flag with correct duration
- Seek flag appears before input file
- `-stream_loop -1` removed in batch mode
- `-re` flag excluded in batch mode
- Non-batch mode behavior unchanged
- Commands are valid FFmpeg commands

## Verification

### Acceptance Criteria
- [ ] StreamParams extended with BatchMode and BatchSize fields
- [ ] buildInputArgs adds `-ss` before `-i` when SeekSeconds > 0
- [ ] buildInputArgs removes `-stream_loop -1` when BatchMode is true
- [ ] buildInputArgs excludes `-re` when BatchMode is true
- [ ] buildHLSArgs adds `-t` flag when BatchMode is true
- [ ] Duration calculation is correct (BatchSize * SegmentDuration)
- [ ] Backward compatibility maintained
- [ ] Unit tests pass
- [ ] Code compiles without errors

### Definition of Done
- All acceptance criteria met
- Unit tests for batch mode command generation
- Unit tests for backward compatibility
- Code follows Go best practices
- Ready for batch coordinator implementation

## Files Modified

### Modified Files
- `api/internal/streaming/ffmpeg.go` - Modify command builder for batch mode

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document batch mode parameters and behavior

## Notes

- Seek flag before input (`-ss` before `-i`) is faster than after input
- Duration flag (`-t`) limits total encoding time, causing FFmpeg to exit after batch
- Removing `-stream_loop -1` prevents infinite looping
- Batch mode always uses fast encoding (no `-re` flag)
- Segment numbering continues across batches (handled by HLS segment filename pattern)

