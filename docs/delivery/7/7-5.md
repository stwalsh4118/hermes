# [7-5] Configure Zustand for client state management

[Back to task list](./tasks.md)

## Description

Install and configure Zustand v5 for client-side state management. Create stores for UI state (sidebar, modals, filters) and application state that doesn't need server synchronization. Implement proper TypeScript types and devtools integration.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-27 14:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Install Zustand v5.0.8
- Create UI state store (sidebar open/closed, active modals, etc.)
- Create filter/search state store for media and channels
- Create user preferences store (view mode, sort preferences)
- Implement persistence for user preferences
- Add Zustand devtools integration

### Technical Requirements
- Zustand v5.0.8
- Type-safe store definitions
- Middleware for persistence (localStorage)
- Middleware for devtools
- React 19 compatibility
- Proper store slicing for large stores

### State to Manage
- **UI State**: Sidebar, modals, dialogs, mobile menu
- **Filter State**: Media filters, channel filters, search queries
- **Preferences**: View mode (grid/list), sort order, theme preference backup
- **Player State**: Currently playing channel, volume, playback state

## Implementation Plan

### Step 1: Install Zustand
```bash
cd web
pnpm add zustand@5.0.8
```

### Step 2: Create UI Store
Create `lib/stores/ui-store.ts`:
```typescript
import { create } from "zustand";
import { devtools } from "zustand/middleware";

interface UIState {
  // Sidebar
  sidebarOpen: boolean;
  setSidebarOpen: (open: boolean) => void;
  toggleSidebar: () => void;

  // Mobile menu
  mobileMenuOpen: boolean;
  setMobileMenuOpen: (open: boolean) => void;
  toggleMobileMenu: () => void;

  // Modals
  activeModal: string | null;
  openModal: (modalId: string) => void;
  closeModal: () => void;

  // Loading states
  isLoading: boolean;
  setLoading: (loading: boolean) => void;
}

export const useUIStore = create<UIState>()(
  devtools(
    (set) => ({
      // Sidebar state
      sidebarOpen: true,
      setSidebarOpen: (open) => set({ sidebarOpen: open }),
      toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),

      // Mobile menu state
      mobileMenuOpen: false,
      setMobileMenuOpen: (open) => set({ mobileMenuOpen: open }),
      toggleMobileMenu: () => set((state) => ({ mobileMenuOpen: !state.mobileMenuOpen })),

      // Modal state
      activeModal: null,
      openModal: (modalId) => set({ activeModal: modalId }),
      closeModal: () => set({ activeModal: null }),

      // Loading state
      isLoading: false,
      setLoading: (loading) => set({ isLoading: loading }),
    }),
    { name: "ui-store" }
  )
);
```

### Step 3: Create Filter Store
Create `lib/stores/filter-store.ts`:
```typescript
import { create } from "zustand";
import { devtools, persist } from "zustand/middleware";

interface FilterState {
  // Media filters
  mediaSearch: string;
  mediaShowFilter: string | null;
  setMediaSearch: (search: string) => void;
  setMediaShowFilter: (show: string | null) => void;
  clearMediaFilters: () => void;

  // Channel filters
  channelSearch: string;
  setChannelSearch: (search: string) => void;
  clearChannelFilters: () => void;
}

export const useFilterStore = create<FilterState>()(
  devtools(
    persist(
      (set) => ({
        // Media filters
        mediaSearch: "",
        mediaShowFilter: null,
        setMediaSearch: (search) => set({ mediaSearch: search }),
        setMediaShowFilter: (show) => set({ mediaShowFilter: show }),
        clearMediaFilters: () => set({ mediaSearch: "", mediaShowFilter: null }),

        // Channel filters
        channelSearch: "",
        setChannelSearch: (search) => set({ channelSearch: search }),
        clearChannelFilters: () => set({ channelSearch: "" }),
      }),
      {
        name: "filter-storage",
        partialize: (state) => ({
          // Don't persist search queries, only filters
          mediaShowFilter: state.mediaShowFilter,
        }),
      }
    ),
    { name: "filter-store" }
  )
);
```

### Step 4: Create Preferences Store
Create `lib/stores/preferences-store.ts`:
```typescript
import { create } from "zustand";
import { devtools, persist } from "zustand/middleware";

type ViewMode = "grid" | "list";
type SortOrder = "name" | "date" | "duration";

interface PreferencesState {
  // View preferences
  mediaViewMode: ViewMode;
  channelViewMode: ViewMode;
  setMediaViewMode: (mode: ViewMode) => void;
  setChannelViewMode: (mode: ViewMode) => void;

  // Sort preferences
  mediaSortOrder: SortOrder;
  channelSortOrder: SortOrder;
  setMediaSortOrder: (order: SortOrder) => void;
  setChannelSortOrder: (order: SortOrder) => void;

  // Player preferences
  defaultVolume: number;
  setDefaultVolume: (volume: number) => void;

  // Reset
  resetPreferences: () => void;
}

const defaultState = {
  mediaViewMode: "grid" as ViewMode,
  channelViewMode: "grid" as ViewMode,
  mediaSortOrder: "name" as SortOrder,
  channelSortOrder: "name" as SortOrder,
  defaultVolume: 80,
};

export const usePreferencesStore = create<PreferencesState>()(
  devtools(
    persist(
      (set) => ({
        ...defaultState,

        setMediaViewMode: (mode) => set({ mediaViewMode: mode }),
        setChannelViewMode: (mode) => set({ channelViewMode: mode }),
        setMediaSortOrder: (order) => set({ mediaSortOrder: order }),
        setChannelSortOrder: (order) => set({ channelSortOrder: order }),
        setDefaultVolume: (volume) => set({ defaultVolume: volume }),
        resetPreferences: () => set(defaultState),
      }),
      {
        name: "preferences-storage",
      }
    ),
    { name: "preferences-store" }
  )
);
```

### Step 5: Create Player Store
Create `lib/stores/player-store.ts`:
```typescript
import { create } from "zustand";
import { devtools } from "zustand/middleware";

interface PlayerState {
  // Current playback
  currentChannelId: string | null;
  isPlaying: boolean;
  volume: number;
  isMuted: boolean;

  // Actions
  setCurrentChannel: (channelId: string | null) => void;
  setPlaying: (playing: boolean) => void;
  setVolume: (volume: number) => void;
  setMuted: (muted: boolean) => void;
  toggleMute: () => void;
  
  // Player controls
  play: (channelId: string) => void;
  pause: () => void;
  stop: () => void;
}

export const usePlayerStore = create<PlayerState>()(
  devtools(
    (set, get) => ({
      // Initial state
      currentChannelId: null,
      isPlaying: false,
      volume: 80,
      isMuted: false,

      // Setters
      setCurrentChannel: (channelId) => set({ currentChannelId: channelId }),
      setPlaying: (playing) => set({ isPlaying: playing }),
      setVolume: (volume) => set({ volume, isMuted: false }),
      setMuted: (muted) => set({ isMuted: muted }),
      toggleMute: () => set((state) => ({ isMuted: !state.isMuted })),

      // Player controls
      play: (channelId) => set({ currentChannelId: channelId, isPlaying: true }),
      pause: () => set({ isPlaying: false }),
      stop: () => set({ currentChannelId: null, isPlaying: false }),
    }),
    { name: "player-store" }
  )
);
```

### Step 6: Create Store Hook Exports
Create `lib/stores/index.ts`:
```typescript
export { useUIStore } from "./ui-store";
export { useFilterStore } from "./filter-store";
export { usePreferencesStore } from "./preferences-store";
export { usePlayerStore } from "./player-store";

export type { ViewMode, SortOrder } from "./preferences-store";
```

### Step 7: Create Store Demo Page
Create `app/stores-test/page.tsx`:
```typescript
"use client";

import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Separator } from "@/components/ui/separator";
import {
  useUIStore,
  useFilterStore,
  usePreferencesStore,
  usePlayerStore,
} from "@/lib/stores";

export default function StoresTestPage() {
  // UI Store
  const { sidebarOpen, toggleSidebar, activeModal, openModal, closeModal } = useUIStore();

  // Filter Store
  const { mediaSearch, setMediaSearch, clearMediaFilters } = useFilterStore();

  // Preferences Store
  const { mediaViewMode, setMediaViewMode, resetPreferences } = usePreferencesStore();

  // Player Store
  const { currentChannelId, isPlaying, volume, setVolume, play, pause } = usePlayerStore();

  return (
    <div className="container mx-auto py-10 space-y-8">
      <div>
        <h1 className="text-4xl font-bold mb-2">Zustand Stores Test</h1>
        <p className="text-muted-foreground">Testing client state management</p>
      </div>

      <Separator />

      <Card>
        <CardHeader>
          <CardTitle>UI Store</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <p>Sidebar Open: {sidebarOpen ? "Yes" : "No"}</p>
            <Button onClick={toggleSidebar}>Toggle Sidebar</Button>
          </div>
          <div>
            <p>Active Modal: {activeModal || "None"}</p>
            <div className="flex gap-2">
              <Button onClick={() => openModal("test-modal")}>Open Modal</Button>
              <Button variant="secondary" onClick={closeModal}>
                Close Modal
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Filter Store</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label>Media Search</Label>
            <Input
              value={mediaSearch}
              onChange={(e) => setMediaSearch(e.target.value)}
              placeholder="Search media..."
            />
            <p className="text-sm text-muted-foreground mt-2">
              Current search: {mediaSearch || "(empty)"}
            </p>
          </div>
          <Button variant="secondary" onClick={clearMediaFilters}>
            Clear Filters
          </Button>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Preferences Store (Persisted)</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <p>Media View Mode: {mediaViewMode}</p>
            <div className="flex gap-2">
              <Button
                variant={mediaViewMode === "grid" ? "default" : "secondary"}
                onClick={() => setMediaViewMode("grid")}
              >
                Grid
              </Button>
              <Button
                variant={mediaViewMode === "list" ? "default" : "secondary"}
                onClick={() => setMediaViewMode("list")}
              >
                List
              </Button>
            </div>
          </div>
          <Button variant="destructive" onClick={resetPreferences}>
            Reset All Preferences
          </Button>
          <p className="text-sm text-muted-foreground">
            Refresh the page - your preferences will persist!
          </p>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Player Store</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <p>Current Channel: {currentChannelId || "None"}</p>
            <p>Playing: {isPlaying ? "Yes" : "No"}</p>
            <p>Volume: {volume}%</p>
          </div>
          <div className="flex gap-2">
            <Button onClick={() => play("channel-123")}>Play Channel</Button>
            <Button variant="secondary" onClick={pause}>
              Pause
            </Button>
          </div>
          <div>
            <Label>Volume</Label>
            <Input
              type="range"
              min="0"
              max="100"
              value={volume}
              onChange={(e) => setVolume(Number(e.target.value))}
            />
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Step 8: Add Zustand Devtools Setup
The devtools middleware is already configured, but ensure Redux DevTools extension is installed in browser for debugging.

### Step 9: Test Store Functionality
- Visit `/stores-test` page
- Test each store's functionality
- Verify state updates correctly
- Refresh page to test persistence
- Open Redux DevTools to inspect store state

### Step 10: Verify TypeScript Types
```bash
cd web
pnpm type-check
```

## Test Plan

### Success Criteria
1. All stores are type-safe
2. UI state updates correctly
3. Filter state works
4. Preferences persist across page reloads
5. Player state manages playback
6. Redux DevTools show store state
7. No memory leaks from store subscriptions

### Manual Testing
1. **UI Store**
   - Toggle sidebar
   - Open/close modals
   - Verify state changes

2. **Filter Store**
   - Type in search
   - Clear filters
   - Verify state updates

3. **Preferences Store**
   - Change view mode
   - Refresh page
   - Verify preferences persist

4. **Player Store**
   - Play a channel
   - Adjust volume
   - Pause playback
   - Verify state updates

5. **DevTools**
   - Open Redux DevTools
   - Verify all stores visible
   - Check action history
   - Inspect state structure

## Verification

### Acceptance Criteria
- [ ] Zustand v5.0.8 installed
- [ ] UI store created with sidebar, modal, and loading state
- [ ] Filter store created for media and channel filters
- [ ] Preferences store created with persistence
- [ ] Player store created for playback state
- [ ] All stores use TypeScript types
- [ ] Devtools middleware configured
- [ ] Persist middleware configured for preferences
- [ ] Store exports centralized in index.ts
- [ ] Test page created at /stores-test
- [ ] Sidebar state works
- [ ] Modal state works
- [ ] Filter state works
- [ ] Preferences persist across reloads
- [ ] Player state works
- [ ] Redux DevTools integration works
- [ ] No TypeScript errors
- [ ] No React hydration warnings

### Definition of Done
- All acceptance criteria met
- All stores function correctly
- Persistence works as expected
- Type safety maintained
- DevTools show proper store names and actions
- Code follows Zustand best practices

## Files Modified

### New Files Created
- `lib/stores/ui-store.ts` - UI state management
- `lib/stores/filter-store.ts` - Filter state management
- `lib/stores/preferences-store.ts` - User preferences with persistence
- `lib/stores/player-store.ts` - Player state management
- `lib/stores/index.ts` - Store exports
- `app/stores-test/page.tsx` - Store testing page

### Files Modified
- `package.json` - Added Zustand dependency

## Notes

- Zustand v5 is compatible with React 19
- Persist middleware uses localStorage by default
- Devtools middleware requires Redux DevTools browser extension
- Store subscriptions are automatically cleaned up by React
- Zustand is lighter than Redux and easier to use
- Stores can be used in both client and server components (with proper "use client" directives)
- The partialize option in persist middleware allows selecting which state to persist
- Player store does NOT persist to avoid resuming playback unexpectedly
- Filter search queries are NOT persisted (only filters like show names)
- Stores follow single-responsibility principle (separate concerns)

