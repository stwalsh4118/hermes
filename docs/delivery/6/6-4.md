# [6-4] HLS Playlist Generator

[Back to task list](./tasks.md)

## Description

Implement HLS playlist generation for HTTP Live Streaming. This includes creating master playlists that list available quality variants and media playlists for each quality level that reference video segments. Playlists must update dynamically as FFmpeg generates new segments, support proper HLS specifications, and enable adaptive bitrate streaming for clients. This task focuses on playlist file generation and management, not segment generation (which FFmpeg handles).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-30 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Generate master playlist (.m3u8) listing all quality variants
- Generate media playlists for each quality level (1080p, 720p, 480p)
- Support both live streaming and VOD playlist types
- Update playlists as new segments become available
- Handle segment expiration and cleanup
- Support proper HLS tags and specifications (RFC 8216)
- Provide absolute and relative URL support
- Handle playlist versioning

### Technical Requirements
- Create `api/internal/streaming/playlist.go`
- Generate HLS-compliant .m3u8 files
- Support concurrent playlist generation for multiple streams
- No direct FFmpeg interaction (FFmpeg generates segments, we generate playlists)
- File I/O for writing playlist files
- Directory watching for new segments (optional approach)

### HLS Playlist Format

**Master Playlist Structure:**
```m3u8
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-STREAM-INF:BANDWIDTH=5000000,RESOLUTION=1920x1080
1080p.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=3000000,RESOLUTION=1280x720
720p.m3u8
#EXT-X-STREAM-INF:BANDWIDTH=1500000,RESOLUTION=854x480
480p.m3u8
```

**Media Playlist Structure (Event Type - Live):**
```m3u8
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:6.0,
segment_000.ts
#EXTINF:6.0,
segment_001.ts
#EXTINF:6.0,
segment_002.ts
```

## Implementation Plan

### Step 1: Define playlist types and structs
```go
type MasterPlaylist struct {
    Variants []PlaylistVariant
}

type PlaylistVariant struct {
    Bandwidth  int
    Resolution string
    Path       string // Relative path to media playlist
}

type MediaPlaylist struct {
    TargetDuration int
    MediaSequence  int
    Segments       []Segment
    PlaylistType   string // "EVENT" or "VOD"
}

type Segment struct {
    Duration float64
    Path     string
}
```

### Step 2: Implement master playlist generation
- `GenerateMasterPlaylist(variants []PlaylistVariant) (string, error)`
- Format with proper HLS tags
- Calculate bandwidth from quality settings
- Generate relative paths to media playlists
- Write to master.m3u8 file

### Step 3: Implement media playlist generation
- `GenerateMediaPlaylist(segments []Segment, config PlaylistConfig) (string, error)`
- Include all required HLS tags
- Support sliding window (keep N most recent segments)
- Calculate target duration from segments
- Track media sequence number
- Support both EVENT and VOD types

### Step 4: Implement segment discovery
- `DiscoverSegments(directory string) ([]Segment, error)`
- Scan directory for .ts files
- Parse segment filenames to determine sequence
- Extract duration from segment files if needed
- Sort segments by sequence number

### Step 5: Implement playlist update logic
- `UpdatePlaylist(channelID uuid.UUID, quality string) error`
- Check for new segments since last update
- Append new segments to media playlist
- Remove expired segments if needed
- Write updated playlist atomically (temp file + rename)

### Step 6: Add playlist validation
- `ValidateMasterPlaylist(content string) error`
- `ValidateMediaPlaylist(content string) error`
- Check for required HLS tags
- Validate format compliance
- Useful for testing and debugging

## Test Plan

### Objective
Verify HLS playlist generation produces spec-compliant playlists that clients can parse and use for streaming.

### Test Scope
- Master playlist generation with multiple variants
- Media playlist generation with various segment counts
- Playlist updates with new segments
- Segment discovery from directories
- Playlist validation
- Concurrent playlist generation

### Key Test Scenarios

**Unit Tests:**
1. **Master playlist generation** - Three variants with correct tags
2. **Media playlist with segments** - Proper formatting and sequence
3. **Empty media playlist** - Valid playlist with no segments yet
4. **Playlist update** - New segment appended correctly
5. **Sliding window** - Old segments removed when limit reached
6. **Segment discovery** - Files correctly parsed and sorted
7. **Concurrent generation** - Multiple playlists for different channels
8. **Validation** - Detect malformed playlists

**Integration Tests:**
- Write playlists to disk and read back
- Verify file permissions and atomicity
- Test with actual segment files from FFmpeg

### Success Criteria
- Generated playlists are HLS-compliant
- Clients can parse and use the playlists
- Updates are atomic (no partial writes)
- Concurrent operations are thread-safe
- Validation catches malformed playlists
- Performance is acceptable (<10ms for typical playlist)

## Verification

### Acceptance Criteria
- [ ] Master playlist generation works for all quality variants
- [ ] Media playlist generation includes all required HLS tags
- [ ] Playlist updates append new segments correctly
- [ ] Sliding window removes old segments when needed
- [ ] Segment discovery correctly identifies and sorts segments
- [ ] Playlist writes are atomic (no corruption risk)
- [ ] Concurrent playlist generation is thread-safe
- [ ] Playlists are HLS RFC 8216 compliant
- [ ] Validation functions detect malformed playlists
- [ ] Unit test coverage >85%
- [ ] Code compiles without errors
- [ ] No linter warnings

### Definition of Done
- All acceptance criteria met
- Unit tests for all functions
- Integration tests with file I/O
- Playlists validated with HLS tools (optional: ffprobe, hlsvalidator)
- Code follows Go best practices
- Ready for integration with Stream Manager

## Files Modified

### New Files Created
- `api/internal/streaming/playlist.go` - HLS playlist generation and management
- `api/internal/streaming/playlist_test.go` - Unit and integration tests

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document playlist structure and generation

## Notes

- FFmpeg generates the segments, we generate the playlists
- Playlist updates must be atomic to prevent clients reading partial files
- Use temp file + rename pattern for atomic writes
- Media sequence numbers must monotonically increase
- Target duration should be ceiling of max segment duration
- Consider supporting both EXT-X-PLAYLIST-TYPE:EVENT and VOD
- EVENT type for live streaming, VOD for completed content
- Sliding window size should match HLS config (default 10 segments)
- Playlists should be UTF-8 encoded
- Line endings should be LF (not CRLF)
- Consider caching parsed playlists to avoid repeated file I/O
- Future: Support for discontinuities when switching source files
- Future: Support for EXT-X-PROGRAM-DATE-TIME for seeking

