# [6-7] Stream REST Endpoints

[Back to task list](./tasks.md)

## Description

Implement HTTP REST endpoints that expose HLS streaming functionality to clients. This includes endpoints for master playlists, media playlists for each quality level, and video segments. The endpoints handle client registration/unregistration, serve static HLS files, and coordinate with the Stream Manager to manage stream lifecycle. These are the public-facing APIs that video players will use to access streams.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-30 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Serve master playlist for channel
- Serve media playlists for each quality variant
- Serve video segment files
- Register client when accessing stream
- Update last access time on playlist requests
- Handle CORS for browser access
- Set appropriate content types and caching headers
- Support range requests for segments (optional)

### Technical Requirements
- Create `api/internal/api/stream.go`
- Use Gin framework (existing pattern)
- Integrate with Stream Manager (task 6-5)
- Serve files from segment storage directory
- Follow existing API patterns (health, media, channel)
- Add to server route setup

### Endpoint Specifications

**GET /stream/:channel_id/master.m3u8**
- Returns master playlist listing all quality variants
- Registers client with Stream Manager
- Starts stream if not already active
- Content-Type: application/vnd.apple.mpegurl

**GET /stream/:channel_id/:quality.m3u8**
- Returns media playlist for specific quality (1080p, 720p, 480p)
- Updates client last access time
- Content-Type: application/vnd.apple.mpegurl

**GET /stream/:channel_id/:quality/:segment.ts**
- Returns video segment file
- Updates client last access time
- Content-Type: video/MP2T
- Supports range requests (optional)

**DELETE /stream/:channel_id/client**
- Explicitly unregister client from stream
- Decrements client count
- Optional endpoint for cleanup

## Implementation Plan

### Step 1: Create streaming API handler
- Create `api/internal/api/stream.go`
- Define handler struct with Stream Manager dependency
- Follow existing handler patterns

### Step 2: Implement master playlist endpoint
```go
func (h *StreamHandler) GetMasterPlaylist(c *gin.Context)
```

Steps:
1. Parse channel ID from URL parameter
2. Validate channel ID is valid UUID
3. Call StreamManager.RegisterClient(channelID)
4. Read master.m3u8 file from stream directory
5. Set appropriate headers (Content-Type, Cache-Control)
6. Return file content
7. Handle errors (channel not found, stream failed, etc.)

### Step 3: Implement media playlist endpoint
```go
func (h *StreamHandler) GetMediaPlaylist(c *gin.Context)
```

Steps:
1. Parse channel ID and quality from URL
2. Validate parameters (UUID, quality in [1080p, 720p, 480p])
3. Get stream session from StreamManager
4. Update last access time
5. Read quality-specific .m3u8 file
6. Set headers (no caching for live playlists)
7. Return file content

### Step 4: Implement segment endpoint
```go
func (h *StreamHandler) GetSegment(c *gin.Context)
```

Steps:
1. Parse channel ID, quality, and segment name
2. Validate parameters
3. Get stream session from StreamManager
4. Update last access time
5. Build file path to segment
6. Serve file with appropriate headers
7. Optional: Handle range requests for seeking

### Step 5: Implement client unregister endpoint
```go
func (h *StreamHandler) UnregisterClient(c *gin.Context)
```

Steps:
1. Parse channel ID
2. Call StreamManager.UnregisterClient(channelID)
3. Return success response

### Step 6: Add route registration
- Add SetupStreamRoutes function
- Register all endpoints with Gin router
- Add to server.go route setup
- Consider using separate router group `/stream`

### Step 7: Add middleware and headers
- Set appropriate Content-Type headers
- Add Cache-Control headers (vary by file type)
- Enable CORS for browser access
- Add request logging (use existing middleware)

### Step 8: Add error handling
- 400 Bad Request - Invalid parameters
- 404 Not Found - Channel doesn't exist or segment not found
- 409 Conflict - Stream failed to start (timeline errors)
- 500 Internal Server Error - Stream manager errors
- Consistent error response format

## Test Plan

### Objective
Verify streaming endpoints correctly serve HLS content and integrate with Stream Manager.

### Test Scope
- All endpoint responses with valid parameters
- Error handling for invalid parameters
- Client registration and unregistration
- File serving with correct headers
- Integration with Stream Manager
- CORS and caching headers

### Key Test Scenarios

**Unit Tests (with mocks):**
1. **Master playlist request** - Returns file, registers client
2. **Media playlist request** - Returns correct quality variant
3. **Segment request** - Serves video segment file
4. **Invalid channel ID** - Returns 400 Bad Request
5. **Channel not found** - Returns 404 Not Found
6. **Invalid quality** - Returns 400 Bad Request
7. **Missing segment** - Returns 404 Not Found
8. **Client unregister** - Decrements count successfully

**Integration Tests:**
1. **Full stream flow** - Master → Media → Segments
2. **Multiple concurrent clients** - Same channel
3. **Different quality requests** - All variants served
4. **Client cleanup** - Unregister and grace period
5. **CORS headers** - Cross-origin requests work

**Manual Tests:**
- Test with actual video player (VLC, HLS.js)
- Verify adaptive bitrate switching works
- Test on different browsers
- Verify mobile compatibility

### Success Criteria
- All endpoints return correct content types
- Files are served correctly
- Client registration/unregistration works
- Headers enable browser playback
- CORS works for web clients
- Error responses are consistent
- Integration with Stream Manager correct

## Verification

### Acceptance Criteria
- [ ] Master playlist endpoint returns master.m3u8
- [ ] Media playlist endpoints return quality-specific playlists
- [ ] Segment endpoint serves .ts files
- [ ] Client registration increments stream client count
- [ ] Client unregistration decrements count
- [ ] Last access time updates on requests
- [ ] Content-Type headers are correct
- [ ] Cache-Control headers appropriate for file type
- [ ] CORS headers enable browser access
- [ ] Error responses follow project conventions
- [ ] Invalid parameters return 400 Bad Request
- [ ] Missing resources return 404 Not Found
- [ ] Stream failures return appropriate errors
- [ ] Routes registered in server setup
- [ ] Integration tests with Stream Manager pass
- [ ] Manual playback testing successful
- [ ] Code compiles without errors
- [ ] No linter warnings

### Definition of Done
- All acceptance criteria met
- Unit tests for all handlers
- Integration tests with Stream Manager
- Manual testing with video players
- CORS and headers verified
- Code follows Go best practices
- API documentation complete
- Ready for frontend integration

## Files Modified

### New Files Created
- `api/internal/api/stream.go` - Streaming endpoint handlers
- `api/internal/api/stream_test.go` - Endpoint tests

### Modified Files
- `api/internal/server/server.go` - Add Stream Manager, register stream routes

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Complete REST endpoint documentation

## Notes

- These endpoints are accessed by video players, not typical REST clients
- HLS clients make many requests (playlist updates every few seconds)
- Master playlist rarely changes, can be cached
- Media playlists should not be cached (live content)
- Segments can be cached once generated
- CORS is essential for browser-based players
- Consider rate limiting for segment requests (optional)
- Client registration on master playlist request starts stream
- Subsequent requests just update last access time
- Explicit unregister endpoint optional (cleanup handles automatic expiration)
- Range requests useful for seeking but optional for MVP
- Consider serving from memory for hot segments (optimization)
- Error responses should be HLS-friendly (some players sensitive to errors)
- Test with multiple player implementations (HLS.js, Video.js, native)
- Security consideration: Validate file paths to prevent directory traversal
- Future: Authentication and authorization for streams
- Future: Analytics and metrics collection

