# [6-1] Hardware Acceleration Detection & Configuration

[Back to task list](./tasks.md)

## Description

Implement hardware acceleration detection to identify available GPU encoders (NVENC, QSV, VAAPI, VideoToolbox) on the system. Extend the configuration system to include streaming-related settings including hardware acceleration selection, quality presets, and segment storage paths. This foundational task enables the streaming engine to leverage hardware encoders when available while providing graceful fallback to software encoding.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-30 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Detect available hardware encoders on system startup
- Probe FFmpeg for supported hardware acceleration methods
- Extend Config struct with streaming-related configuration
- Support configuration via YAML file and environment variables
- Validate hardware acceleration selections
- Provide reasonable defaults for all streaming settings

### Technical Requirements
- Create `api/internal/streaming/hardware.go` for detection logic
- Extend `api/internal/config/config.go` with StreamingConfig struct
- Follow existing configuration patterns (Viper, env vars with HERMES_ prefix)
- Use `os/exec` to probe FFmpeg capabilities (similar to FFprobe integration)
- Add logging for detected hardware capabilities

### Streaming Configuration Fields
- `HardwareAccel` - Selected hardware acceleration method (none, nvenc, qsv, vaapi, videotoolbox, auto)
- `SegmentDuration` - HLS segment duration in seconds (default: 6)
- `PlaylistSize` - Number of segments to keep in playlist (default: 10)
- `SegmentPath` - Directory for storing stream segments (default: ./data/streams)
- `GracePeriodSeconds` - Time to keep stream alive after last client disconnects (default: 30)
- `CleanupInterval` - How often to cleanup old segments in seconds (default: 60)

### Hardware Acceleration Types
- **none** - Software encoding only (always available)
- **nvenc** - NVIDIA GPU encoding (GeForce/Quadro)
- **qsv** - Intel Quick Sync Video
- **vaapi** - Video Acceleration API (AMD/Intel on Linux)
- **videotoolbox** - Apple hardware encoding (macOS)
- **auto** - Automatically detect and use best available

## Implementation Plan

### Step 1: Create streaming package structure
- Create directory `api/internal/streaming/`
- Create `hardware.go` file for detection logic

### Step 2: Implement hardware detection functions
- `CheckFFmpegInstalled() error` - Verify FFmpeg is available
- `DetectHardwareEncoders(ctx context.Context) ([]string, error)` - Probe available encoders
- `ValidateHardwareAccel(method string) error` - Validate configuration selection
- Use `ffmpeg -encoders` command to list available encoders
- Parse output to identify h264_nvenc, h264_qsv, h264_vaapi, h264_videotoolbox

### Step 3: Extend configuration system
- Add `StreamingConfig` struct to `internal/config/config.go`
- Add streaming defaults to `setDefaults()` function
- Add validation rules to `Validate()` method
- Ensure hardware accel setting matches detected capabilities or is "auto"/"none"

### Step 4: Add configuration documentation
- Update config.yaml.example with streaming section
- Document all streaming configuration options
- Include hardware acceleration options and recommendations

### Step 5: Add logging
- Log detected hardware capabilities on startup
- Log selected hardware acceleration method
- Warn if selected method is not available (fallback to software)

## Test Plan

### Objective
Verify hardware detection works correctly and configuration system properly extends with streaming settings.

### Test Scope
- Hardware detection on different systems (NVIDIA, Intel, AMD, macOS, software-only)
- Configuration loading from YAML and environment variables
- Validation of hardware acceleration settings
- Fallback behavior when hardware unavailable

### Success Criteria
- FFmpeg installation check works correctly
- Hardware encoder detection identifies available encoders
- Configuration loads streaming settings with defaults
- Invalid hardware acceleration selections are rejected
- "auto" selection chooses best available encoder
- Fallback to software encoding when hardware unavailable

## Verification

### Acceptance Criteria
- [ ] Hardware detection function identifies available encoders
- [ ] StreamingConfig struct added to config package
- [ ] Configuration loads from YAML and environment variables
- [ ] Defaults are reasonable for all streaming settings
- [ ] Validation rejects invalid hardware acceleration values
- [ ] "auto" mode selects best available hardware encoder
- [ ] Graceful fallback to "none" when selected hardware unavailable
- [ ] Logging provides clear information about detected capabilities
- [ ] Code compiles without errors
- [ ] No linter warnings

### Definition of Done
- All acceptance criteria met
- Unit tests for hardware detection
- Unit tests for configuration validation
- Documentation updated (config.yaml.example)
- Code follows Go best practices
- Ready for integration with FFmpeg command builder

## Files Modified

### New Files Created
- `api/internal/streaming/hardware.go` - Hardware detection and validation
- `api/internal/streaming/hardware_test.go` - Hardware detection tests

### Modified Files
- `api/internal/config/config.go` - Extended with StreamingConfig
- `api/config.yaml.example` - Add streaming configuration section

### API Specifications Updated
- `docs/api-specs/infrastructure/infrastructure-api.md` - Document streaming configuration

## Notes

- Hardware detection should be fast (< 1 second) to avoid slowing startup
- Detection failures should not prevent application startup
- Consider caching detection results to avoid repeated FFmpeg calls
- "auto" mode priority: nvenc > qsv > videotoolbox > vaapi > none
- This task has no database dependencies - purely configuration and detection
- Hardware capabilities may change between restarts (driver updates, hardware changes)

