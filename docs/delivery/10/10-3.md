# [10-3] Core HLS Video Player Component

[Back to task list](./tasks.md)

## Description

Build the foundational video player component that handles HLS stream playback using HLS.js for most browsers and native HLS for Safari. This component manages the video element, HLS instance lifecycle, stream loading, playback state, and provides the foundation for custom controls and error handling.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-31 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-31 15:00:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-10-31 15:30:00 | Status Update | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2025-10-31 16:50:00 | Status Update | Review | Review | Integrated VideoPlayer into channel player page | AI_Agent |

## Requirements

### Functional Requirements
- Initialize HLS.js for non-Safari browsers
- Use native HLS playback for Safari
- Load HLS stream from `/api/stream/${channelId}/master.m3u8`
- Auto-play stream on load
- Maintain 16:9 aspect ratio
- Clean up HLS instance on unmount
- Expose video ref for controls integration
- Handle play/pause state

### Technical Requirements
- Create `web/components/video/video-player.tsx`
- Use React hooks (useRef, useEffect, useState)
- Proper HLS.js initialization and teardown
- Type-safe with TypeScript
- Detect browser HLS support
- Forward ref for parent component access

## Implementation Plan

### Step 1: Create video player component file
```
web/components/video/video-player.tsx
```

### Step 2: Implement HLS.js detection and initialization
```typescript
useEffect(() => {
  const video = videoRef.current;
  if (!video) return;

  if (Hls.isSupported()) {
    const hls = new Hls({
      enableWorker: true,
      lowLatencyMode: false,
    });
    
    hls.loadSource(streamUrl);
    hls.attachMedia(video);
    
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play();
    });
    
    hlsRef.current = hls;
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    // Safari native HLS
    video.src = streamUrl;
    video.play();
  }

  return () => {
    hlsRef.current?.destroy();
  };
}, [streamUrl]);
```

### Step 3: Implement video element with proper styling
- 16:9 aspect ratio container
- Full width responsive
- Dark background
- Smooth loading transition

### Step 4: Add loading state
- Show spinner while stream initializes
- Hide spinner on MANIFEST_PARSED event

### Step 5: Expose video ref for controls
- Use forwardRef to expose video element
- Allow parent components to control playback

## Test Plan

### Objective
Verify the video player correctly initializes HLS playback and handles both HLS.js and native Safari scenarios.

### Test Scope
- HLS.js initialization in Chrome/Firefox/Edge
- Native HLS playback in Safari
- Stream loading and auto-play
- Cleanup on unmount
- Aspect ratio maintenance
- Loading states

### Success Criteria
- Stream loads and plays automatically
- HLS.js used for non-Safari browsers
- Native HLS used for Safari
- 16:9 aspect ratio maintained
- No memory leaks on unmount
- Loading indicator shows during initialization
- Video fills container width

## Verification

### Acceptance Criteria
- [x] Component created at `web/components/video/video-player.tsx`
- [x] HLS.js initialization implemented
- [x] Safari native HLS fallback implemented
- [x] Stream URL constructed correctly
- [x] Auto-play on load works
- [x] 16:9 aspect ratio enforced
- [x] Loading state displayed
- [x] HLS instance destroyed on unmount
- [x] TypeScript types correct
- [x] Video ref exposed for controls
- [x] No console errors during playback

### Definition of Done
- All acceptance criteria met
- Component renders without errors
- Stream plays successfully in all browsers
- Ready for custom controls integration

## Files Modified

### New Files Created
- `web/components/video/video-player.tsx` - Core HLS video player
- `web/components/video/index.ts` - Barrel export (created or updated)

### Modified Files
- `web/app/channels/[id]/page.tsx` - Integrated VideoPlayer component into channel player page

### API Specifications Updated
- `docs/api-specs/frontend/frontend-api.md` - Document VideoPlayer component

## Notes

- Stream URL format: `${apiUrl}/api/stream/${channelId}/master.m3u8`
- HLS.js config: enable worker for better performance, disable lowLatencyMode for VOD-like experience
- Safari detection: `video.canPlayType('application/vnd.apple.mpegurl')`
- HLS.js events: MANIFEST_PARSED, ERROR, LEVEL_LOADED
- Consider adding bandwidth/quality change events for future stats
- Video element should have `playsInline` attribute for mobile


