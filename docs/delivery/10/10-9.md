# [10-9] Error Handling & Auto-Reconnect

[Back to task list](./tasks.md)

## Description

Implement comprehensive error handling with graceful recovery for the video player. Handle network errors, stream unavailability, browser compatibility issues, and HLS.js errors with user-friendly messages and automatic retry logic with exponential backoff.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-31 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Network error: "Connection lost, retrying..." + auto-retry
- Stream unavailable: "Stream temporarily unavailable"
- Browser not supported: "Please use a modern browser"
- HLS.js error handling with automatic recovery
- Loading spinner during stream initialization
- Error boundary for player component
- Retry logic with exponential backoff
- User-friendly error messages with retro styling

### Technical Requirements
- Integrate HLS.js error events
- Implement retry counter and backoff calculation
- Use React Error Boundary
- Proper error state management
- Accessible error messages
- Recovery attempt limits (max 3-5 retries)

## Implementation Plan

### Step 1: Implement HLS.js error handling
```typescript
hls.on(Hls.Events.ERROR, (event, data) => {
  console.error('HLS error:', data);
  
  if (data.fatal) {
    switch (data.type) {
      case Hls.ErrorTypes.NETWORK_ERROR:
        handleNetworkError(data);
        break;
      case Hls.ErrorTypes.MEDIA_ERROR:
        handleMediaError(data);
        break;
      default:
        handleFatalError(data);
        break;
    }
  }
});
```

### Step 2: Implement network error recovery
```typescript
const handleNetworkError = (data: any) => {
  setError({
    type: 'network',
    message: 'Connection lost, retrying...',
    canRetry: true
  });
  
  if (retryCount < MAX_RETRIES) {
    const delay = Math.min(1000 * Math.pow(2, retryCount), 10000);
    setTimeout(() => {
      hls.startLoad();
      setRetryCount(retryCount + 1);
    }, delay);
  } else {
    setError({
      type: 'network',
      message: 'Unable to connect. Please check your connection.',
      canRetry: false
    });
  }
};
```

### Step 3: Implement media error recovery
```typescript
const handleMediaError = (data: any) => {
  console.warn('Media error, attempting recovery');
  hls.recoverMediaError();
};
```

### Step 4: Implement browser compatibility check
```typescript
const checkBrowserSupport = () => {
  const isSupported = Hls.isSupported() || 
    document.createElement('video').canPlayType('application/vnd.apple.mpegurl');
  
  if (!isSupported) {
    setError({
      type: 'unsupported',
      message: 'Your browser does not support video playback. Please use Chrome, Firefox, Safari, or Edge.',
      canRetry: false
    });
    return false;
  }
  return true;
};
```

### Step 5: Create error display component
```tsx
{error && (
  <div className="error-overlay">
    <div className="error-message retro-border">
      <AlertCircle className="error-icon" />
      <p>{error.message}</p>
      {error.canRetry && (
        <Button onClick={handleManualRetry}>
          Retry Now
        </Button>
      )}
    </div>
  </div>
)}
```

### Step 6: Implement error boundary
```typescript
class PlayerErrorBoundary extends React.Component {
  componentDidCatch(error, errorInfo) {
    console.error('Player error:', error, errorInfo);
    // Show fallback UI
  }
}
```

### Step 7: Add loading states
```typescript
{isLoading && (
  <div className="loading-overlay">
    <LoadingSpinner size="lg" />
    <p>Initializing stream...</p>
  </div>
)}
```

## Test Plan

### Objective
Verify error handling works correctly and provides good user experience during failures.

### Test Scope
- Network interruption simulation
- Stream unavailability
- Browser compatibility
- HLS.js error scenarios
- Retry logic and backoff
- Error message display
- Recovery success

### Success Criteria
- Network errors trigger auto-retry
- Media errors recover automatically
- Fatal errors show appropriate message
- Retry backoff increases exponentially
- Max retry limit respected
- Loading spinner shows during init
- Error messages are user-friendly
- Manual retry button works
- Browser check prevents unsupported access

## Verification

### Acceptance Criteria
- [ ] HLS.js ERROR event handler implemented
- [ ] Network error detection and auto-retry
- [ ] Media error recovery (hls.recoverMediaError())
- [ ] Fatal error handling with user message
- [ ] Exponential backoff implemented
- [ ] Max retry limit enforced (3-5 attempts)
- [ ] Browser compatibility check
- [ ] Loading spinner during initialization
- [ ] Error overlay with retro styling
- [ ] User-friendly error messages
- [ ] Manual retry button for recoverable errors
- [ ] Error boundary wraps player component
- [ ] Tested with network throttling
- [ ] Tested with stream unavailability
- [ ] No console errors in normal operation

### Definition of Done
- All acceptance criteria met
- Error handling tested
- Recovery logic verified
- Ready for E2E testing

## Files Modified

### Modified Files
- `web/components/video/video-player.tsx` - Add error handling
- `web/app/channels/[id]/page.tsx` - Add error boundary

### New Files Created
- `web/components/video/player-error-boundary.tsx` - Error boundary (optional separate file)

### API Specifications Updated
- `docs/api-specs/frontend/frontend-api.md` - Document error handling patterns

## Notes

- HLS.js error types: NETWORK_ERROR, MEDIA_ERROR, KEY_SYSTEM_ERROR, MUX_ERROR, OTHER_ERROR
- Exponential backoff formula: `Math.min(1000 * 2^retryCount, 10000)`
- Max retries: 3-5 depending on error type
- Network error may be transient (WiFi hiccup)
- Media error often recoverable with `recoverMediaError()`
- Stream unavailable (404) should not auto-retry infinitely
- Consider showing connection quality indicator
- Log errors for debugging but show friendly messages to users
- Test with Chrome DevTools network throttling (Fast 3G, Slow 3G, Offline)


