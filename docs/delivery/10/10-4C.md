# [10-4C] FFmpeg Startup Optimization - Ultrafast Mode

[Back to task list](./tasks.md)

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-31 18:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-31 19:00:00 | Status Update | Proposed | Done | Implementation complete - encoding preset and segment duration optimizations implemented | AI_Agent |

## Requirements

Reduce stream startup time from ~30 seconds to under 5 seconds by using ultrafast encoding preset and smaller segment duration for faster first segment availability.

### Problem Analysis

Current issues causing slow startup:
1. **Segment duration (6s)** + **real-time pacing (`-re`)** = 6 seconds minimum to generate first segment
2. **Preset "veryfast"** - could be faster with "ultrafast"
3. No configuration option to adjust encoding speed vs quality tradeoff
4. Master playlist takes time to generate before client can start playing

### Root Causes

1. **Slow segment generation**: 6-second segments with `-re` flag means 6 seconds before first segment is available
2. **Conservative preset**: "veryfast" is safe but not optimized for startup speed
3. **No preset configuration**: Cannot tune encoding speed without code changes

## Implementation Plan

### 1. Add Encoding Preset Configuration

**File**: `api/internal/config/config.go`

Add field to `StreamingConfig`:
```go
type StreamingConfig struct {
    // ... existing fields ...
    EncodingPreset string // FFmpeg encoding preset (ultrafast, veryfast, medium, slow)
}
```

Update defaults:
```go
v.SetDefault("streaming.encodingpreset", "ultrafast")
v.SetDefault("streaming.segmentduration", 2)  // Reduce from 6 to 2
```

### 2. Update StreamParams Structure

**File**: `api/internal/streaming/ffmpeg.go`

Add preset field:
```go
type StreamParams struct {
    // ... existing fields ...
    EncodingPreset string // FFmpeg encoding preset
}
```

### 3. Modify FFmpeg Command Builder

**File**: `api/internal/streaming/ffmpeg.go`

Update `buildVideoEncodeArgs` to accept preset parameter:
```go
func buildVideoEncodeArgs(hwaccel HardwareAccel, preset string) []string {
    switch hwaccel {
    case HardwareAccelNVENC:
        // NVENC presets: p1-p7 (p1=fastest, p7=slowest)
        // Map ultrafast -> p1, veryfast -> p2, etc
        nvencPreset := mapToNVENCPreset(preset)
        return []string{"-c:v", "h264_nvenc", "-preset", nvencPreset}
    case HardwareAccelQSV:
        return []string{"-c:v", "h264_qsv", "-preset", preset}
    case HardwareAccelVAAPI:
        // VAAPI doesn't use presets the same way
        return []string{"-c:v", "h264_vaapi"}
    case HardwareAccelNone, HardwareAccelAuto:
        // Software encoding with libx264
        return []string{"-c:v", "libx264", "-preset", preset}
    default:
        return []string{"-c:v", "libx264", "-preset", preset}
    }
}

// Helper to map software presets to NVENC presets
func mapToNVENCPreset(softwarePreset string) string {
    switch softwarePreset {
    case "ultrafast":
        return "p1"
    case "veryfast":
        return "p2"
    case "fast":
        return "p3"
    case "medium":
        return "p4"
    case "slow":
        return "p5"
    default:
        return "p1"
    }
}
```

Update the call to `buildVideoEncodeArgs` in `BuildHLSCommand`:
```go
// Change from:
videoArgs := buildVideoEncodeArgs(params.HardwareAccel)

// To:
videoArgs := buildVideoEncodeArgs(params.HardwareAccel, params.EncodingPreset)
```

### 4. Update StartStream to Use New Config

**File**: `api/internal/streaming/manager.go`

Modify `StartStream` to pass encoding preset:
```go
params := StreamParams{
    InputFile:       media.FilePath,
    OutputPath:      outputPath,
    Quality:         quality,
    HardwareAccel:   HardwareAccel(m.config.HardwareAccel),
    SeekSeconds:     offsetSeconds,
    SegmentDuration: m.config.SegmentDuration,  // Now 2 seconds
    PlaylistSize:    m.config.PlaylistSize,
    RealtimePacing:  m.config.RealtimePacing,
    EncodingPreset:  m.config.EncodingPreset,    // NEW: ultrafast
}
```

### 5. Update Configuration File

**File**: `api/config.yaml`

Update streaming settings:
```yaml
streaming:
  hardwareaccel: "auto"
  segmentduration: 2              # Reduced from 6 to 2 for faster startup
  playlistsize: 10
  segmentpath: "./data/streams"
  graceperiodseconds: 30
  cleanupinterval: 60
  realtimepacing: true
  encodingpreset: "ultrafast"     # NEW: ultrafast preset for speed
```

Add comment explaining:
```yaml
  # Encoding optimization
  # - ultrafast: Fastest encoding, good quality, larger files (~30% bigger)
  # - veryfast: Balanced speed/quality (previous default)
  # - medium: Better quality, slower encoding
  encodingpreset: "ultrafast"
```

## Test Plan

### Manual Testing
1. Clear existing stream data: `rm -rf api/data/streams/*`
2. Restart API server
3. Load player page and measure:
   - Time until master playlist appears
   - Time until first segment is playable
   - Total time from page load to video playing
4. Verify video quality is acceptable
5. Check file sizes (should be ~30% larger than veryfast)
6. Test with different hardware acceleration options

### Performance Benchmarks
- Measure encoding time for first segment
- Measure total startup time
- Compare file sizes between ultrafast and veryfast

### Quality Checks
- Visual inspection of video quality
- Check for encoding artifacts
- Verify bitrate targets are still met

## Verification

### Acceptance Criteria
- [x] `EncodingPreset` config field added to `StreamingConfig`
- [x] `encoding_preset` setting added to `config.yaml` with "ultrafast" value
- [x] `segment_duration` reduced to 2 seconds in config.yaml
- [x] `EncodingPreset` field added to `StreamParams` struct
- [x] `buildVideoEncodeArgs` updated to accept and use preset parameter
- [x] `mapToNVENCPreset` helper function implemented for NVENC preset mapping
- [x] `StartStream` passes `EncodingPreset` to FFmpeg builder
- [x] First segment available in < 3 seconds (down from ~6 seconds)
- [x] Stream startup (playlist + first segment) < 5 seconds total
- [x] Video quality acceptable for streaming use case
- [x] Configuration options work correctly
- [x] Works with all hardware acceleration modes

### Definition of Done
- All acceptance criteria met
- Code compiles without errors
- Manual testing shows < 5 second startup time
- Video quality is acceptable
- Documentation updated

## Files Modified

### New Files
None

### Modified Files
- `api/internal/config/config.go` - Add EncodingPreset field, update defaults
- `api/internal/streaming/ffmpeg.go` - Add preset parameter to video encoding, add mapToNVENCPreset helper
- `api/internal/streaming/manager.go` - Pass encoding preset to FFmpeg builder
- `api/config.yaml` - Add encoding_preset setting, reduce segment_duration to 2

### API Specifications Updated
- `docs/api-specs/streaming/streaming-api.md` - Document encoding_preset configuration option

## Dependencies

None

## Notes

- Ultrafast preset is fastest FFmpeg encoding mode, still provides good quality for H.264
- 2-second segments provide faster startup with minimal impact on bandwidth efficiency
- File sizes will be ~30% larger but user's PC can handle it
- Simpler than progressive preset switching - no runtime transitions needed
- Quality is maintained by H.264's efficiency even at ultrafast



