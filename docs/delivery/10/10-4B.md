# [10-4B] Fix Stream Looping and Real-Time Encoding

[Back to task list](./tasks.md)

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-31 10:10:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-31 17:00:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-10-31 17:30:00 | Status Update | InProgress | Review | Implementation complete, ready for review | AI_Agent |

## Requirements

Transform the streaming system from VOD-style encoding to true continuous channel streaming with configurable encoding speed and automatic looping when videos end.

### Problem Analysis

From the logs, FFmpeg is:
1. Encoding the entire 21-minute video in ~1.5 minutes at 16.5x speed
2. Exiting cleanly when finished (expected behavior for VOD)
3. System treats clean exit as "unexpected" and restarts infinitely
4. No looping mechanism - just re-encoding from the beginning

### Root Causes

1. **Missing `-re` flag**: FFmpeg needs `-re` (read input at native frame rate) for real-time pacing
2. **No looping**: Need continuous playback mechanism
3. **Wrong exit handling**: Clean exit after finishing video is EXPECTED, not unexpected
4. **No timeline tracking**: When video ends, system should advance to next playlist item

## Implementation Plan

### 1. Add Real-Time Pacing Configuration

**File**: `api/internal/streaming/config.go`

Add new config field to `StreamConfig`:
```go
RealtimePacing bool `mapstructure:"realtime_pacing"` // Enable -re flag for 1x speed
```

**File**: `api/config.yaml`

Add configuration:
```yaml
streaming:
  realtime_pacing: true  # Set false for fast testing
```

### 2. Update FFmpeg Command Builder

**File**: `api/internal/streaming/ffmpeg.go`

- Add `RealtimePacing` field to `StreamParams` struct
- Update `BuildStreamCommand` to conditionally add `-re` flag before `-i` input

### 3. Fix Clean Exit Handling

**File**: `api/internal/streaming/manager.go` (function `monitorFFmpegProcess`)

Replace lines 523-540 (the "exited cleanly but unexpectedly" section) with proper playlist advancement:
- Change from treating as "crash" to treating as "expected completion"
- Check for active clients
- If clients exist, advance to next video
- If no clients, clean up session gracefully

### 4. Implement Playlist Advancement

**File**: `api/internal/streaming/manager.go` (new function)

Add `advanceToNextVideo` function to:
- Get current channel and playlist
- Determine next video (loop back to first for now)
- Stop current stream cleanly
- Start new stream with next video
- Maintain client registration across transition

### 5. Update Stream Start Parameters

**File**: `api/internal/streaming/manager.go` (function `StartStream`)

Update `StreamParams` construction to include:
```go
RealtimePacing: m.config.RealtimePacing,
```

## Test Plan

### Test Scenarios

1. **Real-Time Mode Testing** (realtime_pacing: true)
   - Verify 21-minute video takes ~21 minutes to encode
   - Confirm encoding speed shown in logs is ~1x
   - Check smooth transition at video end
   - Verify loop back to beginning

2. **Fast Mode Testing** (realtime_pacing: false)
   - Verify video encodes at max speed (~16.5x)
   - Confirm looping still works correctly
   - Check no infinite restart loops

3. **Client Disconnect Testing**
   - Start stream with client
   - Disconnect client during encoding
   - Verify stream stops gracefully
   - Verify no unnecessary restarts

4. **Loop Transition Testing**
   - Watch through end of video
   - Verify seamless transition to beginning
   - Check no dropped frames at loop point
   - Confirm playlist position resets

### Success Criteria

- [ ] With `realtime_pacing: true`, video encodes at 1x speed
- [ ] With `realtime_pacing: false`, video encodes at max speed
- [ ] FFmpeg clean exit triggers loop, not restart
- [ ] Video loops continuously when clients are watching
- [ ] Stream stops gracefully when no clients present
- [ ] No infinite restart loops observed
- [ ] Smooth transition between loop iterations

## Verification

### Acceptance Criteria
- [x] `RealtimePacing` config field added to `StreamConfig`
- [x] `realtime_pacing` setting added to `config.yaml`
- [x] `-re` flag conditionally added to FFmpeg command
- [x] `RealtimePacing` field added to `StreamParams` struct
- [x] Clean FFmpeg exit no longer treated as crash
- [x] `advanceToNextVideo` function implemented
- [x] Playlist loops back to first video after completion
- [x] Client count checked before restarting stream
- [ ] Real-time mode tested (1x encoding speed)
- [ ] Fast mode tested (max encoding speed)
- [ ] Loop transition verified to be smooth
- [ ] No infinite restart loops occur

### Definition of Done
- All acceptance criteria met
- Code compiles without errors
- All tests pass
- FFmpeg encodes at correct speed based on config
- Videos loop continuously without restart issues
- Documentation updated

## Files Modified

### New Files
None

### Modified Files
- `api/internal/streaming/config.go` - Add RealtimePacing field
- `api/internal/streaming/ffmpeg.go` - Add conditional -re flag, update StreamParams
- `api/internal/streaming/manager.go` - Fix clean exit handling, add advanceToNextVideo function
- `api/config.yaml` - Add realtime_pacing setting

### API Specifications Updated
None (internal streaming behavior change only)

## Dependencies

None

## Notes

- This fixes the core architecture issue where the system confuses VOD encoding with live streaming
- Real-time pacing (`-re` flag) is essential for true channel simulation
- Fast mode (without `-re`) is useful for testing but produces same looping behavior
- Future enhancement: Track current position in multi-video playlists instead of always looping to first video

