# [13-3] Playlist Manager using hls-m3u8

[Back to task list](./tasks.md)

## Description

Implement a Go playlist manager that maintains a fixed-size sliding window of the most recent segments and generates a media playlist using `hls-m3u8`. Perform atomic writes to avoid partial reads, and expose simple APIs for segment updates and shutdown.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-11 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-11 15:00:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-01-11 16:00:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | AI_Agent |
| 2025-01-11 16:30:00 | Status Update | Review | Done | Code quality checks passed, task completed | AI_Agent |

## Requirements

### Functional Requirements
- Keep a ring buffer of the last N segments (configurable).
- Generate playlists with correct `#EXTINF`, `#EXT-X-MEDIA-SEQUENCE`, and `#EXT-X-TARGETDURATION`.
- Write playlist atomically (`.tmp` + rename).
- Insert discontinuities when flagged by upstream logic.

### Technical Requirements
- Use `github.com/Eyevinn/hls-m3u8/m3u8`.
- Provide a small interface, e.g.:
  - `type PlaylistManager interface { AddSegment(seg SegmentMeta) error; SetDiscontinuityNext(); Write() error; Close() error }`
- Compute `TARGETDURATION = ceil(max observed segment duration)` within the window.
- Support optional `#EXT-X-PROGRAM-DATE-TIME`.

## Implementation Plan

1) Define `SegmentMeta` (name, duration, programDateTime, discontinuity bool).
2) Implement ring buffer with append/prune and track max duration.
3) Render playlist via hls-m3u8; set sequence based on first item index.
4) Implement atomic writer (temp file + rename) to the target path.
5) Add unit tests for append/prune/sequence/targetduration.

## Test Plan

### Objective
Validate correct playlist generation and atomic updates under typical and edge conditions.

### Success Criteria
- Media sequence increments monotonically.
- Window size respected; pruning works as expected.
- Target duration equals ceil(max EXTINF).
- Atomic writes observed (no partial reads).

## Verification

### Acceptance Criteria
- [x] Ring buffer maintains correct order and size
- [x] Playlist fields are correct and validated
- [x] Atomic file write logic verified
- [x] Unit tests cover core behaviors (>80% new code)

## Files Modified

### New Files Created
- `api/internal/streaming/playlist/manager.go` — PlaylistManager implementation
- `api/internal/streaming/playlist/manager_test.go` — Unit tests


