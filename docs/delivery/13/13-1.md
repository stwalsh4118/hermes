# [13-1] FFmpeg 4s TS stream_segment pipeline

[Back to task list](./tasks.md)

## Description

Switch from FFmpeg’s built-in HLS muxer to the `stream_segment` muxer to emit 4-second MPEG-TS segments without generating a playlist. Enforce GOP alignment and keyframe placement to ensure deterministic segment boundaries that the Go playlist manager can consume reliably.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-11 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Emit 4s `.ts` media segments only (no playlist output).
- Ensure deterministic keyframes at 4s boundaries with minimal drift.
- Support audio+video mapping explicitly.
- Use stable, sortable filenames (strftime or monotonic counters).

### Technical Requirements
- Update FFmpeg command builder to:
  - Use `-f stream_segment -segment_time 4 -segment_format mpegts -strftime 1`
  - Enforce aligned GOP: `-g (fps*4) -keyint_min (fps*4) -sc_threshold 0`
  - Force keyframes: `-force_key_frames "expr:gte(t,n_forced*4)"`
  - Map streams explicitly (e.g., `-map 0:v:0 -map 0:a:0`)
- Parameterize paths and segment duration via config.
- Ensure segment directory creation and permissions handled.

## Implementation Plan

1) Inspect current FFmpeg command builder (`api/internal/streaming/ffmpeg.go`) and refactor to support `stream_segment` mode.
2) Add configuration knobs (segment duration, output directory, filename pattern).
3) Implement GOP/keyframe enforcement flags; ensure compatibility with selected encoder.
4) Validate audio mapping and container settings for MPEG-TS output.
5) Write minimal smoke test to run process in a sandbox folder and confirm segments produced at ~4s cadence.

## Test Plan

### Objective
Verify FFmpeg emits 4s TS segments with aligned keyframes and no playlist output.

### Success Criteria
- Segments produced at ~4s intervals (±100ms).
- File naming matches configured pattern.
- No `.m3u8` output from FFmpeg.
- Command exits cleanly on stop.

## Verification

### Acceptance Criteria
- [ ] 4s TS segments emitted consistently
- [ ] GOP/keyframes aligned to 4s boundary
- [ ] Audio present and in sync
- [ ] Segment directory and permissions handled
- [ ] Configurable via application config

## Files Modified

### Modified Files
- `api/internal/streaming/ffmpeg.go` — Add stream_segment pipeline and flags
- `api/internal/streaming/process.go` — Integrate segment output path and lifecycle
- `api/internal/config/config.go` — (If needed) Add segment-related config

### New/Temp Files (for local validation only)
- `data/streams/<channel>/seg-%Y%m%dT%H%M%S.ts`


