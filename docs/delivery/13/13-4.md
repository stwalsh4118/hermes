# [13-4] Segment Watcher and pruning

[Back to task list](./tasks.md)

## Description

Implement a component that detects newly written 4s TS segments and notifies the Playlist Manager, and prunes old segments older than `(window + safetyBuffer)` to keep storage bounded and avoid client race conditions.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-11 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-11 18:00:00 | Status Update | Proposed | Done | Implementation completed: segment watcher with fsnotify/polling, pruning, and comprehensive tests | AI_Agent |

## Requirements

### Functional Requirements
- Detect new `.ts` files in the segment directory quickly.
- Provide duration metadata to the playlist manager (constant 4.0 or measured).
- Prune files older than `(window + safetyBuffer)` segments.
- Safety buffer default: 2 segments (configurable).

### Technical Requirements
- Prefer `fsnotify` watcher; fallback to polling if unavailable.
- Ensure debouncing/coalescing to avoid duplicate notifications.
- Atomicity-aware: handle file-creation + rename patterns safely.
- Pruning must not delete files referenced in the current playlist.

## Implementation Plan

1) Implement directory watcher (fsnotify) for `.ts` creations.
2) On new segment: collect metadata (name, mtime, duration=4.0) and call Playlist Manager.
3) Implement periodic pruning job respecting `(window + safetyBuffer)`.
4) Provide config fields for paths, window size, safety buffer, prune interval.
5) Add integration tests to simulate segment creation cadence and verify pruning.

## Test Plan

### Objective
Ensure timely detection of new segments and safe pruning behavior.

### Success Criteria
- New segments are detected within 1s.
- Playlist updates after detection.
- No deletion of segments still referenced in the playlist.

## Verification

### Acceptance Criteria
- [x] Watcher/poller reliably detects new `.ts` files
- [x] Pruning respects window + safetyBuffer
- [x] Configurable intervals and safety buffer supported

## Files Modified

### New Files Created
- `api/internal/streaming/playlist/watcher.go` — Directory watcher and pruning logic
- `api/internal/streaming/playlist/watcher_test.go` — Unit/integration tests

### Modified Files
- `api/internal/streaming/playlist/manager.go` — Added `GetCurrentSegments()` method to Manager interface
- `api/internal/streaming/playlist/manager_test.go` — Added test for `GetCurrentSegments()` method
- `api/internal/config/config.go` — Added segment watcher configuration fields (SegmentWatcherSafetyBuffer, SegmentWatcherPruneInterval, SegmentWatcherPollInterval)


