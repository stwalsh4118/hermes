# [13-5] Discontinuity detection and tagging

[Back to task list](./tasks.md)

## Description

Detect encoder restarts or timestamp regressions and insert `#EXT-X-DISCONTINUITY` tags appropriately in the generated media playlist so clients can recover seamlessly.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-11 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Identify conditions that require a discontinuity (process restart, timebase reset, PTS regression).
- Mark the next segment boundary with a discontinuity flag.
- Ensure playlist remains valid and plays through the discontinuity.

### Technical Requirements
- Track previous segment timestamps (mtime or PTS, if available).
- Provide a method on Playlist Manager: `SetDiscontinuityNext()`.
- Insert the discontinuity tag before the next appended segment.

## Implementation Plan

1) Define discontinuity triggers (process lifecycle event, timestamp checks).
2) Add plumbing to signal discontinuity to Playlist Manager.
3) Write unit tests for single and multiple discontinuities.
4) Validate players handle discontinuity without stalls.

## Test Plan

### Objective
Ensure discontinuities are inserted only when necessary and handled correctly by clients.

### Success Criteria
- Discontinuity appears exactly once at the boundary.
- No false positives during normal operation.

## Verification

### Acceptance Criteria
- [ ] Triggering conditions documented and implemented
- [ ] Playlist shows `#EXT-X-DISCONTINUITY` at correct position
- [ ] Playback test passes without stalls on discontinuity

## Files Modified

### Modified/New Files
- `api/internal/streaming/playlist/manager.go` — Add discontinuity support
- `api/internal/streaming/process.go` — Signal conditions requiring discontinuity
- `api/internal/streaming/playlist/manager_test.go` — Add tests


