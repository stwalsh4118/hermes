# [13-6] Observability for HLS pipeline

[Back to task list](./tasks.md)

## Description

Add actionable logs and metrics to track segment cadence, observed max segment duration, playlist update latency, current window size, and last successful write, to aid operations and troubleshooting.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-11-11 12:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Update | InProgress | Review | Implementation complete: Added structured logging and metrics for segment cadence, write latency, window size, max duration, and last successful write | AI_Agent |
| 2025-01-XX XX:XX:XX | Status Update | Review | Done | Task completed and approved | AI_Agent |

## Requirements

### Functional Requirements
- Log on each segment detection and playlist write event.
- Expose counters/gauges for cadence, drift, and window size.
- Provide a health/readiness indicator for the playlist service.

### Technical Requirements
- Follow existing logging patterns (zerolog or project standard).
- Consider lightweight metrics (expvar/prometheus endpoints) if available.
- Ensure logs are structured and sampled if noisy.

## Implementation Plan

1) Define metrics/log events and fields (channel, segment, durations).
2) Instrument watcher, manager, and process orchestration points.
3) Add a simple health endpoint or status function if applicable.
4) Validate logs under normal and error scenarios.

## Test Plan

### Objective
Ensure observability provides sufficient insight without excessive noise.

### Success Criteria
- Logs include key fields (channelId, seq, duration, windowLen).
- Metrics reflect current state and update on events.

## Verification

### Acceptance Criteria
- [x] Structured logs at key points in the pipeline
- [x] Metrics counters/gauges updated accurately
- [x] Health/readiness indicator available

## Files Modified

### Modified/New Files
- `api/internal/streaming/playlist/watcher.go` — Added cadence tracking, detection-to-write latency measurement, and enhanced segment detection logging
- `api/internal/streaming/playlist/manager.go` — Added write latency tracking, last successful write timestamp, window size tracking, max duration logging, and HealthCheck() method
- `api/internal/streaming/process.go` — Added process launch/termination timing and lifecycle observability
- `api/internal/streaming/manager.go` — Enhanced monitorFFmpegProcess and monitorBatchCompletion with timing metrics


