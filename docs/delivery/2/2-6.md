# [2-6] Create Integration Tests

[Back to task list](./tasks.md)

## Description

Build comprehensive integration tests that verify the complete media management flow from scanning to API operations. These tests ensure all components work together correctly with a real database and file system.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-27 01:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Test complete scan workflow
- Test all API endpoints with real database
- Test error scenarios
- Test concurrent operations
- Use test fixtures (sample video files or mocks)
- Clean up test data after each test
- Independent test cases (no dependencies between tests)

### Technical Requirements
- Use Go testing package
- Create test database for each test
- Use testify assertions (if beneficial) or standard testing
- Test HTTP endpoints using httptest
- Create sample media files or mock FFprobe for tests
- Follow table-driven test pattern
- Run with -race flag to detect race conditions

### Test Coverage Goals
- Scanner integration with database
- API endpoint integration
- FFprobe + Parser + Validator + Scanner pipeline
- Error handling across components
- Database operations (create, update, delete)

## Implementation Plan

### Step 1: Setup Test Infrastructure
- Create test database helper
- Create test media file fixtures
- Create test HTTP server setup
- Create cleanup helpers

### Step 2: Scanner Integration Tests
- Test scanning directory with sample files
- Test progress tracking during scan
- Test error handling (corrupted files)
- Test database population
- Test duplicate file handling

### Step 3: API Endpoint Integration Tests
- Test POST /api/media/scan
- Test GET /api/media/scan/:id/status
- Test GET /api/media (list)
- Test GET /api/media/:id
- Test PUT /api/media/:id
- Test DELETE /api/media/:id

### Step 4: End-to-End Workflow Tests
- Scan directory → List media → Update media → Delete media
- Multiple scans
- Concurrent API requests

### Step 5: Error Scenario Tests
- Invalid requests
- Non-existent resources
- Database errors
- File system errors

### Step 6: Performance Tests (Optional)
- Large directory scan
- Many concurrent requests
- Database query performance

## Test Plan

### Objective
Verify complete system integration with real components and database.

### Test Scope
- Full scanning workflow
- API endpoint integration
- Database operations
- Error handling
- Concurrent operations

### Key Test Scenarios

1. **Complete Scan Workflow**
   - Given: Test directory with video files
   - When: Scan triggered
   - Then: All files in database with correct metadata

2. **API List After Scan**
   - Given: Database populated from scan
   - When: GET /api/media called
   - Then: Returns all scanned media

3. **Update Media Via API**
   - Given: Media in database
   - When: PUT /api/media/:id called
   - Then: Database updated, GET returns new data

4. **Delete Media Via API**
   - Given: Media in database
   - When: DELETE /api/media/:id called
   - Then: Media removed, GET returns 404

5. **Pagination**
   - Given: 50 media items in database
   - When: GET /api/media?limit=10&offset=0
   - Then: Returns first 10 items

6. **Filter by Show**
   - Given: Multiple shows in database
   - When: GET /api/media?show=Friends
   - Then: Returns only Friends episodes

7. **Concurrent Scan Requests**
   - Given: Two scan requests
   - When: Both triggered simultaneously
   - Then: One succeeds, one queued or errors

8. **Error Handling**
   - Invalid scan path
   - Invalid UUID
   - Non-existent media ID
   - Invalid request body

### Success Criteria
- All integration tests pass
- Tests run independently
- No race conditions
- Test database cleaned up
- Coverage >70% for integration paths

## Verification

### Acceptance Criteria
- [ ] Integration test file created `internal/media/integration_test.go` or `test/integration/media_test.go`
- [ ] Test infrastructure setup (database, fixtures)
- [ ] Scanner integration tests implemented
- [ ] All API endpoints tested
- [ ] End-to-end workflow tests implemented
- [ ] Error scenarios tested
- [ ] Tests pass with -race flag
- [ ] Test cleanup works properly
- [ ] Tests documented with clear descriptions

### Definition of Done
- All acceptance criteria met
- All integration tests pass
- No flaky tests
- Tests run in <30 seconds
- Code follows Go best practices
- No test data leaks between tests

## Files Modified

### New Files Created
- `api/test/integration/media_test.go` - Integration tests (or location as appropriate)
- `api/test/integration/fixtures/` - Test media files or mock data
- `api/test/integration/helpers.go` - Test helpers

### Files Modified
- None (new test files)

## Notes

- Integration tests are slower than unit tests, keep them focused
- Consider using Docker for test database (optional)
- Mock FFprobe if real video files not available
- Consider using golden files for expected responses
- Test data should be small and fast to process
- Clean up any created files in test teardown
- Use t.Parallel() for independent tests when appropriate
- Consider separate integration test build tag: `// +build integration`

