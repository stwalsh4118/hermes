# [2-5] Implement Media API Endpoints

[Back to task list](./tasks.md)

## Description

Create RESTful API endpoints for media management, including triggering scans, checking scan progress, and CRUD operations for media items. These endpoints provide the interface between the frontend and the media management backend.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-27 00:55:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-27 16:30:00 | Status Change | Proposed | InProgress | Implementation started | AI_Agent |
| 2025-10-27 18:15:00 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI_Agent |
| 2025-10-27 19:00:00 | Status Change | Review | Done | Approved with bug fixes applied | User |

## Requirements

### Functional Requirements
- POST /api/media/scan - Trigger media library scan
- GET /api/media/scan/:scanId/status - Get scan progress
- GET /api/media - List all media (with pagination and filtering)
- GET /api/media/:id - Get single media item
- PUT /api/media/:id - Update media metadata
- DELETE /api/media/:id - Remove media from library
- Input validation on all endpoints
- Appropriate HTTP status codes
- JSON request/response format
- Error handling with clear messages

### Technical Requirements
- Use Gin framework (already in project)
- Integrate with Scanner for scan operations
- Use Media repository for database operations
- Request/response DTOs for clean API contracts
- Query parameter validation (pagination, filters)
- UUID validation for IDs
- Structured logging for all requests
- Follow REST conventions

### API Specifications

#### POST /api/media/scan
Triggers a media library scan
- Request body: `{ "path": "/path/to/media" }` (optional, uses config if not provided)
- Response: `{ "scan_id": "uuid", "message": "Scan started" }`
- Status codes: 201 Created, 400 Bad Request, 500 Internal Server Error

#### GET /api/media/scan/:scanId/status
Get scan progress
- Response: `{ "scan_id": "uuid", "status": "running", "total_files": 100, "processed_files": 50, ... }`
- Status codes: 200 OK, 404 Not Found

#### GET /api/media
List media items
- Query params: `?limit=20&offset=0&show=Friends`
- Response: `{ "items": [...], "total": 100, "limit": 20, "offset": 0 }`
- Status codes: 200 OK, 400 Bad Request

#### GET /api/media/:id
Get media details
- Response: Media object
- Status codes: 200 OK, 404 Not Found

#### PUT /api/media/:id
Update media metadata
- Request body: `{ "title": "...", "show_name": "...", "season": 1, "episode": 5 }`
- Response: Updated Media object
- Status codes: 200 OK, 400 Bad Request, 404 Not Found

#### DELETE /api/media/:id
Delete media
- Response: `{ "message": "Media deleted successfully" }`
- Status codes: 200 OK, 404 Not Found

## Implementation Plan

### Step 1: Define Request/Response DTOs
```go
type ScanRequest struct {
    Path string `json:"path"`
}

type ScanResponse struct {
    ScanID  string `json:"scan_id"`
    Message string `json:"message"`
}

type MediaListResponse struct {
    Items  []models.Media `json:"items"`
    Total  int            `json:"total"`
    Limit  int            `json:"limit"`
    Offset int            `json:"offset"`
}

type UpdateMediaRequest struct {
    Title    *string `json:"title"`
    ShowName *string `json:"show_name"`
    Season   *int    `json:"season"`
    Episode  *int    `json:"episode"`
}
```

### Step 2: Implement Scan Endpoints
- POST /api/media/scan handler
- Validate request
- Get path from config or request
- Call Scanner.StartScan()
- Return scan ID

- GET /api/media/scan/:scanId/status handler
- Validate scan ID (UUID)
- Call Scanner.GetScanProgress()
- Return progress or 404

### Step 3: Implement List Endpoint
- GET /api/media handler
- Parse query parameters (limit, offset, show)
- Validate pagination params
- Call appropriate repository method
- Return paginated results

### Step 4: Implement Single Media Endpoint
- GET /api/media/:id handler
- Validate ID (UUID)
- Call repository.GetByID()
- Return media or 404

### Step 5: Implement Update Endpoint
- PUT /api/media/:id handler
- Validate ID and request body
- Load existing media
- Update fields
- Save to database
- Return updated media

### Step 6: Implement Delete Endpoint
- DELETE /api/media/:id handler
- Validate ID
- Check media exists
- Delete from database
- Return success message

### Step 7: Register Routes
- Create SetupMediaRoutes() function
- Register all routes with Gin router
- Apply middleware (logging, recovery)

### Step 8: Integration with Server
- Call SetupMediaRoutes() in server initialization
- Pass Scanner and DB instances

## Test Plan

### Objective
Verify all API endpoints work correctly with proper validation and error handling.

### Test Scope
- Request validation
- Response format
- Status codes
- Integration with Scanner and DB
- Error handling
- Pagination

### Key Test Scenarios

1. **Trigger Scan**
   - POST /api/media/scan
   - Returns 201 with scan_id

2. **Get Scan Status**
   - GET /api/media/scan/:id/status
   - Returns progress object

3. **List Media**
   - GET /api/media?limit=10&offset=0
   - Returns paginated list

4. **Filter by Show**
   - GET /api/media?show=Friends
   - Returns filtered results

5. **Get Single Media**
   - GET /api/media/:id
   - Returns media object or 404

6. **Update Media**
   - PUT /api/media/:id with valid data
   - Returns updated media

7. **Delete Media**
   - DELETE /api/media/:id
   - Returns success, media removed

8. **Invalid UUID**
   - Any endpoint with invalid UUID
   - Returns 400 Bad Request

9. **Not Found**
   - GET/PUT/DELETE with non-existent ID
   - Returns 404 Not Found

### Success Criteria
- All endpoints return correct responses
- Validation works properly
- Appropriate status codes used
- Error messages are clear
- Integration with backend works

## Verification

### Acceptance Criteria
- [x] API handlers created in `internal/api/media.go`
- [x] All 6 endpoints implemented
- [x] Request/response DTOs defined
- [x] Input validation implemented
- [x] UUID validation for IDs
- [x] Pagination implemented for list endpoint
- [x] Filter by show implemented
- [x] Error handling with appropriate status codes
- [x] SetupMediaRoutes() function created
- [x] Routes registered in server
- [x] Integration tests for all endpoints
- [x] API documented in API spec file

### Definition of Done
- [x] All acceptance criteria met
- [x] Integration tests pass (100% pass rate)
- [x] Code follows Go best practices
- [x] No linter errors (golangci-lint clean)
- [x] API spec documentation updated
- [x] Test coverage: 71.8% (good coverage for integration tests)
- [x] No race conditions (verified with -race flag)

## Files Modified

### New Files Created
- `api/internal/api/media.go` - Media API handlers
- `api/internal/api/media_test.go` - Integration tests

### Files Modified
- `api/internal/server/server.go` - Register media routes
- `docs/api-specs/media/media-api.md` - Update with endpoint documentation

## Notes

- Use existing request logging middleware
- Follow same pattern as health endpoint
- Consider adding rate limiting for scan endpoint (future)
- Scan endpoint should check if scan already running
- Update endpoint should validate that references (media files) still exist
- Delete should be soft delete or check for playlist references (future consideration)
- Consider adding search functionality (future enhancement)
- Consider adding bulk operations (future enhancement)

## Bug Fixes During Review

### 1. Pagination Total Count Issue
**Issue**: The ListMedia endpoint incorrectly calculated total count using `len(mediaItems)`, which only returned the number of items on the current page, breaking pagination.

**Fix Applied**:
1. Added `Count()` and `CountByShow()` methods to MediaRepository
2. Updated ListMedia handler to query actual total count
3. Added tests to verify correct total count with pagination

**Files Changed**:
- `api/internal/db/media.go` - Added Count/CountByShow methods
- `api/internal/api/media.go` - Updated to use count queries
- `api/internal/api/media_test.go` - Added pagination tests
- `docs/api-specs/database/database-api.md` - Updated documentation

### 2. Nil Pointer Dereference in Shutdown
**Issue**: The `Shutdown()` method called `s.server.Shutdown(ctx)` without checking if `s.server` is nil. If `Start()` was never called or failed before assigning `s.server`, this would cause a nil pointer dereference panic.

**Fix Applied**:
1. Added nil check for `s.server` before calling `Shutdown()`
2. Matches the pattern already used for `s.scanner` nil check

**Files Changed**:
- `api/internal/server/server.go` - Added nil check for server

