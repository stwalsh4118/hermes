# [2-7] E2E CoS Testing

[Back to task list](./tasks.md)

## Description

Comprehensive end-to-end testing that verifies all Conditions of Satisfaction (CoS) from PBI 2 are met. This task ensures the complete media library management backend works as specified in the PRD and meets all acceptance criteria.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-27 01:05:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Verify all PBI 2 CoS are met
- Test with real video files (multiple formats)
- Test complete user workflows
- Validate API responses match specifications
- Verify database schema and data integrity
- Test error handling end-to-end
- Document any deviations from PRD

### Conditions of Satisfaction to Verify
From PBI 2 PRD:
- [ ] Media directory scanning implemented
- [ ] FFprobe integration for metadata extraction (duration, codecs, resolution)
- [ ] Media CRUD API endpoints functional
- [ ] Media validation (readable files, codec detection)
- [ ] Database stores all media metadata
- [ ] Support for MP4, MKV, AVI, MOV formats
- [ ] Show/series organization capability
- [ ] Season and episode metadata support

### Technical Requirements
- Use real video files (sample files in test fixtures)
- Test with actual HTTP requests
- Verify database state directly
- Test all supported formats
- Test realistic file counts (100+ files for performance check)
- Validate against API specification document

## Implementation Plan

### Step 1: Prepare Test Environment
- Create test video files (or use samples) in MP4, MKV, AVI, MOV
- Set up test directory structure with organized files
- Initialize test database
- Configure test server

### Step 2: Test Media Scanning (CoS 1, 5, 6, 7)
- Scan directory with multiple formats
- Verify all supported formats detected
- Verify FFprobe extracts metadata
- Verify database populated
- Check show/season/episode parsing

### Step 3: Test Metadata Extraction (CoS 2, 8)
- Verify duration extracted correctly
- Verify codecs detected (video and audio)
- Verify resolution captured
- Verify file size recorded
- Test with various codec combinations

### Step 4: Test API Endpoints (CoS 3)
- POST /api/media/scan - trigger scan
- GET /api/media/scan/:id/status - check progress
- GET /api/media - list all media
- GET /api/media/:id - get single item
- PUT /api/media/:id - update metadata
- DELETE /api/media/:id - remove media

### Step 5: Test Validation (CoS 4)
- Test with unreadable file
- Test with corrupted video
- Test codec detection (H.264+AAC vs others)
- Verify transcoding flags set correctly

### Step 6: Test Organization (CoS 7, 8)
- Test filename patterns recognition
- Verify show name extraction
- Verify season/episode extraction
- Test directory-based organization

### Step 7: Test Error Handling
- Invalid scan paths
- Permission denied scenarios
- Corrupted files in scan
- Invalid API requests
- Database errors

### Step 8: Test Pagination and Filtering
- List with pagination
- Filter by show name
- Verify correct results and counts

### Step 9: Performance Testing
- Scan 100+ files
- Measure scan time
- Test API response times
- Verify no memory leaks

### Step 10: Validate Database Schema
- Check all columns present
- Verify constraints (unique file_path)
- Check indexes
- Verify data types

## Test Plan

### Objective
Verify all PBI 2 acceptance criteria are met with comprehensive end-to-end testing.

### Test Scope
- Complete media library management workflow
- All API endpoints
- All supported formats
- Database integrity
- Error handling
- Performance characteristics

### Test Cases by CoS

**CoS 1: Media directory scanning implemented**
- Scan directory recursively
- Find all video files
- Skip non-video files
- Handle nested directories

**CoS 2: FFprobe integration for metadata extraction**
- Extract duration (verify accurate)
- Extract video codec
- Extract audio codec
- Extract resolution
- Extract file size

**CoS 3: Media CRUD API endpoints functional**
- Create via scan
- Read via GET endpoints
- Update via PUT endpoint
- Delete via DELETE endpoint
- List with pagination

**CoS 4: Media validation**
- File readability check
- Codec detection
- Transcoding requirement flag
- Error handling for invalid files

**CoS 5: Database stores all media metadata**
- All fields populated
- Data types correct
- Constraints enforced
- Unique file paths

**CoS 6: Support for MP4, MKV, AVI, MOV formats**
- Test MP4 file
- Test MKV file
- Test AVI file
- Test MOV file
- Verify all processed correctly

**CoS 7: Show/series organization capability**
- Show name extracted
- Multiple episodes of same show grouped
- Filter by show works

**CoS 8: Season and episode metadata support**
- Season number extracted
- Episode number extracted
- Formatted title generated
- Update functionality works

### Success Criteria
- All 8 CoS verified and passing
- No critical bugs
- Performance acceptable (scan 100 files in <5 minutes)
- API matches specification
- Database schema correct
- Error handling robust

## Verification

### Acceptance Criteria
- [ ] E2E test suite created
- [ ] All 8 CoS explicitly tested
- [ ] Tests use real video files
- [ ] Complete workflows tested
- [ ] Database validation included
- [ ] Performance benchmarks included
- [ ] Error scenarios covered
- [ ] Test report generated
- [ ] Any issues documented

### Definition of Done
- All CoS verified as met
- All E2E tests passing
- Test coverage documented
- Known issues documented (if any)
- Sign-off from PBI owner

## Files Modified

### New Files Created
- `api/test/e2e/media_cos_test.go` - E2E CoS tests
- `api/test/e2e/fixtures/` - Sample video files
- `api/test/e2e/README.md` - Test documentation

### Files Modified
- `docs/delivery/2/prd.md` - Check off completed CoS items
- `docs/api-specs/media/media-api.md` - Finalize API documentation

## Notes

- This is the final validation before marking PBI 2 as complete
- Should be run after all other tasks are complete
- May uncover integration issues not caught by unit/integration tests
- Test report should document any deviations from PRD
- Sample video files should be small (<10MB each)
- Consider using open source sample videos (Big Buck Bunny, etc.)
- FFprobe must be installed in test environment
- Tests should be runnable in CI/CD pipeline
- This is a holistic test of the entire PBI, not individual components

