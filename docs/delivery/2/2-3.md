# [2-3] Implement Media Validator

[Back to task list](./tasks.md)

## Description

Create a media validator that checks video codec compatibility and determines whether files require transcoding. This component will identify files that can be streamed directly (H.264 video + AAC audio) versus those requiring transcoding.

The validator will also perform basic file accessibility checks to ensure files are readable before attempting to scan or stream them.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-27 00:45:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-27 01:15:00 | Status Update | Proposed | InProgress | Started implementation | AI_Agent |
| 2025-10-27 01:45:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | AI_Agent |
| 2025-10-27 02:30:00 | Status Update | Review | Done | Approved and merged | User |

## Requirements

### Functional Requirements
- Check if video codec is H.264 (compatible)
- Check if audio codec is AAC (compatible)
- Flag files requiring transcoding
- Validate file exists and is readable
- Return validation result with reasons for incompatibility
- Support checking VideoMetadata from FFprobe

### Technical Requirements
- Use VideoMetadata structure from FFprobe package
- Return structured ValidationResult
- Provide clear reasons for transcoding requirement
- No external dependencies (use standard library)
- Well-documented codec compatibility rules

### Compatibility Rules
- **No Transcode Required**: H.264 video + AAC audio
- **Transcode Required**: Any other codec combination
- Common compatible formats: MP4, MOV with H.264/AAC
- Common incompatible codecs: HEVC, VP9, AV1, FLAC, DTS

## Implementation Plan

### Step 1: Define Data Structures
```go
type ValidationResult struct {
    Compatible     bool     // true if no transcoding needed
    RequiresTranscode bool  // true if transcoding required
    Reasons        []string // Reasons for incompatibility
    Readable       bool     // File exists and is readable
}
```

### Step 2: Implement File Validation
- Check file exists using os.Stat
- Check file is readable
- Return error if file not accessible

### Step 3: Implement Codec Validation
- Check video codec is "h264"
- Check audio codec is "aac"
- Handle case variations (H264, h.264, etc.)
- Generate reasons for any incompatibilities

### Step 4: Implement ValidateMedia Function
- Take VideoMetadata as input
- Check codec compatibility
- Build list of reasons if incompatible
- Return ValidationResult

### Step 5: Implement ValidateFile Function
- Take file path as input
- Check file accessibility
- Return ValidationResult

### Step 6: Unit Tests
- Test compatible codec combinations
- Test incompatible codec combinations
- Test missing codecs
- Test file validation
- Test reason generation

## Test Plan

### Objective
Verify validator correctly identifies compatible codecs and files requiring transcoding.

### Test Scope
- Codec compatibility detection
- File accessibility validation
- Reason generation for incompatibilities
- Edge cases (missing codec info)

### Key Test Scenarios

1. **Compatible Media**
   - Given: H.264 video + AAC audio
   - When: ValidateMedia() called
   - Then: Compatible=true, RequiresTranscode=false

2. **Incompatible Video Codec**
   - Given: HEVC video + AAC audio
   - When: ValidateMedia() called
   - Then: Compatible=false, RequiresTranscode=true, Reasons includes video codec

3. **Incompatible Audio Codec**
   - Given: H.264 video + FLAC audio
   - When: ValidateMedia() called
   - Then: Compatible=false, RequiresTranscode=true, Reasons includes audio codec

4. **Both Incompatible**
   - Given: VP9 video + DTS audio
   - When: ValidateMedia() called
   - Then: Compatible=false, RequiresTranscode=true, Reasons includes both

5. **File Exists**
   - Given: Valid file path
   - When: ValidateFile() called
   - Then: Readable=true

6. **File Not Found**
   - Given: Non-existent file path
   - When: ValidateFile() called
   - Then: Readable=false

### Success Criteria
- All codec combinations correctly identified
- Reasons clearly explain incompatibilities
- File validation works correctly
- No false positives/negatives

## Verification

### Acceptance Criteria
- [x] Validator package created in `internal/media/validator.go`
- [x] ValidationResult structure defined
- [x] ValidateMedia() function checks codec compatibility
- [x] H.264 + AAC identified as compatible
- [x] Other codecs flagged for transcoding
- [x] Reasons list populated for incompatibilities
- [x] ValidateFile() checks file accessibility
- [x] Unit tests cover all scenarios
- [x] Documentation includes codec compatibility rules

### Definition of Done
- [x] All acceptance criteria met
- [x] Unit tests pass with >80% code coverage (86.8% achieved)
- [x] Code follows Go best practices
- [x] No linter errors
- [x] Codec rules documented in comments

## Files Modified

### New Files Created
- `api/internal/media/validator.go` - Media validator implementation
- `api/internal/media/validator_test.go` - Unit tests

### Files Modified
- `docs/api-specs/media/media-api.md` - Added validator documentation

## Notes

- H.264 is also known as AVC, MPEG-4 Part 10
- AAC is Advanced Audio Coding
- Most browsers support H.264/AAC natively for HLS streaming
- Other codecs require transcoding which is CPU/GPU intensive
- File validation should be quick (just os.Stat check)
- This is used to determine if transcoding is needed before streaming

