# [2-2] Create Filename Parser

[Back to task list](./tasks.md)

## Description

Implement a filename parser that extracts show name, season number, and episode number from common video file naming patterns. This enables automatic organization of media into shows and episodes without manual metadata entry.

The parser will support multiple common patterns used by media managers and downloaders, handling variations in separators, formats, and directory structures.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-27 00:35:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-27 00:40:00 | Status Change | Proposed | Agreed | Task approved for implementation | User |
| 2025-10-27 00:41:00 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2025-10-27 01:15:00 | Status Change | InProgress | Review | Implementation completed, tests passing | AI_Agent |
| 2025-10-27 01:30:00 | Status Change | Review | Done | Task approved and completed | User |

## Requirements

### Functional Requirements
- Parse show name from filename
- Extract season number (S01, Season 1, etc.)
- Extract episode number (E01, Episode 01, etc.)
- Support common separator variations (spaces, dots, dashes)
- Handle directory-based organization (Show Name/Season 1/Episode.mp4)
- Generate clean title for display
- Return nil for fields that can't be determined
- Case-insensitive matching

### Supported Patterns
1. `Show Name - S01E01 - Episode Title.mp4`
2. `Show.Name.S01E01.Episode.Title.mp4`
3. `Show Name S01E01.mp4`
4. `Show Name/Season 1/01 - Episode Title.mp4`
5. `Show Name/Season 1/Episode 01.mp4`
6. `Show.Name.1x01.Episode.Title.mp4` (alternate format)

### Technical Requirements
- Use regular expressions for pattern matching
- Return structured ParseResult with show, season, episode
- Generate display title (show name + S00E00 format)
- Handle edge cases (no match, malformed patterns)
- Zero dependencies (standard library only)
- Well-documented with examples

## Implementation Plan

### Step 1: Define Data Structures
```go
type ParseResult struct {
    ShowName    *string // Extracted show name
    Season      *int    // Season number
    Episode     *int    // Episode number  
    Title       string  // Generated display title
    RawFilename string  // Original filename for reference
}
```

### Step 2: Implement Pattern Matchers
Create regex patterns for each supported format:
- Pattern 1: `(.+?)\s*-\s*[Ss](\d+)[Ee](\d+)`
- Pattern 2: `(.+?)[. ]S(\d+)E(\d+)`
- Pattern 3: `(.+?)[. ](\d+)x(\d+)`
- Directory pattern: Extract show from parent, season from folder name, episode from filename

### Step 3: Implement ParseFilename Function
- Try each pattern in order
- Extract matches using regex groups
- Clean up show name (replace dots/underscores with spaces, trim)
- Parse season/episode as integers
- Generate title string

### Step 4: Implement Title Generation
- If show name and episode info available: "Show Name - S01E01"
- If only show name: "Show Name"
- If nothing found: use base filename without extension

### Step 5: Helper Functions
- `cleanShowName()` - normalize show names
- `extractSeasonFromDirectory()` - parse "Season 1" from path
- `parseEpisodeNumber()` - handle various episode number formats

### Step 6: Unit Tests
- Test each supported pattern
- Test edge cases (no match, partial match)
- Test show name cleaning
- Test directory-based parsing
- Test title generation

## Test Plan

### Objective
Verify filename parser correctly extracts show/season/episode information from various common patterns.

### Test Scope
- Pattern matching for all supported formats
- Show name normalization
- Season/episode number extraction
- Title generation
- Edge case handling

### Key Test Scenarios

1. **Standard Pattern** - `Friends.S01E05.mp4`
   - Show: "Friends", Season: 1, Episode: 5
   - Title: "Friends - S01E05"

2. **With Hyphens** - `Breaking Bad - S02E03 - Episode Name.mkv`
   - Show: "Breaking Bad", Season: 2, Episode: 3
   - Title: "Breaking Bad - S02E03"

3. **Directory Structure** - `The Office/Season 3/12 - Episode.mp4`
   - Show: "The Office", Season: 3, Episode: 12
   - Title: "The Office - S03E12"

4. **Alternative Format** - `Game.of.Thrones.1x07.mp4`
   - Show: "Game of Thrones", Season: 1, Episode: 7
   - Title: "Game of Thrones - S01E07"

5. **No Pattern Match** - `random_video.mp4`
   - Show: nil, Season: nil, Episode: nil
   - Title: "random_video"

6. **Partial Match** - `Documentary.mp4`
   - Show: nil or "Documentary", Season: nil, Episode: nil
   - Title: "Documentary"

7. **Edge Cases**
   - Empty string
   - Just extension
   - Special characters
   - Multiple dots

### Success Criteria
- All patterns correctly recognized
- Show names properly cleaned
- Season/episode numbers accurately extracted
- Title generation works for all scenarios
- No false positives on non-TV content

## Verification

### Acceptance Criteria
- [ ] Parser package created in `internal/media/parser.go`
- [ ] ParseResult structure defined
- [ ] ParseFilename() function implemented
- [ ] Supports all 6 common patterns
- [ ] Show name cleaning/normalization works
- [ ] Season and episode extraction accurate
- [ ] Title generation produces clean output
- [ ] Returns appropriate nil values when data not available
- [ ] Unit tests cover all patterns and edge cases
- [ ] Documentation includes usage examples

### Definition of Done
- All acceptance criteria met
- Unit tests pass with >90% code coverage
- Code follows Go best practices
- No linter errors
- Examples documented in code comments

## Files Modified

### New Files Created
- `api/internal/media/parser.go` - Filename parser implementation
- `api/internal/media/parser_test.go` - Unit tests

### Files Modified
- None (new package)

## Notes

- Parser should be lenient - better to not match than to extract wrong data
- Show names often use dots or underscores as space replacements
- Season/episode padding (S01 vs S1) should be normalized in title
- Some files may only have episode number in filename if show is in directory
- Consider supporting multi-episode files (S01E01-E02) in future

