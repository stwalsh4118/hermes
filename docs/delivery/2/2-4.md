# [2-4] Build Async Media Scanner

[Back to task list](./tasks.md)

## Description

Implement an asynchronous media scanner that recursively scans a directory for video files, extracts metadata using FFprobe, parses filenames for organization, validates files, and stores results in the database. The scanner runs in the background with progress tracking accessible via API.

This is a core component that ties together FFprobe, filename parser, validator, and database operations to populate the media library.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-27 00:50:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Recursively scan directory for video files
- Support formats: MP4, MKV, AVI, MOV
- Extract metadata using FFprobe for each file
- Parse filename for show/season/episode
- Validate codec compatibility
- Store/update media in database
- Track progress (files processed, total files, errors)
- Run asynchronously in background
- Handle scan cancellation
- Skip non-video files
- Handle errors gracefully (corrupted files, permission issues)
- Prevent multiple concurrent scans

### Technical Requirements
- Use goroutines for async execution
- Context support for cancellation
- Thread-safe progress tracking (sync.RWMutex)
- Generate unique scan ID (UUID)
- Store scan state in memory (map of active scans)
- Use filepath.Walk for directory traversal
- Integrate FFprobe, parser, validator packages
- Use Media repository for database operations
- Structured logging with zerolog

### Progress Tracking
- Total files found
- Files processed
- Files succeeded
- Files failed
- Current file being processed
- Status (running, completed, cancelled, failed)
- Start time
- End time
- Error messages

## Implementation Plan

### Step 1: Define Data Structures
```go
type ScanStatus string
const (
    ScanStatusRunning   ScanStatus = "running"
    ScanStatusCompleted ScanStatus = "completed"
    ScanStatusCancelled ScanStatus = "cancelled"
    ScanStatusFailed    ScanStatus = "failed"
)

type ScanProgress struct {
    ScanID          string
    Status          ScanStatus
    TotalFiles      int
    ProcessedFiles  int
    SuccessCount    int
    FailedCount     int
    CurrentFile     string
    StartTime       time.Time
    EndTime         *time.Time
    Errors          []string
    mu              sync.RWMutex
}

type Scanner struct {
    db            *db.DB
    activeScans   map[string]*ScanProgress
    mu            sync.RWMutex
}
```

### Step 2: Implement Scanner Initialization
- Create NewScanner() constructor
- Initialize activeScans map
- Store database reference

### Step 3: Implement Directory Walking
- Use filepath.Walk to traverse directory
- Filter by supported extensions (.mp4, .mkv, .avi, .mov)
- Count total files first pass
- Process each file in second pass
- Handle permission errors gracefully

### Step 4: Implement File Processing
- Call FFprobe to extract metadata
- Call parser to extract show/season/episode
- Call validator to check compatibility
- Create/update Media model
- Save to database using repository
- Update progress
- Log errors but continue processing

### Step 5: Implement Progress Tracking
- Thread-safe progress updates
- GetProgress() method to retrieve status
- Store active scans in memory map
- Clean up completed scans after retrieval

### Step 6: Implement Scan Lifecycle
- StartScan() - initiates async scan, returns scan ID
- GetScanProgress() - retrieves progress by ID
- CancelScan() - cancels running scan via context
- Cleanup - remove completed scans from memory

### Step 7: Integration
- Connect to Media repository
- Use existing FFprobe, parser, validator packages
- Proper error handling and logging

### Step 8: Unit Tests
- Test directory walking
- Test file filtering
- Test progress tracking
- Test concurrent scan prevention
- Test cancellation

## Test Plan

### Objective
Verify scanner correctly processes video files and tracks progress.

### Test Scope
- Directory traversal and file filtering
- FFprobe integration
- Parser integration
- Validator integration
- Database operations
- Progress tracking
- Async execution
- Error handling

### Key Test Scenarios

1. **Successful Scan**
   - Given: Directory with valid video files
   - When: StartScan() called
   - Then: All files processed, metadata stored, progress=100%

2. **Mixed Files**
   - Given: Directory with videos and non-videos
   - When: StartScan() called
   - Then: Only video files processed, others skipped

3. **Corrupted File Handling**
   - Given: Directory with corrupted video file
   - When: StartScan() called
   - Then: Error logged, scan continues, failed count incremented

4. **Progress Tracking**
   - Given: Scan in progress
   - When: GetScanProgress() called
   - Then: Returns current progress with accurate counts

5. **Scan Cancellation**
   - Given: Long-running scan
   - When: CancelScan() called
   - Then: Scan stops, status=cancelled

6. **Concurrent Scan Prevention**
   - Given: Scan already running
   - When: StartScan() called again
   - Then: Returns error or queues scan

7. **Database Updates**
   - Given: File already in database
   - When: File scanned again
   - Then: Database record updated, not duplicated

### Success Criteria
- All video files found and processed
- Progress accurately tracked
- Errors don't stop entire scan
- Database correctly populated
- Async operation doesn't block
- Memory cleaned up after completion

## Verification

### Acceptance Criteria
- [ ] Scanner package created in `internal/media/scanner.go`
- [ ] Data structures defined (ScanProgress, Scanner)
- [ ] StartScan() initiates async scan
- [ ] GetScanProgress() returns accurate progress
- [ ] Integrates FFprobe, parser, validator
- [ ] Saves media to database
- [ ] Handles errors gracefully
- [ ] Thread-safe progress tracking
- [ ] Context support for cancellation
- [ ] Supports MP4, MKV, AVI, MOV
- [ ] Unit tests cover key scenarios
- [ ] Integration tests with real files

### Definition of Done
- All acceptance criteria met
- Unit tests pass
- Integration tests pass
- Code follows Go best practices
- No linter errors
- No race conditions (verified with -race flag)

## Files Modified

### New Files Created
- `api/internal/media/scanner.go` - Media scanner implementation
- `api/internal/media/scanner_test.go` - Unit tests

### Files Modified
- None (new package)

## Notes

- Scanner should be singleton or have scan mutex to prevent concurrent scans
- Consider adding scan queue for multiple scan requests
- Progress should be retrievable even after scan completes (for a period)
- Large directories (10,000+ files) should work but may take time
- Consider adding batch database inserts for performance (future optimization)
- Scan ID should be returned immediately so caller can track progress
- Use database transactions for batch operations
- Check for duplicate files by file_path (unique constraint)

