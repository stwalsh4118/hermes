# [4-3] Implement Timeline Service

[Back to task list](./tasks.md)

## Description

Create a service layer that integrates the timeline calculator with the repository layer. This service fetches channel and playlist data from the database, calls the calculator, handles errors, and returns formatted results. It follows the same pattern as ChannelService and PlaylistService.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-30 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-10-30 00:22:00 | Status Change | Proposed | Agreed | Task approved | User |
| 2025-10-30 00:23:00 | Status Change | Agreed | InProgress | Starting service layer implementation | AI_Agent |
| 2025-10-30 13:23:00 | Status Change | InProgress | Review | Service implementation complete with all tests passing and quality checks met | AI_Agent |
| 2025-10-30 13:30:00 | Status Change | Review | Done | Task approved and ready for commit | User |

## Requirements

### Functional Requirements
- Fetch channel by ID with error handling
- Fetch channel's playlist with media details
- Call timeline calculator with fetched data
- Handle calculator errors and edge cases
- Log operations with structured logging
- Return TimelinePosition or appropriate error

### Business Logic
- Verify channel exists before calculation
- Ensure playlist includes media metadata (duration)
- Map calculator results to API response format
- Provide meaningful error messages

### Technical Requirements
- Create `TimelineService` struct with repository dependencies
- Constructor function `NewTimelineService(repos *db.Repositories)`
- Main method: `GetCurrentPosition(ctx, channelID) (*TimelinePosition, error)`
- Integration with calculator from Task 4-2
- Proper error handling and logging
- Context support for cancellation

### Error Handling
- Channel not found -> ErrChannelNotFound
- Empty playlist -> ErrEmptyPlaylist
- Not started -> ErrChannelNotStarted
- Finished (non-loop) -> ErrPlaylistFinished
- Repository errors -> wrapped errors

## Implementation Plan

### Step 1: Create service structure
- Create `api/internal/timeline/service.go`
- Define `TimelineService` struct
- Add constructor `NewTimelineService`

### Step 2: Create custom error types
- Create `api/internal/timeline/errors.go`
- Define ErrChannelNotStarted
- Define ErrEmptyPlaylist  
- Define ErrPlaylistFinished
- Follow pattern from channel/errors.go

### Step 3: Implement GetCurrentPosition
- Accept context and channel ID
- Fetch channel from repository
- Fetch playlist with media (GetWithMedia)
- Validate playlist not empty
- Call calculator with current time
- Handle calculator errors
- Return TimelinePosition

### Step 4: Add logging
- Log at appropriate levels (debug, info, warn, error)
- Include channel_id in all logs
- Log calculation start and completion
- Log any errors with context

### Step 5: Unit tests
- Mock repositories
- Test successful calculation
- Test all error cases
- Test context cancellation
- Verify logging calls

## Test Plan

### Objective
Verify service correctly integrates calculator with repositories and handles all scenarios.

### Test Scope
- Repository integration
- Calculator invocation
- Error handling
- Logging

### Key Test Scenarios

1. **Successful Calculation**
   - Given: Valid channel with playlist
   - When: GetCurrentPosition called
   - Then: Returns TimelinePosition

2. **Channel Not Found**
   - Given: Non-existent channel ID
   - When: GetCurrentPosition called
   - Then: Returns ErrChannelNotFound

3. **Empty Playlist**
   - Given: Channel with no playlist items
   - When: GetCurrentPosition called
   - Then: Returns ErrEmptyPlaylist

4. **Channel Not Started**
   - Given: Channel start time in future
   - When: GetCurrentPosition called
   - Then: Returns ErrChannelNotStarted

5. **Playlist Finished**
   - Given: Non-looping channel past end
   - When: GetCurrentPosition called
   - Then: Returns ErrPlaylistFinished

6. **Repository Error**
   - Given: Database connection failure
   - When: GetCurrentPosition called
   - Then: Returns wrapped error with context

### Success Criteria
- All unit tests pass
- Service integrates cleanly with repositories
- Error handling is robust
- Logging provides good debugging context
- Follows established service patterns

## Verification

### Acceptance Criteria
- [ ] TimelineService struct created
- [ ] NewTimelineService constructor implemented
- [ ] GetCurrentPosition method implemented
- [ ] Custom error types defined
- [ ] Integrates with calculator from Task 4-2
- [ ] Fetches data from repositories correctly
- [ ] Handles all error cases appropriately
- [ ] Structured logging throughout
- [ ] Unit tests cover main scenarios
- [ ] No linter errors

### Definition of Done
- All acceptance criteria met
- Unit tests pass
- Code follows Go best practices
- Integrates cleanly with existing patterns
- Ready for API layer integration

## Files Modified

### New Files Created
- `api/internal/timeline/service.go` - Timeline service implementation
- `api/internal/timeline/errors.go` - Custom error types
- `api/internal/timeline/service_test.go` - Unit tests

### API Specifications Updated
- `docs/api-specs/timeline/timeline-api.md` - Document service interface

## Notes

- Follows same pattern as ChannelService and PlaylistService
- Service layer handles I/O, calculator handles math
- Makes calculator easily testable in isolation
- Error types should be distinguishable for API layer
- Consider caching playlist duration if called frequently
- Current time passed to calculator, not retrieved within it (testability)

