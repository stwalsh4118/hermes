# [4-4] Implement Timeline API Endpoint

[Back to task list](./tasks.md)

## Description

Implement the REST API endpoint that exposes timeline calculation functionality. This endpoint already has a placeholder at `GET /api/channels/:id/current` (returns 501 Not Implemented). Replace the placeholder with the actual implementation using the timeline service from Task 4-3.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-30 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

### Functional Requirements
- Implement `GET /api/channels/:id/current` endpoint
- Parse channel ID from URL parameter
- Call timeline service to get current position
- Return TimelinePosition as JSON
- Handle all error cases with appropriate HTTP status codes
- Follow existing API patterns from channel.go

### API Specification

**Endpoint:** `GET /api/channels/:id/current`

**Success Response (200 OK):**
```json
{
  "media_id": "uuid-here",
  "media_title": "Episode Title",
  "offset_seconds": 1234,
  "started_at": "2025-10-30T12:00:00Z",
  "ends_at": "2025-10-30T12:45:00Z",
  "duration": 2700
}
```

**Error Responses:**
- `400 Bad Request` - Invalid channel UUID
- `404 Not Found` - Channel not found
- `409 Conflict` - Channel not started, empty playlist, or finished
- `500 Internal Server Error` - Calculation failed

### Technical Requirements
- Update `api/internal/api/channel.go`
- Use existing ChannelService for channel validation
- Create and inject TimelineService
- Proper error response formatting
- HTTP status codes per REST conventions
- Request logging via middleware

## Implementation Plan

### Step 1: Update server.go to instantiate TimelineService
- Create timeline service in `server.New()`
- Pass repositories to timeline service
- Make available to API handlers

### Step 2: Update API handler setup
- Modify channel route setup to accept timeline service
- Pass service to handler function

### Step 3: Implement endpoint handler
- Replace 501 placeholder in channel.go
- Parse and validate channel ID
- Call timeline service GetCurrentPosition
- Map errors to HTTP status codes:
  - ErrChannelNotFound -> 404
  - ErrEmptyPlaylist -> 409 with message
  - ErrChannelNotStarted -> 409 with message
  - ErrPlaylistFinished -> 409 with message
  - Other errors -> 500
- Return JSON response

### Step 4: Add appropriate logging
- Log incoming requests (via middleware)
- Log calculation results
- Log any errors

### Step 5: Update API documentation
- Remove "not implemented" note
- Document actual endpoint behavior
- Include all response formats
- Document error cases

## Test Plan

### Objective
Verify API endpoint correctly exposes timeline calculation with proper error handling.

### Test Scope
- HTTP endpoint behavior
- Request/response formats
- Error status codes
- Integration with timeline service

### Key Test Scenarios

Since this is an API integration task, detailed HTTP testing will be covered in Task 4-5 (Integration Tests). For this task, focus on:
- Endpoint compiles and registers correctly
- Basic successful response format
- Error codes map correctly
- Service integration works

### Success Criteria
- Endpoint responds correctly to requests
- JSON format matches specification
- Error codes are appropriate
- Follows existing API patterns
- Documentation updated

## Verification

### Acceptance Criteria
- [ ] Placeholder implementation replaced
- [ ] Timeline service integrated with API layer
- [ ] Channel ID validation implemented
- [ ] Successful response returns TimelinePosition as JSON
- [ ] Error cases return appropriate HTTP status codes
- [ ] Error messages are clear and actionable
- [ ] Logging integrated
- [ ] API specification updated
- [ ] No linter errors

### Definition of Done
- All acceptance criteria met
- Endpoint functional and testable
- Code follows Go and REST best practices
- Documentation complete
- Ready for integration testing

## Files Modified

### Files Modified
- `api/internal/api/channel.go` - Replace placeholder with implementation
- `api/internal/server/server.go` - Instantiate and wire timeline service

### API Specifications Updated
- `docs/api-specs/timeline/timeline-api.md` - Document REST endpoint
- `docs/api-specs/channels/channels-api.md` - Update current endpoint documentation

## Notes

- Follows existing patterns from other channel endpoints
- Timeline service handles business logic, handler just does HTTP
- Error status codes follow REST conventions:
  - 409 Conflict for business logic edge cases (not started, finished)
  - 404 for resource not found
  - 400 for invalid input
  - 500 for unexpected errors
- Consider rate limiting if this becomes a high-traffic endpoint
- May be called frequently by frontend for "now playing" displays

